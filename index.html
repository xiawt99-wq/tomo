<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>夢角陪伴番茄鐘</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>

.status-gift-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-top: 12px;
}

        
        .status-gift-card {
            border: 2px solid rgba(139, 92, 246, 0.2);
            border-radius: 16px;
            padding: 16px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.6);
            position: relative;
            min-height: 100px;
            display: flex;
            flex-direction: column;
        }
        .status-gift-card:hover {
            border-color: rgba(139, 92, 246, 0.4);
            background: rgba(139, 92, 246, 0.05);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.15);
        }

        .status-gift-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

.status-gift-icon {
    font-size: 20px;
}

.status-gift-name {
    font-size: 14px;
    font-weight: 600;
    color: #374151;
}

.status-gift-preview {
    flex: 1;
    font-size: 12px;
    color: #6b7280;
    line-height: 1.4;
    margin: 4px 0;
}

.status-gift-edit-indicator {
    position: absolute;
    bottom: 8px;
    right: 8px;
    font-size: 12px;
    opacity: 0.7;
}

.custom-status-card {
    border: 2px dashed rgba(139, 92, 246, 0.4);
    background: rgba(139, 92, 246, 0.05);
    text-align: center;
    justify-content: center;
}

.custom-status-card:hover {
    background: rgba(139, 92, 246, 0.1);
    border-color: rgba(139, 92, 246, 0.6);
}

.custom-status-card .status-gift-icon {
    font-size: 24px;
    color: #8b5cf6;
}

.custom-status-delete {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 20px;
    height: 20px;
    background: rgba(239, 68, 68, 0.1);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: all 0.3s ease;
}

.status-gift-card:hover .custom-status-delete {
    opacity: 1;
}

.custom-status-delete:hover {
    background: rgba(239, 68, 68, 0.2);
    transform: scale(1.1);
}

/* 狀態禮物編輯彈窗 */
.status-gift-editor-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1100;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
}

.status-gift-editor-modal.show {
    opacity: 1;
    pointer-events: auto;
}

.status-gift-editor-content {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    padding: 24px;
    margin: 16px;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
    transform: scale(0.9);
    transition: transform 0.3s ease;
    width: 90%;
}

.status-gift-editor-modal.show .status-gift-editor-content {
    transform: scale(1);
}

.status-gift-editor-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.status-gift-editor-title {
    font-size: 18px;
    font-weight: bold;
    color: #1e293b;
    display: flex;
    align-items: center;
    gap: 8px;
}

.status-gift-editor-close {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: rgba(148, 163, 184, 0.1);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.3s ease;
}

.status-gift-editor-close:hover {
    background: rgba(148, 163, 184, 0.2);
}

.status-gift-editor-textarea {
    width: 100%;
    min-height: 200px;
    padding: 12px;
    border: 2px solid rgba(139, 92, 246, 0.2);
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.8);
    font-size: 14px;
    line-height: 1.6;
    resize: vertical;
    outline: none;
    transition: border-color 0.3s ease;
}

.status-gift-editor-textarea:focus {
    border-color: rgba(139, 92, 246, 0.5);
}

.status-gift-editor-actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 16px;
}

.status-gift-editor-btn {
    padding: 8px 20px;
    border-radius: 8px;
    border: none;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
}

.status-gift-editor-cancel {
    background: rgba(148, 163, 184, 0.2);
    color: #64748b;
}

.status-gift-editor-cancel:hover {
    background: rgba(148, 163, 184, 0.3);
}

.status-gift-editor-save {
    background: linear-gradient(135deg, #8b5cf6, #a855f7);
    color: white;
}

.status-gift-editor-save:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
}

@media (max-width: 768px) {
    .status-gift-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 8px; /* 减小間距以适應小屏幕 */
    }
}
@media (max-width: 480px) {
    .status-gift-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 6px; /* 进一步减小間距 */
    }
    
    .status-gift-card {
        padding: 12px 8px; /* 减小內邊距 */
        min-height: 80px; /* 减小最小高度 */
    }
    
    .status-gift-name {
        font-size: 12px; /* 减小字體 */
    }
    
    .status-gift-preview {
        font-size: 10px; /* 减小預覽文字 */
    }
}





        * { font-family: 'Inter','Noto Sans TC',system-ui,-apple-system,'Segoe UI','PingFang TC','Microsoft JhengHei',sans-serif; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: linear-gradient(145deg, #faf7ff 0%, #f1eeff 50%, #e8ddff 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 
                0 8px 32px rgba(139, 92, 246, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }
        
        .button-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .button-hover:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 12px 40px rgba(139, 92, 246, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }
        
        .gradient-purple {
            background: linear-gradient(135deg, #8b5cf6, #a855f7);
        }
        
        .gradient-pink {
            background: linear-gradient(135deg, #ec4899, #f472b6);
        }
        
        /* 動畫效果 */
        .floating {
            animation: floating 3s ease-in-out infinite;
        }
        
        .sparkle {
            animation: sparkle 2s ease-in-out infinite;
        }
        
        .breathe {
            animation: breathe 3s ease-in-out infinite;
        }
        
        .bounce-soft {
            animation: bounce-soft 2s ease-in-out infinite;
        }
        
        @keyframes floating {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes sparkle {
            0%, 100% { opacity: 0.4; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
        }
        
        @keyframes breathe {
            0%, 100% { opacity: 0.8; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.02); }
        }
        
        @keyframes bounce-soft {
            0%, 100% { transform: translateY(0px) scale(1); }
            50% { transform: translateY(-3px) scale(1.02); }
        }
        
        /* 肉墊特效 */
        .paw-button {
            position: relative;
            overflow: hidden;
        }
        
        .paw-button::before {
            content: '👑';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 10;
        }
        
        .paw-button:hover::before {
            opacity: 0.8;
            animation: paw-bounce 0.6s ease;
        }
        
        @keyframes paw-bounce {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.3); }
        }
        
        /* 專注頁面特定樣式 */
        .mode-active {
            background: linear-gradient(135deg, #8b5cf6, #ec4899);
            color: white;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }
        
        .heartbeat-pulse {
            animation: heartbeat-pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes heartbeat-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        /* 狀態圖标動畫 */
        .status-work {
            animation: work-bounce 1.5s ease-in-out infinite;
        }
        
        .status-study {
            animation: study-wiggle 2s ease-in-out infinite;
        }
        
        .status-rest {
            animation: rest-rotate 3s ease-in-out infinite;
        }
        
        @keyframes work-bounce {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-3px); }
        }
        
        @keyframes study-wiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }
        
        /* 優化後的心跳線條樣式 */
        .heartbeat-line-left, .heartbeat-line-right {
            width: 80px;
            height: 50px;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        
        .heartbeat-line-left svg, .heartbeat-line-right svg {
            width: 100%;
            height: 100%;
        }
        
        .heartbeat-path-left {
            stroke: #ec4899;
            stroke-width: 2;
            fill: none;
            stroke-dasharray: 150;
            stroke-dashoffset: 150;
            animation: heartbeat-draw-left 4s ease-in-out infinite;
        }
        
        .heartbeat-path-right {
            stroke: #ec4899;
            stroke-width: 2;
            fill: none;
            stroke-dasharray: 150;
            stroke-dashoffset: 150;
            animation: heartbeat-draw-right 4s ease-in-out infinite;
        }
        
        /* 静止狀態的心跳線條 */
        .heartbeat-path-left.static,
        .heartbeat-path-right.static {
            animation: none;
            stroke-dashoffset: 150;
            opacity: 0.3;
        }
        
        /* 左邊心跳線條：0-50%時間段跳動 */
        @keyframes heartbeat-draw-left {
            0% { stroke-dashoffset: 150; opacity: 0.3; }
            10% { stroke-dashoffset: 0; opacity: 1; }
            25% { stroke-dashoffset: -150; opacity: 0.8; }
            50% { stroke-dashoffset: -300; opacity: 0.3; }
            51%, 100% { stroke-dashoffset: 150; opacity: 0.3; }
        }
        
        /* 右邊心跳線條：30-100%時間段跳動 */
        @keyframes heartbeat-draw-right {
            0%, 30% { stroke-dashoffset: 150; opacity: 0.3; }
            40% { stroke-dashoffset: 0; opacity: 1; }
            65% { stroke-dashoffset: -150; opacity: 0.8; }
            100% { stroke-dashoffset: -300; opacity: 0.3; }
        }
        
        /* OC語区域樣式 - 调整位置更靠近OC狀態 */
        .oc-message-area {
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 20px;
            position: relative;
            margin-top: -10px; /* 向上移動靠近OC狀態 */
        }
        
        .oc-message-text {
            color: #6b46c1;
            font-size: 15px;
            font-weight: 500;
            text-align: center;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
            transition: all 0.4s ease;
            opacity: 1;
            transform: translateY(0);
        }
        
        /* 優化：只讓純文字部分居中 */
        .oc-message-text-wrapper {
            display: inline-block;
            position: relative;
        }
        
        .oc-status-text-wrapper {
            display: inline-block;
            position: relative;
        }
        
        .oc-message-text.encourage {
            color: #6b46c1;
        }
        
        .oc-message-text.rest {
            color: #059669;
        }
        
        .oc-message-text.remind-normal {
            color: #3b82f6;
        }
        
        .oc-message-text.remind-annoyed {
            color: #f97316;
        }
        
        .oc-message-text.remind-angry {
            color: #dc2626;
            font-weight: 600;
        }
        
        /* 新增：不理你了狀態 */
        .oc-message-text.ignore {
            color: #dc2626;
            font-weight: 600;
        }
        
        .oc-message-text.fade-out {
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
        }
        
        .oc-message-text.slide-up {
            animation: slide-up-fast 0.3s ease-in-out;
        }
        
        @keyframes slide-up-fast {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-30px); }
        }
        
        /* 响應式OC頭像大小 - 增强呼吸動畫 */
        .oc-avatar {
            width: 70vw;
            height: 70vw;
            max-width: 16rem;
            max-height: 16rem;
            min-width: 8rem;
            min-height: 8rem;
            aspect-ratio: 1 / 1;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
            position: relative;
            z-index: 2;
            border: 3px solid rgba(255, 255, 255, 0.8);
            box-shadow: 
                0 0 0 2px rgba(236, 72, 153, 0.15),
                0 0 20px rgba(236, 72, 153, 0.2),
                0 0 40px rgba(236, 72, 153, 0.1),
                inset 0 0 0 1px rgba(255, 255, 255, 0.5);
            animation: avatar-glow-breathe 3s ease-in-out infinite;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .oc-avatar:hover {
            transform: scale(1.02);
        }
        
        .oc-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        /* 增强OC頭像呼吸發光動畫 */
        @keyframes avatar-glow-breathe {
            0%, 100% { 
                box-shadow: 
                    0 0 0 2px rgba(236, 72, 153, 0.15),
                    0 0 20px rgba(236, 72, 153, 0.2),
                    0 0 40px rgba(236, 72, 153, 0.1),
                    inset 0 0 0 1px rgba(255, 255, 255, 0.5);
                transform: scale(1);
            }
            50% { 
                box-shadow: 
                    0 0 0 3px rgba(236, 72, 153, 0.25),
                    0 0 30px rgba(236, 72, 153, 0.3),
                    0 0 60px rgba(236, 72, 153, 0.15),
                    inset 0 0 0 1px rgba(255, 255, 255, 0.7);
                transform: scale(1.05);
            }
        }
        
        .timer-text {
            font-size: clamp(2.5rem, 8vw, 4rem);
            cursor: pointer;
            user-select: none;
        }
        
        .focus-container {
            padding: 6px 1rem 1rem 1rem;
        }
        
        .focus-section {
            padding: clamp(1rem, 4vw, 1.5rem);
        }
        
        /* 狀態選擇樣式 - 優化响應速度 */
        .status-selector {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 16px;
            margin-top: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s ease;
            z-index: 50;
            min-width: 280px;
        }
        
        .status-selector.show {
            opacity: 1;
            pointer-events: auto;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .status-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 8px;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.15s ease;
            min-height: 60px;
            justify-content: center;
        }
        
        .status-option:hover {
            background: rgba(139, 92, 246, 0.1);
        }
        
        .status-option.active {
            background: rgba(139, 92, 246, 0.2);
        }
        
        .status-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }
        
        .status-text {
            font-size: 12px;
            text-align: center;
            color: #374151;
            font-weight: 500;
        }
        
        /* 自定義狀態输入框樣式 */
        #customStatusInput {
            border-top: 1px solid rgba(139, 92, 246, 0.2);
            padding-top: 12px;
            margin-top: 8px;
        }
        
        #customStatusInput input {
            font-size: 14px;
        }
        
        #customStatusInput button {
            font-size: 12px;
            padding: 6px 12px;
        }
        
        /* 時間選擇器樣式 */
        .time-selector {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 16px;
            margin-top: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 60;
            min-width: 200px;
        }
        
        .time-selector.show {
            opacity: 1;
            pointer-events: auto;
        }
        
        .time-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin: 4px 0;
        }
        
        .time-option:hover {
            background: rgba(139, 92, 246, 0.1);
        }
        
        .time-option.active {
            background: rgba(139, 92, 246, 0.2);
        }
        
        .custom-time-input {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            border-radius: 12px;
            background: rgba(139, 92, 246, 0.05);
            margin: 8px 0;
        }
        
        .task-option {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin: 4px 0;
        }
        
        .task-option:hover {
            background: rgba(139, 92, 246, 0.1);
        }
        
        .task-option.active {
            background: rgba(139, 92, 246, 0.2);
        }
        
        /* 任務相關樣式 - 移除拖拽功能 */
        .task-item {
            background: rgba(255, 255, 255, 0.6);
            border-radius: 12px;
            padding: 12px;
            border-left: 4px solid;
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .task-item.completed {
            background: rgba(148, 163, 184, 0.3);
            color: #64748b;
            order: 999;
            border-left-color: #64748b;
        }
        
        .task-item.completed .task-title {
            text-decoration: line-through;
            opacity: 0.6;
        }
        
        .task-item.pending, .task-item.in-progress {
            border-left-color: #3b82f6;
        }
        
        .task-checkbox {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        
        .task-checkbox.pending, .task-checkbox.in-progress {
            border-color: #3b82f6;
            background: transparent;
        }
        
        .task-checkbox.in-progress {
            animation: sparkle 2s ease-in-out infinite;
        }
        
        .task-checkbox.completed {
            border-color: #64748b;
            background: #64748b;
        }
        
        .task-checkbox:hover {
            transform: scale(1.1);
        }
        
        .task-title {
            font-weight: 500;
            color: #1e293b;
            flex: 1;
            margin: 0 8px;
        }
        
        .task-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .task-item:hover .task-actions {
            opacity: 1;
        }
        
        .task-action-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .task-edit-btn {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }
        
        .task-edit-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: scale(1.1);
        }
        
        .task-delete-btn {
            background: rgba(148, 163, 184, 0.1);
            color: #64748b;
        }
        
        .task-delete-btn:hover {
            background: rgba(148, 163, 184, 0.2);
            color: #475569;
            transform: scale(1.1);
        }
        
        /* 添加任務输入框 */
        .add-task-input {
            background: rgba(255, 255, 255, 0.8);
            border: 2px dashed rgba(139, 92, 246, 0.4);
            border-radius: 12px;
            padding: 12px;
            width: 100%;
            outline: none;
            font-size: 14px;
            color: #1e293b;
            transition: all 0.3s ease;
        }
        
        .add-task-input:focus {
            border-color: rgba(139, 92, 246, 0.8);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .add-task-input::placeholder {
            color: #94a3b8;
        }
        
        /* 飘落動畫 */
        .falling-petals {
            position: fixed;
            top: -10px;
            pointer-events: none;
            z-index: 5;
            font-size: 20px;
            animation: fall linear infinite;
        }
        
        @keyframes fall {
            0% {
                transform: translateY(-10px) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(calc(100vh + 10px)) rotate(360deg);
                opacity: 0;
            }
        }
        
        /* 開始按鈕提示文字樣式 */
        #startBtnHint {
            animation: pulse-hint 2s ease-in-out infinite;
        }
        
        @keyframes pulse-hint {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }
        
        /* 三按鈕布局 */
        .three-button-layout {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 20px;
            margin-top: 20px;
        }
        
        .side-button {
            background: rgba(148, 163, 184, 0.3);
            color: #64748b;
            border-radius: 16px;
            padding: 16px;
            transition: all 0.3s ease;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .side-button:hover {
            background: rgba(148, 163, 184, 0.5);
            transform: translateY(-2px);
        }
        
        .main-button {
            border-radius: 20px;
            padding: 16px 20px;
            width: 80px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* 震動效果 */
        .vibration {
            animation: vibrate 0.5s ease-in-out;
        }
        
        @keyframes vibrate {
            0%, 100% { transform: translateX(0); }
            10% { transform: translateX(-3px); }
            20% { transform: translateX(3px); }
            30% { transform: translateX(-3px); }
            40% { transform: translateX(3px); }
            50% { transform: translateX(-3px); }
            60% { transform: translateX(3px); }
            70% { transform: translateX(-3px); }
            80% { transform: translateX(3px); }
            90% { transform: translateX(-3px); }
        }
        
        /* 憤怒震動效果 */
        .angry-shake {
            animation: angry-shake 0.6s ease-in-out;
        }
        
        @keyframes angry-shake {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            10% { transform: translateX(-6px) rotate(-2deg); }
            20% { transform: translateX(6px) rotate(2deg); }
            30% { transform: translateX(-6px) rotate(-2deg); }
            40% { transform: translateX(6px) rotate(2deg); }
            50% { transform: translateX(-6px) rotate(-2deg); }
            60% { transform: translateX(6px) rotate(2deg); }
            70% { transform: translateX(-6px) rotate(-2deg); }
            80% { transform: translateX(6px) rotate(2deg); }
            90% { transform: translateX(-6px) rotate(-2deg); }
        }
        
        /* 完成慶祝動畫 */
        .celebration {
            animation: celebration 1s ease-in-out;
        }
        
        @keyframes celebration {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.1) rotate(-5deg); }
            50% { transform: scale(1.15) rotate(0deg); }
            75% { transform: scale(1.1) rotate(5deg); }
        }
        
        /* 完成彈窗樣式 */
        .completion-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .completion-modal.show {
            opacity: 1;
            pointer-events: auto;
        }
        
        .completion-modal-content {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            border-radius: 20px;
            padding: 32px 24px;
            margin: 16px;
            max-width: 400px;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s ease;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .completion-modal.show .completion-modal-content {
            transform: scale(1);
        }
        
        .completion-title {
            font-size: 24px;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 12px;
        }
        
        .completion-gift {
            font-size: 18px;
            color: #6b46c1;
            margin-bottom: 24px;
            line-height: 1.5;
        }
        
        .completion-close-btn {
            background: linear-gradient(135deg, #8b5cf6, #a855f7);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .completion-close-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.3);
        }
        
        /* 完成特效 - 星星鑽石飄落 */
        .celebration-particle {
            position: fixed;
            font-size: 24px;
            pointer-events: none;
            z-index: 999;
            animation: celebration-fall 4s ease-in-out forwards;
        }
        
        @keyframes celebration-fall {
            0% {
                transform: translateY(-100px) rotate(0deg) scale(1);
                opacity: 1;
            }
            50% {
                transform: translateY(50vh) rotate(180deg) scale(1.2);
                opacity: 0.8;
            }
            100% {
                transform: translateY(100vh) rotate(360deg) scale(0.8);
                opacity: 0;
            }
        }
        
        /* 禮物彈窗樣式 */
        .gift-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .gift-modal.show {
            opacity: 1;
            pointer-events: auto;
        }
        
        .gift-modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 24px;
            margin: 16px;
            max-width: 90vw;
            max-height: 70vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .gift-modal.show .gift-modal-content {
            transform: scale(1);
        }
        
        .gift-item {
            display: flex;
            align-items: flex-start;
            padding: 12px;
            background: rgba(139, 92, 246, 0.05);
            border-radius: 12px;
            margin-bottom: 8px;
            border-left: 4px solid #8b5cf6;
        }
        
        .gift-item:last-child {
            margin-bottom: 0;
        }
        
        .gift-time {
            font-size: 12px;
            color: #6b7280;
            margin-left: auto;
            white-space: nowrap;
        }
        
        .gift-sender {
            font-size: 12px;
            color: #8b5cf6;
            font-weight: 500;
        }
        
        /* OC卡片頁面樣式 */
        .oc-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 16px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .oc-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(139, 92, 246, 0.15);
        }
        
        .oc-card-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid rgba(139, 92, 246, 0.3);
        }
        
        .create-card {
            border: 2px dashed rgba(139, 92, 246, 0.4);
            background: rgba(139, 92, 246, 0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 120px;
            text-align: center;
        }
        
        .create-card:hover {
            background: rgba(139, 92, 246, 0.1);
            border-color: rgba(139, 92, 246, 0.6);
        }
        
        /* OC設置頁面樣式 */
        .setting-section {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
        }
        
        .avatar-upload {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px dashed rgba(139, 92, 246, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(139, 92, 246, 0.05);
            position: relative;
            overflow: hidden;
        }
        
        .avatar-upload:hover {
            border-color: rgba(139, 92, 246, 0.6);
            background: rgba(139, 92, 246, 0.1);
        }
        
        .avatar-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        /* 風格選擇網格 */
        .style-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 12px;
        }
        
        .style-option {
            border: 2px solid rgba(139, 92, 246, 0.2);
            border-radius: 12px;
            padding: 12px 12px 40px 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.5);
            position: relative;
        }
        
        .style-option:hover {
            border-color: rgba(139, 92, 246, 0.4);
            background: rgba(139, 92, 246, 0.05);
            transform: translateY(-2px);
        }
        
        .style-option.selected .style-selector-circle {
            background: #8b5cf6;
            border-color: #8b5cf6;
        }
        
        .style-option.selected .style-selector-circle::after {
            content: '✓';
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .style-title {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }
        
        .style-desc {
            font-size: 10px;
            color: #6b7280;
            line-height: 1.3;
        }
        
        /* 新增：風格選擇圓圈 */
        .style-selector-circle {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid rgba(139, 92, 246, 0.4);
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .style-selector-circle:hover {
            border-color: rgba(139, 92, 246, 0.6);
            transform: translateX(-50%) scale(1.1);
        }
        
        /* 語句編輯彈窗 */
        .style-editor-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .style-editor-modal.show {
            opacity: 1;
            pointer-events: auto;
        }
        
        .style-editor-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 24px;
            margin: 16px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
            width: 90%;
        }
        
        .style-editor-modal.show .style-editor-content {
            transform: scale(1);
        }
        
        .style-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .style-editor-title {
            font-size: 18px;
            font-weight: bold;
            color: #1e293b;
        }
        
        .style-editor-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(148, 163, 184, 0.1);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }
        
        .style-editor-close:hover {
            background: rgba(148, 163, 184, 0.2);
        }
        
        .style-editor-textarea {
            width: 100%;
            min-height: 300px;
            padding: 12px;
            border: 2px solid rgba(139, 92, 246, 0.2);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            outline: none;
            transition: border-color 0.3s ease;
        }
        
        .style-editor-textarea:focus {
            border-color: rgba(139, 92, 246, 0.5);
        }
        
        .style-editor-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 16px;
        }
        
        .style-editor-btn {
            padding: 8px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .style-editor-cancel {
            background: rgba(148, 163, 184, 0.2);
            color: #64748b;
        }
        
        .style-editor-cancel:hover {
            background: rgba(148, 163, 184, 0.3);
        }
        
        .style-editor-save {
            background: linear-gradient(135deg, #8b5cf6, #a855f7);
            color: white;
        }
        
        .style-editor-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }
        
        /* 自定义風格卡片 */
        .custom-style-card {
            border: 2px dashed rgba(139, 92, 246, 0.4);
            background: rgba(139, 92, 246, 0.05);
        }
        
        .custom-style-card:hover {
            background: rgba(139, 92, 246, 0.1);
            border-color: rgba(139, 92, 246, 0.6);
        }
        
        /* 已完成任務彈窗樣式 */
        .completed-tasks-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .completed-tasks-modal.show {
            opacity: 1;
            pointer-events: auto;
        }
        
        .completed-tasks-modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 24px;
            margin: 16px;
            max-width: 90vw;
            max-height: 70vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .completed-tasks-modal.show .completed-tasks-modal-content {
            transform: scale(1);
        }
        
        .completed-task-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: rgba(148, 163, 184, 0.1);
            border-radius: 12px;
            margin-bottom: 8px;
            border-left: 4px solid #64748b;
        }
        
        .completed-task-item:last-child {
            margin-bottom: 0;
        }
        
        .completed-task-title {
            font-weight: 500;
            color: #64748b;
            flex: 1;
            margin: 0 8px;
            text-decoration: line-through;
        }
        
        .undo-btn {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            border: none;
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .undo-btn:hover {
            background: rgba(59, 130, 246, 0.2);
        }
        
        /* 統計數據點擊效果 */
        .stat-clickable {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .stat-clickable:hover {
            transform: translateY(-2px);
            background: rgba(139, 92, 246, 0.1);
            border-radius: 12px;
        }
        
        /* 响應式設計 */
        @media (max-height: 700px) {
            .focus-container { padding: 6px 0.75rem 0.75rem 0.75rem; }
            .oc-avatar { width: 65vw; height: 65vw; max-width: 12rem; max-height: 12rem; }
            .three-button-layout { margin-bottom: 15px; margin-top: 15px; }
        }
        
        @media (max-height: 600px) {
            .oc-avatar { width: 60vw; height: 60vw; max-width: 10rem; max-height: 10rem; }
            .focus-section { padding: 1rem; }
            .three-button-layout { margin-bottom: 10px; margin-top: 10px; }
        }
        
        @media (min-height: 800px) {
            .oc-avatar { width: 70vw; height: 70vw; max-width: 18rem; max-height: 18rem; }
            .three-button-layout { margin-bottom: 25px; margin-top: 25px; }
        }
        
        @media (max-width: 360px) {
            .oc-avatar { width: 65vw; height: 65vw; min-width: 7rem; min-height: 7rem; }
            .focus-container { padding: 6px 0.5rem 0.5rem 0.5rem; }
            .status-selector { min-width: 250px; }
            .status-grid { grid-template-columns: repeat(2, 1fr); }
            .style-grid { grid-template-columns: repeat(2, 1fr); }
        }
        
        @media (max-width: 320px) {
            .status-selector { min-width: 220px; }
            .status-grid { grid-template-columns: repeat(2, 1fr); }
            .style-grid { grid-template-columns: repeat(2, 1fr); }
        }
        
        /* 頁面切換動畫 */
        .page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(145deg, #faf7ff 0%, #f1eeff 50%, #e8ddff 100%);
            transition: transform 0.3s ease-in-out;
            z-index: 10;
            overflow-y: auto;
        }
        
        .page.hidden {
            transform: translateX(100%);
        }
        
        .page.show {
            transform: translateX(0);
        }
        
        /* 滾動條樣式 */
        ::-webkit-scrollbar {
            width: 4px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(139, 92, 246, 0.3);
            border-radius: 2px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(139, 92, 246, 0.5);
        }
        
        /* 移動端優化 */
        @media (max-width: 768px) {
            .task-actions {
                opacity: 1;
            }
            
            .gift-modal-content {
                margin: 8px;
                padding: 16px;
            }
        }
        
        /* 新增：自定义風格刪除按鈕 */
        .custom-style-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            background: rgba(239, 68, 68, 0.1);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .style-option:hover .custom-style-delete {
            opacity: 1;
        }
        
        .custom-style-delete:hover {
            background: rgba(239, 68, 68, 0.2);
            transform: scale(1.1);
        }
    </style>
<style id="dark-override">
/* === Dark Theme Override (injected) === */
:root {
  color-scheme: dark;
}
body {
  background: radial-gradient(1200px 600px at 80% -10%, #111827 0%, #0b1020 60%), #0a0f1a !important;
  color: #e5e7eb !important;
}
.page {
  background: linear-gradient(145deg, #0f172a 0%, #0b1222 50%, #0a0f1a 100%) !important;
}
.glass-card, .status-gift-card, .oc-card, .setting-section, .completion-modal-content,
.gift-modal-content, .status-gift-editor-content, .style-editor-content, .completed-tasks-modal-content {
  background: rgba(17, 24, 39, 0.75) !important;
  border-color: rgba(255, 255, 255, 0.08) !important;
  box-shadow: 0 8px 32px rgba(0,0,0,0.35) !important;
}
.status-gift-card:hover, .oc-card:hover, .style-option:hover {
  background: rgba(30, 41, 59, 0.85) !important;
}
.create-card {
  background: rgba(30, 41, 59, 0.5) !important;
  border-color: rgba(139, 92, 246, 0.35) !important;
}
.style-option {
  background: rgba(17, 24, 39, 0.55) !important;
}
.add-task-input, .style-editor-textarea, .status-gift-editor-textarea,
#customGreeting, #ocNameInput, #userTitleInput {
  background: rgba(15, 23, 42, 0.7) !important;
  color: #e5e7eb !important;
  border-color: rgba(255,255,255,0.12) !important;
}
.text-slate-800, .text-slate-700, .text-slate-600, .text-slate-500,
.text-purple-600, .text-purple-500, .text-slate-900 {
  color: #e5e7eb !important;
}
.bg-slate-200, .bg-slate-300, .bg-slate-400 {
  background-color: rgba(148, 163, 184, 0.2) !important;
}
.status-text { color: #cbd5e1 !important; }
.task-item { background: rgba(30, 41, 59, 0.6) !important; }
.task-item.completed { background: rgba(71, 85, 105, 0.4) !important; color: #94a3b8 !important; }
::-webkit-scrollbar-track { background: rgba(255,255,255,0.05) !important; }
::-webkit-scrollbar-thumb { background: rgba(148,163,184,0.35) !important; }
.heartbeat-path-left, .heartbeat-path-right { stroke: #f472b6 !important; }
.oc-message-text { text-shadow: none !important; }

</style>
<style id="dark-typography">
/* === Dark Typography Tuning === */
:root{
  --text-primary:#E6EAF2;   /* body */
  --text-secondary:#A7B0C0; /* muted */
  --text-heading:#F3F4F6;   /* titles */
  --text-accent:#C7B5FF;    /* links */
}
html, body { color: var(--text-primary) !important; }
h1,h2,h3,h4,h5,h6 { color: var(--text-heading) !important; }
a { color: var(--text-accent) !important; }
.text-slate-900,.text-slate-800,.text-slate-700,.text-slate-600,.text-slate-500,
.text-purple-600,.text-purple-500,.text-slate-500\/70,.text-purple-600\/70{
  color: var(--text-secondary) !important;
}
.placeholder-slate-400, ::placeholder{ color: #8A93A6 !important; opacity: .9; }
.glass-card { border-color: rgba(255,255,255,0.08) !important; }

</style>
<style id="no-nagging">
/* === Remove reminder/nagging tone colors & effects === */
.oc-message-text.remind-normal,
.oc-message-text.remind-annoyed,
.oc-message-text.remind-angry,
.oc-message-text.ignore { color: var(--text-primary) !important; font-weight: 500 !important; }
.angry-shake, .vibration { animation: none !important; }
</style>
</head>
    <!-- 首頁 -->
    <div id="homePage" class="page show">
        <div class="flex flex-col min-h-screen p-4 relative z-10">
            <!-- 頂部狀態欄 -->
            <div class="flex justify-between items-center pt-4 pb-2 px-2">
                <div class="flex items-center space-x-2">
                    <div class="w-2 h-2 bg-green-400 rounded-full breathe"></div>
                    <span class="text-sm text-purple-600/70">在線</span>
                </div>
                <div class="text-sm text-purple-600/70" id="currentDate">
                    2025年7月29日 星期二
                </div>
            </div>

            <!-- 問候語和OC角色展示 -->
            <div class="mb-4">
                <div class="glass-card rounded-2xl p-6 bounce-soft cursor-pointer button-hover" onclick="goToOCCards()">
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <img id="currentOCAvatar" src="https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=100&h=100&fit=crop&crop=face" 
                                 alt="OC角色" 
                                 class="w-16 h-16 rounded-full object-cover border-2 border-purple-400/50 floating">
                            <div class="absolute -bottom-1 -right-1 w-6 h-6 bg-green-400 rounded-full border-2 border-white flex items-center justify-center">
                                <div class="w-2 h-2 bg-white rounded-full breathe"></div>
                            </div>
                        </div>
                        <div class="flex-1">
                            <h2 id="currentOCGreeting" class="text-lg font-semibold text-slate-800 mb-1">早安，大小姐！</h2>
                            <p class="text-sm text-purple-600/70">
                                <span id="currentOCName">尉霆</span>陪你度過這一天～ ✨
                            </p>
                        </div>
                        <button class="glass-card rounded-xl p-2 button-hover">
                            <svg class="w-5 h-5 text-purple-500" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 今日任務概覽 -->
            <div class="mb-4">
                <div class="flex items-center justify-between mb-3 px-2">
                    <h3 class="text-lg font-semibold text-slate-800">今日任務</h3>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-purple-600/70" id="taskProgress">0/0 完成</span>
                        <button onclick="addNewTask()" class="w-6 h-6 bg-slate-300 rounded-full flex items-center justify-center hover:bg-slate-400 transition-colors">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- 任務列表容器 -->
                <div class="glass-card rounded-xl p-4 max-h-60 overflow-y-auto" id="taskContainer">
                    <div id="taskList" class="space-y-2">
                        <!-- 任務项會通过JavaScript動態添加 -->
                    </div>
                </div>
            </div>

<!-- 主要操作按钮 -->
<div class="mb-4">
    <div class="mb-4">
        <!-- 開始番茄鐘 -->
        <button onclick="goToFocus()" class="gradient-purple rounded-2xl p-4 text-center button-hover paw-button text-white w-full">
            <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center mx-auto mb-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z"/>
                </svg>
            </div>
            <h4 class="font-semibold mb-1 text-sm">開始番茄鐘</h4>
            <p class="text-xs opacity-80">立即專注</p>
        </button>
    </div>
</div>


            
            <!-- 底部統計 -->
            <div class="glass-card rounded-xl p-6">
                <div class="grid grid-cols-2 text-center">
                    <div class="stat-clickable p-2" onclick="showGiftModal()">
                        <div class="text-xl font-bold bg-gradient-to-r from-purple-500 to-pink-500 bg-clip-text text-transparent" id="todayGifts">0</div>
                        <div class="text-xs text-slate-500">今日禮物</div>
                    </div>
                    <div class="stat-clickable p-2">
                        <div class="text-xl font-bold bg-gradient-to-r from-purple-500 to-pink-500 bg-clip-text text-transparent" id="focusTime">0m</div>
                        <div class="text-xs text-slate-500">專注時長</div>
                    </div>
                    <div class="stat-clickable p-2" onclick="showCompletedTasksModal()">
                        <div class="text-xl font-bold bg-gradient-to-r from-purple-500 to-pink-500 bg-clip-text text-transparent" id="todayCompleted">0</div>
                        <div class="text-xs text-slate-500">今日完成</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 已完成任務弹窗 -->
    <div id="completedTasksModal" class="completed-tasks-modal">
        <div class="completed-tasks-modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-slate-800">今日已完成任務 ✅</h3>
                <button onclick="closeCompletedTasksModal()" class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center hover:bg-slate-300 transition-colors">
                    <svg class="w-5 h-5 text-slate-600" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            </div>
            <div id="completedTasksList" class="max-h-96 overflow-y-auto">
                <div class="text-center text-slate-500 py-8">
                    <div class="text-4xl mb-2">📝</div>
                    <p>今天還没有完成任何任務呢～<br>快去完成一些任務吧！</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 已移除禮物彈窗 -->
<!-- 狀態禮物編輯彈窗 -->
<div id="statusGiftEditorModal" class="status-gift-editor-modal">
    <div class="status-gift-editor-content">
        <div class="status-gift-editor-header">
            <h3 class="status-gift-editor-title" id="statusGiftEditorTitle">
                <span id="statusGiftEditorIcon">📚</span>
                编辑學習禮物
            </h3>
            <button class="status-gift-editor-close" onclick="closeStatusGiftEditor()">
                <svg class="w-5 h-5 text-slate-600" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </button>
        </div>
        <div class="mb-4">
            <p class="text-sm text-slate-600 mb-2">每行一個禮物，建議格式：表情符号 + 禮物名稱 + 鼓勵語</p>
            <p class="text-xs text-slate-500">例如：🏆 學習冠軍獎杯！你的努力值得最好的獎勵！</p>
        </div>
        <textarea id="statusGiftEditorTextarea" class="status-gift-editor-textarea" placeholder="输入禮物內容，每行一個..."></textarea>
        <div class="status-gift-editor-actions">
            <button class="status-gift-editor-btn status-gift-editor-cancel" onclick="closeStatusGiftEditor()">取消</button>
            <button class="status-gift-editor-btn status-gift-editor-save" onclick="saveStatusGifts()">保存</button>
        </div>
    </div>
</div>

    <!-- OC卡片頁面 -->
    <div id="ocCardsPage" class="page hidden">
        <div class="flex flex-col min-h-screen p-4 relative z-10">
            <!-- 頂部導航欄 -->
            <div class="flex items-center justify-between pt-4 pb-6 px-2">
                <button onclick="goBackToHome()" class="glass-card rounded-full p-3 button-hover">
                    <svg class="w-6 h-6 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                <h1 class="text-xl font-bold text-slate-800">你的夢角卡池</h1>
                <div class="w-12"></div>
            </div>

            <!-- OC卡片網格 -->
            <div class="grid grid-cols-2 gap-4 mb-6" id="ocCardsGrid">
                <!-- 創建新OC卡片 -->
                <div class="oc-card create-card" onclick="createNewOC()">
                    <div class="text-4xl text-purple-400 mb-2">+</div>
                    <div class="text-sm text-purple-600 font-medium">創建新夢角</div>
                </div>
                
                <!-- 默认OC卡片 -->
                <div class="oc-card" onclick="editOC(0)">
                    <div class="flex items-center space-x-3">
                        <img src="https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=120&h=120&fit=crop&crop=face" 
                             alt="小艾" class="oc-card-avatar">
                        <div class="flex-1">
                            <h3 class="font-semibold text-slate-800 mb-1">小艾</h3>
                            <p class="text-xs text-slate-500">你的學習搭子</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- OC設置頁面 -->
    <div id="ocSettingPage" class="page hidden">
        <div class="flex flex-col min-h-screen p-4 relative z-10">
            <!-- 頂部導航欄 -->
            <div class="flex items-center justify-between pt-4 pb-6 px-2">
                <button onclick="goBackToOCCards()" class="glass-card rounded-full p-3 button-hover">
                    <svg class="w-6 h-6 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                <h1 class="text-xl font-bold text-slate-800">夢角設置</h1>
                <button onclick="saveOCSettings()" class="glass-card rounded-full p-3 button-hover">
                    <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </button>
            </div>

            <!-- 頭像設置 -->
            <div class="setting-section">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">頭像設置</h3>
                <div class="flex justify-center">
                    <div class="avatar-upload" onclick="uploadAvatar()">
                        <img id="avatarPreview" src="https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=240&h=240&fit=crop&crop=face" 
                             alt="頭像预覽" class="avatar-preview">
                        <input type="file" id="avatarInput" accept="image/*" style="display: none;" onchange="previewAvatar(event)">
                    </div>
                </div>
                <p class="text-sm text-slate-500 text-center mt-2">點击頭像上傳新圖片</p>
            </div>

            <!-- 基本信息設置 -->
            <div class="setting-section">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">基本信息</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">夢角名字</label>
                        <input type="text" id="ocNameInput" 
                               class="w-full px-4 py-3 rounded-xl border border-purple-200 focus:outline-none focus:ring-2 focus:ring-purple-400 bg-white/80" 
                               placeholder="你的夢角名字" 
                               value="尉霆">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">对你的称呼</label>
                        <input type="text" id="userTitleInput" 
                               class="w-full px-4 py-3 rounded-xl border border-purple-200 focus:outline-none focus:ring-2 focus:ring-purple-400 bg-white/80" 
                               placeholder="夢角如何稱呼你" 
                               value="女王">
                    </div>
                </div>
            </div>

            <!-- 問候語設置 -->
            <div class="setting-section">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">問候語設置</h3>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">自定義問候語</label>
                    <textarea id="customGreeting" 
                              class="w-full px-4 py-3 rounded-xl border border-purple-200 focus:outline-none focus:ring-2 focus:ring-purple-400 bg-white/80 h-20 resize-none" 
                              placeholder="設置自定義問候語（留空則根据時間自動問好）"></textarea>
                    <p class="text-xs text-slate-500 mt-1">留空時會根据時間自動顯示：早安/午安/晚安</p>
                </div>
            </div>

            <!-- 個性化設置 -->
            <div class="setting-section">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">個性化設置</h3>
                
                <!-- 鼓勵風格 -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-slate-700 mb-3">鼓励風格（可多選）</label>
                    <div class="style-grid" id="encourageStyleGrid">
                        <div class="style-option" data-style="gentle" onclick="handleStyleClick(event, 'gentle', 'encourage')">
                            <div class="style-title">温柔守護型</div>
                            <div class="style-desc">Ta存在的意义，就是為你隔绝一切風雨，默默守護你的方寸安宁。</div>
                            <div class="style-selector-circle" onclick="handleStyleSelect(event, 'gentle')"></div>
                        </div>
                        <div class="style-option" data-style="tsundere" onclick="handleStyleClick(event, 'tsundere', 'encourage')">
                            <div class="style-title">傲娇毒舌型</div>
                            <div class="style-desc">嘴硬心软的典范。Ta總是用嫌弃和吐槽来掩飾自己的關心。</div>
                            <div class="style-selector-circle" onclick="handleStyleSelect(event, 'tsundere')"></div>
                        </div>
                        <div class="style-option" data-style="cheerful" onclick="handleStyleClick(event, 'cheerful', 'encourage')">
                            <div class="style-title">陽光開朗型</div>
                            <div class="style-desc">Ta是你的專屬啦啦队和能量源，用不竭的热情與喝彩，為你注入必胜的活力。</div>
                            <div class="style-selector-circle" onclick="handleStyleSelect(event, 'cheerful')"></div>
                        </div>
                        <div class="style-option" data-style="aloof" onclick="handleStyleClick(event, 'aloof', 'encourage')">
                            <div class="style-title">淡漠深沉型</div>
                            <div class="style-desc">Ta如同深海或静夜，表面波澜不惊，內裡却蕴藏着只為你一人涌動的深情。</div>
                            <div class="style-selector-circle" onclick="handleStyleSelect(event, 'aloof')"></div>
                        </div>
                        <div class="style-option" data-style="mature" onclick="handleStyleClick(event, 'mature', 'encourage')">
                            <div class="style-title">成熟包容型</div>
                            <div class="style-desc">Ta像一座坚實的靠山，一片宁静的港湾。在Ta面前，你无需伪装坚强，可以安心地做最真實的自己。</div>
                            <div class="style-selector-circle" onclick="handleStyleSelect(event, 'mature')"></div>
                        </div>
                        <div class="style-option" data-style="cunning" onclick="handleStyleClick(event, 'cunning', 'encourage')">
                            <div class="style-title">腹黑心机型</div>
                            <div class="style-desc">學習在Ta眼中是一场游戏，而你，就是Ta志在必得的猎物與奖励。</div>
                            <div class="style-selector-circle" onclick="handleStyleSelect(event, 'cunning')"></div>
                        </div>
                        <div class="style-option" data-style="shy" onclick="handleStyleClick(event, 'shy', 'encourage')">
                            <div class="style-title">纯情害羞型</div>
                            <div class="style-desc">Ta每次和你说話，耳根都會悄悄泛红。Ta的世界很小，小到只能装下書本和你。</div>
                            <div class="style-selector-circle" onclick="handleStyleSelect(event, 'shy')"></div>
                        </div>
                        <div class="style-option" data-style="doting" onclick="handleStyleClick(event, 'doting', 'encourage')">
                            <div class="style-title">无腦溺愛型</div>
                            <div class="style-desc">這位的人生信條就是——我的宝贝，天下第一！學習？那是什麼？我家宝宝想玩玩，那我就陪着呗！</div>
                            <div class="style-selector-circle" onclick="handleStyleSelect(event, 'doting')"></div>
                        </div>
                        <!-- 自定义風格卡片 -->
                        <div class="style-option custom-style-card" data-style="custom-encourage" onclick="handleCustomStyleClick('encourage')">
                            <div class="style-title">✏️ 自定义</div>
                            <div class="style-desc">創建你独特的鼓励風格</div>
                            <div class="style-selector-circle" onclick="event.stopPropagation(); handleStyleSelect(event, 'custom-encourage')"></div>
                        </div>
                    </div>
                </div>
                
                <!-- 督促風格 -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-3">督促風格（可多選）</label>
                    <div class="style-grid" id="reminderStyleGrid">
                        <div class="style-option" data-style="guardian" onclick="handleStyleClick(event, 'guardian', 'remind')">
                            <div class="style-title">守護者</div>
                            <div class="style-desc">温和而坚定地守護你的學習時光</div>
                            <div class="style-selector-circle" onclick="handleStyleSelect(event, 'guardian')"></div>
                        </div>
                        <div class="style-option" data-style="pusher" onclick="handleStyleClick(event, 'pusher', 'remind')">
                            <div class="style-title">鞭策者</div>
                            <div class="style-desc">严格要求，用坚决的態度督促你前进</div>
                            <div class="style-selector-circle" onclick="handleStyleSelect(event, 'pusher')"></div>
                        </div>
                        <div class="style-option" data-style="cheerleader" onclick="handleStyleClick(event, 'cheerleader', 'remind')">
                            <div class="style-title">應援者</div>
                            <div class="style-desc">用热情的鼓励為你加油打氣</div>
                            <div class="style-selector-circle" onclick="handleStyleSelect(event, 'cheerleader')"></div>
                        </div>
                        <div class="style-option" data-style="observer" onclick="handleStyleClick(event, 'observer', 'remind')">
                            <div class="style-title">观察者</div>
                            <div class="style-desc">默默關注，在合适的時机给出提醒</div>
                            <div class="style-selector-circle" onclick="handleStyleSelect(event, 'observer')"></div>
                        </div>
                        <div class="style-option" data-style="guide" onclick="handleStyleClick(event, 'guide', 'remind')">
                            <div class="style-title">引導者</div>
                            <div class="style-desc">循循善诱，用智慧引導你回到正轨</div>
                            <div class="style-selector-circle" onclick="handleStyleSelect(event, 'guide')"></div>
                        </div>
                        <div class="style-option" data-style="strategist" onclick="handleStyleClick(event, 'strategist', 'remind')">
                            <div class="style-title">布局者</div>
                            <div class="style-desc">精心計劃，用策略帮你规劃學習</div>
                            <div class="style-selector-circle" onclick="handleStyleSelect(event, 'strategist')"></div>
                        </div>
                        <div class="style-option" data-style="companion" onclick="handleStyleClick(event, 'companion', 'remind')">
                            <div class="style-title">陪伴者</div>
                            <div class="style-desc">静静陪伴，用温暖的存在支持你</div>
                            <div class="style-selector-circle" onclick="handleStyleSelect(event, 'companion')"></div>
                        </div>
                        <div class="style-option" data-style="believer" onclick="handleStyleClick(event, 'believer', 'remind')">
                            <div class="style-title">溺愛者</div>
                            <div class="style-desc">坚信你的能力，用信任激励你</div>
                            <div class="style-selector-circle" onclick="handleStyleSelect(event, 'believer')"></div>
                        </div>
                        <!-- 自定义風格卡片 -->
                        <div class="style-option custom-style-card" data-style="custom-remind" onclick="handleCustomStyleClick('remind')">
                            <div class="style-title">✏️ 自定义</div>
                            <div class="style-desc">創建你独特的督促風格</div>
                            <div class="style-selector-circle" onclick="event.stopPropagation(); handleStyleSelect(event, 'custom-remind')"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 狀態禮物設置 -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-slate-700 mb-3">狀態禮物設置</label>
                <p class="text-xs text-slate-500 mb-3">為你的夢角設置專屬的禮物奖励，完成番茄鐘時會随机获得。</p>
                <div class="status-gift-grid" id="statusGiftGrid">
                <!-- 预設狀態禮物卡片 -->
                    <div class="status-gift-card" data-status="學習"onclick="editStatusGift('學習', '📚')" >
                        <div class="status-gift-header">
                            <span class="status-gift-icon">📚</span>
                            <span class="status-gift-name">學習</span>
                        </div>
                        <div class="status-gift-preview">點击编辑禮物內容</div>
                        <div class="status-gift-edit-indicator">✏️</div>
                    </div>
                    <div class="status-gift-card" data-status="工作"onclick="editStatusGift('學習', '📚')">
                        <div class="status-gift-header">
                            <span class="status-gift-icon">💼</span>
                            <span class="status-gift-name">工作</span>
                        </div>
                        <div class="status-gift-preview">點击编辑禮物內容</div>
                        <div class="status-gift-edit-indicator">✏️</div>
                    </div>
                    
                    <div class="status-gift-card" data-status="冒险"onclick="editStatusGift('學習', '📚')">
                        <div class="status-gift-header">
                            <span class="status-gift-icon">🗺️</span>
                            <span class="status-gift-name">冒险</span>
                        </div>
                        <div class="status-gift-preview">點击编辑禮物內容</div>
                        <div class="status-gift-edit-indicator">✏️</div>
                    </div>
                    
                    <div class="status-gift-card" data-status="逛街"onclick="editStatusGift('學習', '📚')">
                        <div class="status-gift-header">
                            <span class="status-gift-icon">🛍️</span>
                            <span class="status-gift-name">逛街</span>
                        </div>
                        <div class="status-gift-preview">點击编辑禮物內容</div>
                        <div class="status-gift-edit-indicator">✏️</div>
                    </div>
                    
                    <div class="status-gift-card" data-status="玩游戏"onclick="editStatusGift('學習', '📚')">
                        <div class="status-gift-header">
                            <span class="status-gift-icon">🎮</span>
                            <span class="status-gift-name">玩游戏</span>
                        </div>
                        <div class="status-gift-preview">點击编辑禮物內容</div>
                        <div class="status-gift-edit-indicator">✏️</div>
                    </div>
                    
                    <div class="status-gift-card" data-status="發呆"onclick="editStatusGift('學習', '📚')">
                        <div class="status-gift-header">
                            <span class="status-gift-icon">💭</span>
                            <span class="status-gift-name">發呆</span>
                        </div>
                        <div class="status-gift-preview">點击编辑禮物內容</div>
                        <div class="status-gift-edit-indicator">✏️</div>
                    </div>
                    
                    <div class="status-gift-card" data-status="睡觉"onclick="editStatusGift('學習', '📚')">
                        <div class="status-gift-header">
                            <span class="status-gift-icon">💤</span>
                            <span class="status-gift-name">睡觉</span>
                        </div>
                        <div class="status-gift-preview">點击编辑禮物內容</div>
                        <div class="status-gift-edit-indicator">✏️</div>
                    </div>
                    
                    <div class="status-gift-card" data-status="休息"onclick="editStatusGift('學習', '📚')">
                        <div class="status-gift-header">
                            <span class="status-gift-icon">🌙</span>
                            <span class="status-gift-name">休息</span>
                        </div>
                        <div class="status-gift-preview">點击编辑禮物內容</div>
                        <div class="status-gift-edit-indicator">✏️</div>
                    </div>
                    <!-- 自定义狀態卡片 -->
        <div class="status-gift-card custom-status-card" onclick="createCustomStatusGift()">
            <div class="status-gift-header">
                <span class="status-gift-icon">+</span>
                <span class="status-gift-name">自定义狀態</span>
            </div>
            <div class="status-gift-preview">添加新的狀態禮物</div>
            <div class="status-gift-edit-indicator">✨</div>
        </div>
    </div>
</div>


            <!-- 其他設置 -->
            <div class="setting-section">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">其他設置</h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2"></label>
                        <p class="text-xs text-slate-500 mb-3"></p>
                        <textarea id="customGiftsInput" 
                                  class="w-full px-4 py-3 rounded-xl border border-purple-200 focus:outline-none focus:ring-2 focus:ring-purple-400 bg-white/80 h-32 resize-none text-sm" 
                                  placeholder="🎁 你是最棒的！"
                                  rows="6"></textarea>
                        
                    </div>
                
                        </ul>
                    </div>
                </div>
            </div>

            <!-- 刪除夢角按钮 -->
            <div class="setting-section border-red-200">
                <button onclick="deleteOC()" class="w-full py-3 rounded-xl bg-red-500 text-white font-medium hover:bg-red-600 transition-colors">
                    刪除這個夢角
                </button>
            </div>
        </div>
    </div>

    <!-- 風格語句编辑弹窗 -->
    <div id="styleEditorModal" class="style-editor-modal">
        <div class="style-editor-content">
            <div class="style-editor-header">
                <h3 class="style-editor-title" id="styleEditorTitle">编辑風格語句</h3>
                <button class="style-editor-close" onclick="closeStyleEditor()">
                    <svg class="w-5 h-5 text-slate-600" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            </div>
            <div class="mb-4">
                <p class="text-sm text-slate-600" id="styleEditorDesc">每行一條語句，{title} 會被替換為用戶称呼</p>
            </div>
            <textarea id="styleEditorTextarea" class="style-editor-textarea" placeholder="输入語句，每行一條..."></textarea>
            <div class="style-editor-actions">
                <button class="style-editor-btn style-editor-cancel" onclick="closeStyleEditor()">取消</button>
                <button class="style-editor-btn style-editor-save" onclick="saveStyleMessages()">保存</button>
            </div>
        </div>
    </div>

    <!-- 專注界面 -->
    <div id="focusPage" class="page hidden bg-gradient-to-br from-purple-50 to-pink-50">
        <!-- 專注頁面背景装飾 -->
        <div class="fixed inset-0 pointer-events-none overflow-hidden">
            <!-- 更多樱花 -->
            <div class="absolute top-20 left-8 text-pink-300/50 text-xl floating">🌸</div>
            <div class="absolute top-32 right-12 text-pink-200/40 text-lg floating" style="animation-delay: 0.8s;">🌸</div>
            <div class="absolute top-48 left-1/4 text-pink-300/60 text-sm floating" style="animation-delay: 1.5s;">🌸</div>
            <div class="absolute bottom-48 right-20 text-pink-200/50 text-lg floating" style="animation-delay: 2s;">🌸</div>
            <div class="absolute bottom-32 left-12 text-pink-300/40 text-xl floating" style="animation-delay: 0.3s;">🌸</div>
            
            <div class="absolute top-40 right-8 text-pink-400/60 text-lg sparkle">🌸</div>
            <div class="absolute bottom-40 left-8 text-pink-300/50 text-sm sparkle" style="animation-delay: 1.2s;">🌸</div>
            <div class="absolute top-64 right-1/4 text-pink-400/40 text-lg sparkle" style="animation-delay: 2.2s;">🌸</div>
        </div>

        <!-- 專注頁面內容 -->
        <div class="flex flex-col h-full focus-container relative z-10">
            <!-- 計時器和任務信息区域 -->
            <div class="glass-card rounded-2xl p-3 mb-4 focus-section relative z-50">
                <!-- 返回按钮在左上角 -->
                <button onclick="goBackHome()" class="absolute -top-2 -left-2 glass-card rounded-full p-2 button-hover">
                    <svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                
                <!-- 模式切換 -->
                <div class="flex justify-center mb-2 mt-2">
                    <div class="bg-white/50 rounded-xl p-1 flex">
                        <button id="pomodoroBtn" class="px-4 py-2 rounded-lg text-sm font-medium transition-all mode-active">
                            番茄鐘
                        </button>
                        <button id="timerBtn" class="px-4 py-2 rounded-lg text-sm font-medium transition-all text-slate-600">
                            正計時
                        </button>
                    </div>
                </div>
                
                <!-- 計時器顯示 -->
                <div class="text-center mb-2 relative">
                    <div id="timerDisplay" class="timer-text font-bold bg-gradient-to-r from-purple-500 to-pink-500 bg-clip-text text-transparent" onclick="toggleTimeSelector()">
                        25:00
                    </div>
                    
                    <!-- 時間選擇器 -->
                    <div id="timeSelector" class="time-selector" style="z-index: 70;">
                        <div class="time-option" onclick="selectTime(10)">
                            <span>10 分鐘</span>
                            <span class="text-xs text-slate-500">短專注</span>
                        </div>
                        <div class="time-option active" onclick="selectTime(25)">
                            <span>25 分鐘</span>
                            <span class="text-xs text-slate-500">标準</span>
                        </div>
                        <div class="time-option" onclick="selectTime(50)">
                            <span>50 分鐘</span>
                            <span class="text-xs text-slate-500">深度專注</span>
                        </div>
                        <div class="custom-time-input">
                            <span class="text-sm text-slate-600 whitespace-nowrap">自定义:</span>
                            <input type="number" 
                                   class="flex-1 bg-white/80 border border-purple-200 rounded-lg px-3 py-1 text-sm text-center min-w-0" 
                                   id="customTimeInput" 
                                   min="1" 
                                   max="120" 
                                   value="25" 
                                   placeholder="1-120"
                                   onkeypress="handleCustomTimeEnter(event)">
                            <span class="text-sm text-slate-600 whitespace-nowrap">分鐘</span>
                        </div>
                    </div>
                </div>
                
                <!-- 当前任務信息 -->
                <div class="bg-white/40 rounded-xl p-3 cursor-pointer hover:bg-white/50 transition-colors relative" onclick="showTaskSelector()">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-slate-500 text-xs mb-1">当前任務</p>
                            <p id="currentTaskName" class="text-slate-800 font-medium text-sm">複習英語單词</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div id="currentTaskStatus" class="text-xs text-blue-500 bg-blue-100 px-2 py-1 rounded-full">
                                进行中
                            </div>
                            <svg class="w-4 h-4 text-slate-400" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
                            </svg>
                        </div>
                    </div>
                    
                    <!-- 任務選擇器 -->
                    <div id="taskSelector" class="status-selector" style="top: calc(100% + 10px); z-index: 70;">
                        <!-- 任務選项會動態添加 -->
                    </div>
                </div>
            </div>

            <!-- 中部区域 - OC狀態展示 -->
            <div class="flex flex-col justify-center items-center px-4 relative flex-1">
                <!-- OC頭像区域 - 居中，两邊心電圖 -->
                <div class="relative mb-4 flex items-center justify-center w-full">
                    <!-- 左侧心電圖 -->
                    <div class="heartbeat-line-left flex-shrink-0" style="margin-right: -20px;">
                        <svg viewBox="0 0 80 50">
                            <path class="heartbeat-path-left static" d="M0 25 L15 25 L20 10 L25 40 L30 15 L35 35 L40 25 L80 25"/>
                        </svg>
                    </div>
                    
                    <!-- OC頭像 -->
                    <div class="oc-avatar bg-gradient-to-br from-purple-100 to-pink-100 rounded-full flex items-center justify-center relative" onclick="handleOCClick()">
                        <img id="focusOCAvatar" src="https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=200&h=200&fit=crop&crop=face" 
                             alt="OC頭像" class="w-full h-full object-cover rounded-full">
                    </div>
                    
                    <!-- 右侧心電圖 -->
                    <div class="heartbeat-line-right flex-shrink-0" style="margin-left: -20px;">
                        <svg viewBox="0 0 80 50">
                            <path class="heartbeat-path-right static" d="M0 25 L45 25 L50 15 L55 35 L60 10 L65 40 L70 25 L80 25"/>
                        </svg>
                    </div>
                </div>

                <!-- OC狀態文字 - 優化居中算法 -->
                <div class="text-center mb-2 relative">
                    <button id="statusButton" onclick="toggleStatusSelector()" class="oc-status-text-wrapper text-slate-700 font-medium text-lg mb-2 breathe hover:text-purple-600 transition-colors cursor-pointer">
                        <span class="oc-status-pure-text">狀態待選擇</span> <span class="oc-status-emoji">⚪</span>
                    </button>
                    
                    <!-- 狀態選擇器 -->
                    <div id="statusSelector" class="status-selector" style="z-index: 70;">
                        <div class="status-grid">
                            <div class="status-option" onclick="selectStatus('學習', '📚')">
                                <span class="status-icon">📚</span>
                                <span class="status-text">學習</span>
                            </div>
                            <div class="status-option" onclick="selectStatus('工作', '💼')">
                                <span class="status-icon">💼</span>
                                <span class="status-text">工作</span>
                            </div>
                            <div class="status-option" onclick="selectStatus('冒险', '🗺️')">
                                <span class="status-icon">🗺️</span>
                                <span class="status-text">冒险</span>
                            </div>
                            <div class="status-option" onclick="selectStatus('逛街', '🛍️')">
                                <span class="status-icon">🛍️</span>
                                <span class="status-text">逛街</span>
                            </div>
                            <div class="status-option" onclick="selectStatus('玩游戏', '🎮')">
                                <span class="status-icon">🎮</span>
                                <span class="status-text">玩游戏</span>
                            </div>
                            <div class="status-option" onclick="selectStatus('發呆', '💭')">
                                <span class="status-icon">💭</span>
                                <span class="status-text">發呆</span>
                            </div>
                            <div class="status-option" onclick="selectStatus('睡觉', '💤')">
                                <span class="status-icon">💤</span>
                                <span class="status-text">睡觉</span>
                            </div>
                            <div class="status-option" onclick="selectStatus('休息', '🌙')">
                                <span class="status-icon">🌙</span>
                                <span class="status-text">休息</span>
                            </div>
                            <div class="status-option" onclick="showCustomStatusInput()">
                                <span class="status-icon">✏️</span>
                                <span class="status-text">自定义</span>
                            </div>
                        </div>
                        
                        <!-- 自定义狀態输入框 -->
                        <div id="customStatusInput" class="mt-3 hidden">
                            <input type="text" 
                                   id="customStatusText" 
                                   class="w-full px-3 py-2 rounded-lg border border-purple-200 focus:outline-none focus:ring-2 focus:ring-purple-400 bg-white/80 text-sm" 
                                   placeholder="输入自定义狀態（如：看書、運動等）"
                                   onkeypress="handleCustomStatusEnter(event)"
                                   maxlength="10">
                            <div class="flex justify-end mt-2 space-x-2">
                                <button onclick="cancelCustomStatus()" class="px-3 py-1 text-xs rounded-lg bg-slate-200 text-slate-600 hover:bg-slate-300 transition-colors">
                                    取消
                                </button>
                                <button onclick="confirmCustomStatus()" class="px-3 py-1 text-xs rounded-lg bg-purple-500 text-white hover:bg-purple-600 transition-colors">
                                    確认
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- OC語区域 - 優化文字居中 -->
                <div class="oc-message-area">
                    <div id="ocMessageText" class="oc-message-text">
                        <span class="oc-message-text-wrapper">快開始學習吧！我會一直陪着你！！</span>
                    </div>
                </div>
            </div>

            <!-- 底部操作区域 -->
            <div class="mt-auto">
                <!-- 單個開始按钮 -->
                <div id="singleButtonLayout" class="flex flex-col items-center px-4 mb-6">
                    <div id="startBtnHint" class="text-xs text-slate-600 mb-2 hidden">请選擇夢角狀態</div>
                    <button id="startBtn" class="bg-gradient-to-r from-purple-500 to-pink-500 rounded-2xl px-8 py-3 button-hover paw-button text-white font-semibold" onclick="startStopTimer()">
                        <span id="startBtnText">開始</span>
                    </button>
                </div>
                
                <!-- 三按钮布局（隱藏狀態） -->
                <div id="threeButtonLayout" class="three-button-layout px-4 hidden">
                    <!-- 音樂按钮 -->
                    <button id="musicBtn" class="side-button button-hover" onclick="toggleMusic()">
                        <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                        </svg>
                    </button>

                    <!-- 暂停/继续按钮 -->
                    <button id="pauseBtn" class="bg-gradient-to-r from-purple-500 to-pink-500 main-button button-hover text-white font-semibold" onclick="pauseResumeTimer()">
                        <svg class="w-8 h-8" fill="white" viewBox="0 0 24 24">
                            <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                        </svg>
                    </button>

                    <!-- 停止按钮 -->
                    <button id="stopBtn" class="side-button button-hover" onclick="stopTimer()">
                        <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M6 6h12v12H6z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 完成禮物弹窗 -->
    <div id="completionModal" class="completion-modal">
        <div class="completion-modal-content">
            <div id="completionTitle" class="completion-title">🎉 恭喜完成任務！</div>
            <div id="completionGift" class="completion-gift">小艾學習结束啦，给你带回了 🎁 專屬定制奖杯！你是最棒的！</div>
            <button class="completion-close-btn" onclick="closeCompletionModal()">继续學習</button>
        </div>
    </div>

    <script>
        // 全局變量
        let currentPage = 'home';
        let isTimerRunning = false;
        let isPaused = false;
        let currentTime = 25 * 60;
        let selectedMinutes = 25;
        let timerInterval = null;
        let currentMode = 'pomodoro';
        let currentStatus = { name: '', icon: '⚪' };
        let currentMusicMode = 0;
        // 音频管理
        let currentBackgroundMusic = null;
        let completionAudio = null;
        let isMusicEnabled = true;
        let musicPausedTime = 0; 
let musicType = 'mute'; 

// 音频文件URL
const audioFiles = {
    music: 'https://raw.githubusercontent.com/dengxi-cpu/Pomodoro/main/music.mp3',
    rain: 'https://raw.githubusercontent.com/dengxi-cpu/Pomodoro/main/storm.mp3',
    completion: 'https://raw.githubusercontent.com/dengxi-cpu/Pomodoro/main/commission_finished.MP3'
};
        let isStatusSelected = false;
        // 自定义狀態存儲（新增）
let customStatuses = {};  // 存儲自定义狀態的圖标等信息
        let currentTask = { name: '複習英語單词', status: '进行中', color: 'blue' };
        const musicIcons = ['🔇', '🎵', '🌧️'];
        
        // 4.1 全局變量（
        let statusGifts = {
    '學習': [
        '🏆 學霸專屬奖杯！知识的力量让你闪闪發光！',
        '📖 你念叨过的绝版書（Ta在古籍書店蹲了2小時）',
        '⭐ 學習之星徽章！你就是最亮的那颗星！',
        '🖋️ 定制钢笔（笔夹刻着你名字缩寫，墨色是你最愛的灰紫）',
        '📝 寫满心得的笔记（在重點頁夹着银杏書签："此處你會喜歡"）',
        '💎 知识宝石！比钻石更珍贵的是你的努力！'
        
    ],
    '工作': [
        '🐱 解压小物（會摇頭的猫咪摆件——"放你電腦旁，替我监督你休息"）',
        '🚀 效率火箭！工作狀態满分！',
        '⚡ 生產力闪電！今天的你超級给力！',
        '✨ 星空投影灯（加班夜挑的："以後我晚歸，让它陪你入睡"）',
        '🧁 你最喜歡的甜品（用手帕仔细包着："你说过這款最好吃"）'
    ],
    '冒险': [
        '🗺️ 冒险家地圖！每一步都是新的發現！',
        '🌌 山頂拍的星空照（背後寫着：我的宇宙中心是你）',
        '🏴‍☠️ 探险旗帜！未知的世界在等着你！',
        '💧 森林露水（水晶瓶装着）',
        '💎 會發光的矿石（嵌成项链）'
    ],
    '逛街': [
        '🧦 错版袜子（左藍猫右橘猫）',
        '☕ 手作陶泥杯（杯柄捏成歪心形）',
        '👠 時尚女王高跟鞋！走路都带風！',
        '💄 美妆大师套装！你就是最美的風景！',
        '💐 你喜歡的香水（"現在風经过你，都是你的味道"）'
    ],
    '玩游戏': [
        '🎮 游戏大神手柄！技術流就是你！',
        '🏆 電竞冠军奖杯！菜鸟什麼的不存在！',
        '💍 游戏幣熔的戒指（內侧刻你的名字）',
        '🎯 百發百中勋章！精準度MAX！',
        '🔥 連胜火焰！今天狀態爆表！'
    ],
    '發呆': [
        '☁️ 思考雲朵！放空也是一种智慧！',
        '🐷 便利店收据背面涂鸦（畫你睡脸："监控拍到某只小猪偷懒证据"）',
        '☁️ 雲朵形狀的石頭（放你手心："它飘累了，来你這裡降落"）',
        '🦋 银杏叶拼成的蝴蝶（夹在诗集第14頁："你生日那天的風送来的"）',
        '💭 創意泡泡！下一個好點子就要冒出来了！'
    ],
    '睡觉': [
        '😴 好夢成真枕頭！甜美夢境等着你！',
        '🌙 枕頭暖意（把發热眼罩塞给你："借你充電5分鐘"）',
        '⭐ 星星安眠曲！让星光陪你入睡！',
        '🛏️ 雲朵床铺！像躺在雲端一樣舒适！',
        '💭 压皱的夢境（便签寫着："夢見我抢你冰淇淋，赔你张兑換券"）'
    ],
    '休息': [
        '🌿 放松叶子！让疲惫随風飘散！',
        '🍃 清新薄荷！瞬間恢複活力！',
        '🌺 舒缓花朵！身心都得到了治愈！',
        '🌻 老奶奶賣的绒線花（永不凋谢的向日葵："她说要送给愛笑的小姑娘"）',
        '🍁 流浪猫送的谢禮（松果涂成金色："用小魚干換的"）'
    ]
};

let currentEditingStatus = '';
let currentEditingStatusIcon = '';
// 4.2 狀態禮物编辑相關函數
function editStatusGift(statusName, statusIcon) {
    currentEditingStatus = statusName;
    currentEditingStatusIcon = statusIcon;
    
    const modal = document.getElementById('statusGiftEditorModal');
    const title = document.getElementById('statusGiftEditorTitle');
    const icon = document.getElementById('statusGiftEditorIcon');
    const textarea = document.getElementById('statusGiftEditorTextarea');
    
    title.textContent = `编辑${statusName}禮物`;
    icon.textContent = statusIcon;
    
    // 加载当前狀態的禮物內容
    const currentGifts = statusGifts[statusName] || [];
    textarea.value = currentGifts.join('\n');
    
    modal.classList.add('show');
}

function closeStatusGiftEditor() {
    document.getElementById('statusGiftEditorModal').classList.remove('show');
}

function saveStatusGifts() {
    const textarea = document.getElementById('statusGiftEditorTextarea');
    const gifts = textarea.value.trim().split('\n').filter(line => line.trim());
    
    // 保存禮物內容
    statusGifts[currentEditingStatus] = gifts;
    
    // 保存到本地存儲
    saveStatusGiftsToStorage();
    
    // 更新预覽顯示
    updateStatusGiftPreview(currentEditingStatus);
    
    closeStatusGiftEditor();
    alert('禮物已保存！');
}

function updateStatusGiftPreview(statusName) {
    const card = document.querySelector(`[data-status="${statusName}"]`);
    if (card) {
        const preview = card.querySelector('.status-gift-preview');
        const gifts = statusGifts[statusName] || [];
        if (gifts.length > 0) {
            // 顯示前两個禮物作為预覽
            const previewText = gifts.slice(0, 2).join('；');
            preview.textContent = previewText.length > 40 ? previewText.substring(0, 40) + '...' : previewText;
        } else {
            preview.textContent = '點击编辑禮物內容';
        }
    }
}

function createCustomStatusGift() {
    // 弹出输入框让用戶输入狀態名称
    const statusName = prompt('请输入自定义狀態名称（建议2-4個字符）：');
    
    if (!statusName || !statusName.trim()) {
        return;
    }
    
    const trimmedName = statusName.trim();
    if (trimmedName.length > 6) {
        alert('狀態名称不能超过6個字符');
        return;
    }
    
    // 检查是否已存在
    if (statusGifts[trimmedName]) {
        alert('该狀態已存在');
        return;
    }
    
    // 让用戶選擇圖标
    const statusIcon = prompt('请输入狀態圖标（emoji表情）：', '✨');
    
    if (!statusIcon || !statusIcon.trim()) {
        return;
    }
    
    const trimmedIcon = statusIcon.trim();
    
    // 初始化狀態禮物
    statusGifts[trimmedName] = ['在這裡输入禮物內容，每行一個...'];
    
    // 保存自定义狀態信息（新增）
    customStatuses[trimmedName] = {
        icon: trimmedIcon,
        name: trimmedName,
        isCustom: true
    };
    
    // 保存到本地存儲
    saveStatusGiftsToStorage();
    saveCustomStatusesToStorage(); // 新增
    
    // 添加卡片到頁面
    addCustomStatusCard(trimmedName, trimmedIcon);
    
    // 同步到專注頁面（新增）
    syncCustomStatusToFocusPage(trimmedName, trimmedIcon);
    
    // 自動打開编辑器
    setTimeout(() => {
        editStatusGift(trimmedName, trimmedIcon);
    }, 100);
}


function addCustomStatusCard(statusName, statusIcon) {
    const grid = document.getElementById('statusGiftGrid');
    const customButton = grid.querySelector('.custom-status-card');
    
    const newCard = document.createElement('div');
    newCard.className = 'status-gift-card';
    newCard.setAttribute('data-status', statusName);
    
    newCard.innerHTML = `
        <div class="status-gift-header">
            <span class="status-gift-icon">${statusIcon}</span>
            <span class="status-gift-name">${statusName}</span>
        </div>
        <div class="status-gift-preview">點击编辑禮物內容</div>
        <div class="status-gift-edit-indicator">✏️</div>
        <button class="custom-status-delete" title="刪除此自定义狀態">
            <svg class="w-3 h-3 text-red-500" fill="currentColor" viewBox="0 0 24 24">
                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            </svg>
        </button>
    `;
    
    // 插入到自定义按钮之前
    if (customButton) {
        grid.insertBefore(newCard, customButton);
    }
    
    // 同步到專注頁狀態選擇器
    syncCustomStatusToFocusPage(statusName, statusIcon);
}

function deleteCustomStatusGift(statusName) {
    // 检查是否是预設狀態
    const presetStatuses = ['學習', '工作', '冒险', '逛街', '玩游戏', '發呆', '睡觉', '休息'];
    if (presetStatuses.includes(statusName)) {
        alert('预設狀態不能刪除，只能编辑');
        return;
    }
    
    if (confirm(`確定要刪除"${statusName}"狀態嗎？此操作不可恢複。`)) {
        // 从存儲中刪除
        delete statusGifts[statusName];
        delete customStatuses[statusName];
        
        // 保存到本地存儲
        saveStatusGiftsToStorage();
        saveCustomStatusesToStorage();
        
        // 从頁面中移除卡片
        const card = document.querySelector(`[data-status="${statusName}"]`);
        if (card) {
            card.remove();
        }
        
        // 从專注頁移除对應的狀態選项
        removeCustomStatusFromFocusPage(statusName);
        
        // 提示刪除成功
        console.log(`已刪除自定义狀態: ${statusName}`);
    }
}



function saveStatusGiftsToStorage() {
    localStorage.setItem('statusGifts', JSON.stringify(statusGifts));
}
// 保存自定义狀態到本地存儲（新增）
function saveCustomStatusesToStorage() {
    localStorage.setItem('customStatuses', JSON.stringify(customStatuses));
}

// 从本地存儲加载自定义狀態（新增）
function loadCustomStatusesFromStorage() {
    const saved = localStorage.getItem('customStatuses');
    if (saved) {
        try {
            customStatuses = JSON.parse(saved);
        } catch (e) {
            console.log('Failed to parse custom statuses');
            customStatuses = {};
        }
    }
}

// 同步自定义狀態到專注頁面（新增）
function syncCustomStatusToFocusPage(statusName, statusIcon) {
    const statusGrid = document.querySelector('#statusSelector .status-grid');
    if (!statusGrid) return;
    
    // 检查是否已存在
    const existingOption = statusGrid.querySelector(`[data-custom-status="${statusName}"]`);
    if (existingOption) return;
    
    // 創建新的狀態選项
    const statusOption = document.createElement('div');
    statusOption.className = 'status-option';
    statusOption.setAttribute('data-custom-status', statusName);
    statusOption.onclick = () => selectStatus(statusName, statusIcon);
    
    statusOption.innerHTML = `
        <span class="status-icon">${statusIcon}</span>
        <span class="status-text">${statusName}</span>
    `;
    
    // 插入到自定义選项之前
    const customStatusOption = statusGrid.querySelector('[onclick="showCustomStatusInput()"]');
    if (customStatusOption) {
        statusGrid.insertBefore(statusOption, customStatusOption);
    } else {
        statusGrid.appendChild(statusOption);
    }
}

// 从專注頁面移除自定义狀態（新增）
function removeCustomStatusFromFocusPage(statusName) {
    const statusOption = document.querySelector(`[data-custom-status="${statusName}"]`);
    if (statusOption) {
        statusOption.remove();
    }
}

// 初始化專注頁面的自定义狀態選项（新增）
function initCustomStatusInFocusPage() {
    Object.keys(customStatuses).forEach(statusName => {
        const statusInfo = customStatuses[statusName];
        syncCustomStatusToFocusPage(statusName, statusInfo.icon);
    });
}



function loadStatusGiftsFromStorage() {
    const saved = localStorage.getItem('statusGifts');
    if (saved) {
        try {
            const loaded = JSON.parse(saved);
            // 合并默认狀態禮物和自定义狀態禮物
            statusGifts = { ...statusGifts, ...loaded };
        } catch (e) {
            console.log('Failed to parse status gifts');
        }
    }
}

function initializeStatusGiftPreviews() {
    // 確保DOM準備好再执行
    const statusGiftGrid = document.getElementById('statusGiftGrid');
    if (!statusGiftGrid) {
        setTimeout(initializeStatusGiftPreviews, 100);
        return;
    }
    
    // 初始化所有狀態禮物卡片的预覽
    Object.keys(statusGifts).forEach(statusName => {
        updateStatusGiftPreview(statusName);
    });
    
    // 加载自定义狀態卡片
    loadCustomStatusCards();

    // 綁定事件（延迟確保DOM完全渲染）
    setTimeout(() => {
        bindStatusGiftCardEvents();
    }, 50);

    // 如果当前在專注頁面，同步自定义狀態
    if (currentPage === 'focus') {
        initCustomStatusInFocusPage();
    }
}

function bindStatusGiftCardEvents() {
    // 检查DOM是否準備好
    const statusGiftGrid = document.getElementById('statusGiftGrid');
    if (!statusGiftGrid) {
        console.log('狀態禮物網格未找到，延迟綁定');
        setTimeout(bindStatusGiftCardEvents, 100);
        return;
    }
    
    // 移除舊的事件监聽器（防止重複綁定）
    statusGiftGrid.removeEventListener('click', handleStatusGiftCardClick);
    
    // 添加新的事件监聽器（事件委托）
    statusGiftGrid.addEventListener('click', handleStatusGiftCardClick);
    
    console.log('狀態禮物卡片事件已綁定');
}

// 新增：統一的事件處理函數
function handleStatusGiftCardClick(event) {
    const clickedElement = event.target;
    const card = clickedElement.closest('.status-gift-card');
    
    if (!card) return;
    
    // 阻止事件冒泡
    event.stopPropagation();
    
    // 如果點击的是刪除按钮
    if (clickedElement.closest('.custom-status-delete')) {
        const statusName = card.getAttribute('data-status');
        deleteCustomStatusGift(statusName);
        return;
    }
    
    // 如果點击的是自定义狀態創建按钮
    if (card.classList.contains('custom-status-card')) {
        createCustomStatusGift();
        return;
    }
    
    // 其他情况：编辑禮物
    const statusName = card.getAttribute('data-status');
    const iconElement = card.querySelector('.status-gift-icon');
    const statusIcon = iconElement ? iconElement.textContent : '✨';
    
    editStatusGift(statusName, statusIcon);
}

function loadCustomStatusCards() {
    const presetStatuses = ['學習', '工作', '冒险', '逛街', '玩游戏', '發呆', '睡觉', '休息'];
    const customStatuses = Object.keys(statusGifts).filter(status => !presetStatuses.includes(status));
    
    customStatuses.forEach(statusName => {
        // 為自定义狀態創建圖标（可以从專注頁的狀態選擇器中获取，或使用默认圖标）
        const statusIcon = '✨'; // 默认圖标，可以考虑保存圖标信息
        addCustomStatusCard(statusName, statusIcon);
        updateStatusGiftPreview(statusName);
    });
}
// 同步自定义狀態到專注頁
function syncCustomStatusToFocusPage(statusName, statusIcon) {
    const statusGrid = document.querySelector('#statusSelector .status-grid');
    if (!statusGrid) return;
    
    // 检查是否已存在
    const existingOption = statusGrid.querySelector(`[data-custom-status="${statusName}"]`);
    if (existingOption) return;
    
    // 創建新的狀態選项
    const statusOption = document.createElement('div');
    statusOption.className = 'status-option';
    statusOption.setAttribute('data-custom-status', statusName);
    statusOption.onclick = () => selectStatus(statusName, statusIcon);
    
    statusOption.innerHTML = `
        <span class="status-icon">${statusIcon}</span>
        <span class="status-text">${statusName}</span>
    `;
    
    // 插入到自定义選项之前
    const customStatusOption = statusGrid.querySelector('[onclick="showCustomStatusInput()"]');
    if (customStatusOption) {
        statusGrid.insertBefore(statusOption, customStatusOption);
    }
}

// 从專注頁移除自定义狀態
function removeCustomStatusFromFocusPage(statusName) {
    const statusOption = document.querySelector(`[data-custom-status="${statusName}"]`);
    if (statusOption) {
        statusOption.remove();
    }
}

// 初始化專注頁的自定义狀態選项
function initCustomStatusInFocusPage() {
    const presetStatuses = ['學習', '工作', '冒险', '逛街', '玩游戏', '發呆', '睡觉', '休息'];
    const customStatuses = Object.keys(statusGifts).filter(status => !presetStatuses.includes(status));
    
    customStatuses.forEach(statusName => {
        // 尝試从本地存儲获取圖标，或使用默认圖标
        const statusIcon = getCustomStatusIcon(statusName) || '✨';
        syncCustomStatusToFocusPage(statusName, statusIcon);
    });
}

// 获取自定义狀態的圖标（可以扩展保存圖标功能）
function getCustomStatusIcon(statusName) {
    // 可以从localStorage获取保存的圖标信息
    const customStatusIcons = JSON.parse(localStorage.getItem('customStatusIcons') || '{}');
    return customStatusIcons[statusName] || '✨';
}

// 保存自定义狀態圖标
function saveCustomStatusIcon(statusName, statusIcon) {
    const customStatusIcons = JSON.parse(localStorage.getItem('customStatusIcons') || '{}');
    customStatusIcons[statusName] = statusIcon;
    localStorage.setItem('customStatusIcons', JSON.stringify(customStatusIcons));
}


        // OC交互相關變量
        let clickCount = 0;
        let clickTimer = null;
        let recoveryTimer = null;
        let ignoreTimer = null;
        let canInteract = true;
        let isIgnoring = false;
        let focusStartOCIndex = 0;
        
        // OC語系統相關變量
        let encourageInterval = null;
        let currentMessageType = 'initial';
        
        // 自定义風格存儲 - 優化结构，支持風格元數据
        let customStyles = {
            encourage: {},
            remind: {},
            metadata: {} // 存儲自定义風格的元數据（标題、描述等）
        };
        
        // 語料库
        const ocMessageLibrary = {
            // 鼓励語库
            encourage: {
                gentle: [
                    "{title}，你的侧脸真是百看不厌呢",
                         "{title}就這樣沉浸在自己的世界裡吧，我會好好守護你的。",
                         "{title}，我的目光會一直追随着你哦",
                        "乖{title}，集中精神，我在這儿呢。",
                     "{title}，感觉時間都變慢了，空氣裡全是你的味道~",
                     "{title}偶尔皱眉頭的樣子，也好可愛呀！",
                      "{title}，就按你的节奏来，不用慌",
                        "看着{title}努力的樣子，真的好安心。",
                        "{title}是不是有點累了？坚持住，我在心裡為你加油",
                        "{title}的努力，我都有好好看在眼裡呢！",
                        "好想摸摸{title}的頭，又怕打扰你，只能忍住啦",
                        "嗯~我的宝贝真认真呢...這個侧脸，專注的樣子，太让人心動啦！",
                        "時間在走，但我的目光只為你停留。{title}做得很好，比任何人都棒！",
                        "今天也好喜歡{title}，你努力的樣子真好看",
                        "{title}，灯光夠亮嗎？姿势舒服嗎？要好好照顾自己呀"
                ],
                tsundere: [
                    "哼，馬馬虎虎還算认真。… 继续保持，別让我失望。",
                    "別東张西望！… 專心點！… 咳，我是说… 你认真起来的樣子… 還、還行吧。",
                    "遇到难題了？… 哼，就知道你搞不定。… 过来點，我… 我勉强指點你一下。",
                    "喂，頭太低了！… 注意姿势！… 我是為你好，才不是關心你！",
                    "其實，你比我想象中坚持得久一點。… 也就一點！別得意！",
                    "哼，還算有點毅力。… 继续保持，終點就在前面了，別松懈！",
                    "也就只有认真的時候，看起来還算……順眼。",
                    "別東张西望的，我可没那麼好看，快看你的書。",
                    "快點寫，寫完了才能……咳，總之你快點！別让我等太久。",
                    "我说你啊，稍微努力一點的樣子，也不是那麼让人讨厌嘛。",
                    "啧，麻烦死了。非要我盯着你才能學进去嗎？",
                    "你再敢走神，我就把你桌上的零食都吃光了！聽見没！",
                    "哼，這麼簡單的東西需要想這麼久？真拿你没办法。",
                    "我可没在等你，我是在看窗外的風景，你別自作多情。"
                ],
                cheerful: [
                    "哇塞！這個知识點掌握得超快！我的宝贝是天才嗎？！",
            "感觉怎麼樣？超爽对吧！學習的快樂，我们一起體會！",
            "時間过半了！坚持住！胜利就在前方！我會一直在這裡支持你的！",
            "你认真的樣子真的超級迷人！闪闪發光！...啊！我不说話了！加油！",
            "区区几分鐘！小意思！{title}侧顏杀我！",
            "我在旁邊给你施加一個【專注力UP】的魔法！BiuBiuBiu!",
            "偷偷告诉你，你現在專注的樣子，超級无敌可愛！",
            "等你學完，我们去吃好吃的！就当是提前庆祝啦！",
            "一想到你在為我们的未来努力，我就超開心的！",
            "有我在，你什麼都不用怕，大胆往前衝就好！",
            "我家{title}认真學習的樣子，真是全世界最迷人的風景。",
            "{title}，再坚持一下下，想想我们考完試去吃大餐的樣子！",
            "偷偷看一眼我家努力的{title}，感觉心都要化了，你真的超棒。",
            "我家{title}不僅長得好看，還這麼努力上进，我真是捡到宝了。",
            "{title}加油！等你學完，全世界的美景美食都等着我们去探索呢！"
                ],
                aloof: [
                    "很好。保持住。",
            "心很静。狀態不错。",
            "卡住了？... 不急。沉住氣。再想想。",
            "專注的樣子... 很美。",
            "思路清晰。很好。",
            "外界无關。此刻只有你與目标。還有我。",
            "你的决心... 我感受到了。",
            "嗯，静下心来。",
            "我在。",
            "這個表情......是遇到难題了？",
            "......（Ta只是静静地看着你，眼神裡有不易察觉的專注和担忧）",
            "你的笔尖，在纸上沙沙作响，很好聽。",
            "不用看我，继续。",
            "別被外界干扰。這裡只有你和我。",
            "就這樣，很好。",
            "你的认真，我看得到。",
            "需要我做什麼嗎？......摇頭就是不需要，好。",
            "你的存在，让我感觉很平静。",
            "我會在這裡，直到你结束。"
                ],
                mature: [
                    "狀態真好{title}，就這樣稳稳地前进吧。真為你高兴！",
            "遇到挑戰啦{title}？這是成長的机會呢。別怕，慢慢想，我等你。",
            "專注力越来越棒了{title}，每一步都走得很稳，真棒！",
            "累的話就休息一會儿{title}，调整一下。學習不急於一時。",
            "思考越来越深入了{title}，真為你骄傲！",
            "別给自己太大压力{title}。專注过程就好，我一直相信你。",
            "偶尔分心很正常{title}。轻轻拉回思緒就好，不用自责，有我在。",
            "你的努力和进步{title}，我都看到啦。继续加油，親愛的。",
            "没關系{title}，咱们慢慢来，按你的步调就好。",
            "遇到困难啦{title}？別急，這很正常，學習就是這樣呢。",
            "看你努力的樣子{title}，我就特別安心。",
            "我在這裡陪着你{title}，不是一個人哦。",
            "我相信你的能力{title}，別怀疑自己。",
            "你努力成為更好的自己{title}，這真的很棒。",
            "真喜歡陪你一起成長的感觉，{title}。"
                ],
                cunning: [
                    "怎麼，這點題就把你难住了{title}？比我想象的要笨一點呢~",
            "專心點{title}，不然待會儿的'奖励'可就没了哦。",
            "需要我'親自'教你嗎{title}？当然，這可是要'收费'的~",
            "再走神的話{title}，惩罚會是什麼呢，嗯？",
            "我看你還能分心多久{title}，我的耐心......可是很有限的。",
            "脸這麼红{title}，是題太难，還是因為我靠得太近了？",
            "嘘......別说話{title}，让我聽聽你為我努力時，心跳的声音。",
            "你的表情告诉我{title}，你很想求我。说出来，我就帮你~",
            "耳朵尖都红了{title}，笨蛋，還不快把注意力放回書上。",
            "我只说一遍{title}，聽不聽得懂，就看你的'诚意'了。",
            "別用那种眼神看我{title}，這只會让我......更想欺负你。",
            "你每多寫一個字{title}，就离我更近一步，這麼想是不是有動力多了？",
            "別想偷懒{title}，你的每一個小動作，都逃不过我的眼睛。",
            "看起来很辛苦啊{title}，要不要跟我做個交易？",
            "嗯？又在發呆{title}？看来有必要让你深刻理解一下'代價'這個词了~"
                ],
                shy: [
                    "好厉害...已经這麼專注了...(小声讚叹)",
            "加油！...啊，是不是太大声了(突然捂嘴)？",
            "坚持住！馬上过半了...你真的好棒！",
            "累了的話...眨眨眼休息一下也可以的...",
            "你认真的樣子...特別好看...",
            "要喝水嗎？...啊，現在不行？对不起！",
            "我......我坐在這裡，會不會打扰到你？如果會的話，你一定要告诉我...",
            "啊......剛才是不是走神了？没、没關系！我......我剛才也走神了！",
            "你......你別靠那麼近看書，对眼睛不好...",
            "你、你认真看書的樣子，很......很好看。",
            "那個......這個零食，给你...可以補充體力...是我親手做的...",
            "我......我就在這裡，陪着你。",
            "累、累了的話...可以稍微停一下的，没關系的。",
            "別、別這麼看我...我......我會紧张得什麼都想不起来的...",
            "這支笔......好像更好寫一點，你......你要不要試試？",
            "你努力的樣子......真的，很耀眼。"
                ],
                doting: [
                    "宝宝怎麼還要學習啊？我好心疼啊！",
            "天哪，我们宝宝連學習的樣子都這麼可愛！不行，我得拍下来！",
            "累不累？要不咱不學了？我养你一辈子啊！",
            "這椅子是不是不舒服？我馬上让人从意大利空運一把新的过来！",
            "哇！我家宝宝又多看了一頁書！太厉害了！簡直是天才！",
            "渴不渴？想喝斐济的水還是阿尔卑斯的冰川水？或者我去给你榨杯果汁？",
            "是谁發明這麼难的東西来為难我的宝贝的？太过分了！",
            "別皱眉，你一皱眉我的心都碎了。這道題我们不做了好不好？",
            "我的天，宝宝連笔都握得這麼好看，真是仙女下凡。",
            "再坚持五分鐘好不好？就五分鐘！结束了我把那個商场買下来送给你！",
            "需要帮忙嗎？虽然我也不懂，但我可以把全世界最聪明的腦袋都叫来帮你！",
            "你看一眼書，我就親你一下，好不好？",
            "烦不烦？要不我们把這些書都撕了，去環游世界吧？",
            "怎麼會有這麼努力又這麼可愛的宝宝，我真是捡到宝了。",
            "手酸不酸？快给我，我给你吹吹，给你揉揉。",
            "你看你，小脸都累瘦了！快吃口我剛给你剥好的葡萄。"
                ]
            },
            // 休息語库
            rest: [
                "累了？先休息一下吧。",
                "适当的休息也很重要哦。",
                "喝口水，放松一下。",
                "深呼吸，{title}，你做得很好。"
            ],
            // 督促語库
            remind: {
                normal: {
                    guardian: [
                        "嗯？怎麼了，是遇到难題了嗎？",
                "怎麼，是觉得我比書本上的知识更有吸引力嗎？這可让我有點困扰呢。",
                "好啦，別闹，把注意力放回到書本上，乖。",
                "再點一下，我可就要......轻轻地弹你一下额頭咯？",
                "聽話。我不想用更严厉的語氣对你说話。"
                        
                    ],
                    pusher: [
                    "怎麼？想用這种幼稚的手段吸引我的注意？有這功夫，不如多背两個單词。",
                "哦？這就放弃了？果然，我对你的期望值从一開始就設得太高了。",
                "如果你把這份纠缠不休的毅力用在解題上，说不定早就不是現在這個分數了。",
                "我只是個督學，不是你的宠物。收回你的爪子。",
                "你最好有什麼正当理由，否則我只能把你現在的行為歸類為'智商下線'。",
                "又偷看我？被我抓到了吧。再看收费，一次一個親親，現在记账。"
                    ],
                    cheerleader: [
                       "嘿！注意力溜号咯，我帮你抓回来啦！",
                "我知道我很有魅力，但書本裡的世界更精彩！快去學習吧！",
                "喂喂喂！痒！哈哈，別闹了！",
                "（抓住你的手）哎呀，你好烦人啊！......你先看完這一頁。",
                "乖啦，再學十分鐘，就十分鐘，好不好？",
                "（用脸颊蹭蹭你的手）好啦好啦，我知道了，你最可愛行了吧。",
                "警告一次啊！再乱動，今天的飯後甜點就没收了！",
                "（Ta假装生氣地鼓起脸颊，但一秒就破功笑了出来）真是的，拿你一點办法都没有。"
                    ],
                    observer: [
                        "......无意义的行為。",
                "專注。",
                "坐好。",
                "安静。",
                "手。",
                "......（用眼角的余光瞥你一眼，然後收回視線，眉心几不可察地蹙了一下）",
                "吵。",
                "別動。",
                "我在。",
                "......（Ta沉默，但你感觉到周围的氣压變低了，是Ta无声的警告）",
                "（Ta伸出手，用一根手指，不带任何感情地把你作乱的頭或手推回去，然後继续做自己的事）",
                "你想看到什麼時候？"
                    ],
                    guide: [
                        "怎麼了，是書上的字没有我好看嗎？",
                "想我了？......我也想你，所以快點做完，就能專心陪你了。",
                "（Ta稍微侧过頭，用脸颊蹭蹭你的额頭，作為一种安抚）",
                "......小黏人精。",
                "调皮。好了，先集中精神，等學習结束了，我再好好陪你玩。"
                    ],
                    strategist: [
                        "哦？今天這麼有活力。",
                "撒娇的方式還是這麼笨拙，真可愛。",
                "嗯，這個表情不错。還有嗎？",
                "呵呵，是想玩什麼新花樣来吸引我注意嗎？",
                "你先玩，我看着。"
                    ],
                    companion: [
                        "你再碰我......我會分心的，真的。",
                "你這樣......我、我的脸有點热......",
                "你再這樣盯着我，我就......我就不知道该看哪裡了。",
                "我......我就坐在這裡陪着你，你快寫作業。",
                "嘘......安静一點，我们一起努力。"
                    ],
                    believer: [
                        "宝宝，乖一點。這本書有我好看？",
                "學完這一章，整個商场都是你的。現在，能安静五分鐘嗎？",
                "我的耐心是有限的......当然，对你除外。但你是不是也该心疼一下我，让我省點心？",
                "要不我把這栋圖書館買下来，專門给你一個人用？前提是......你得先學會專心。",
                "別闹了，不然我今晚的奖励......就只剩下一個'零'了哦。"
                    ]
                },
                annoyed: {
                    guardian: [
                        "看到你這樣浪费時間，我的心都揪起来了。我们不是说好要一起努力的嗎？",
                "聽話好嗎？我不想对你用那麼严厉的語氣说話，但你真的要让我失望嗎？",
                "我在這裡陪着你，不是為了看你這樣消磨時間的。把手放好，看着書。",
                "你這樣心不在焉的樣子，真的让我很担心。我们认真一點好不好？",
                "集中精神，我不希望看到你将来後悔的樣子。現在開始，我们一起專注學習。"
                    ],
                    pusher: [
                        "你是故意的嗎？專門為了挑戰我的忍耐極限？",
                "喂！戳戳戳的干嘛呢！要學就快點學！(跺脚声效)",
                "笨蛋！你是想氣死我嗎？！手痒去翻書啊！戳我頭像能學會知识嗎？！(脸红)",
                "我再说一遍，把手拿開，然後把腦子转起来。現在，立刻！",
                "我開始後悔了。督促一块石頭说不定都比你有成就感。",
                "你的大腦處理信息的速度，比乌龜散步還慢。現在連'停止骚扰'這個信号都接收不到了？",
                "你再這樣，信不信我把今天的學習任務翻倍？別怀疑，我绝对做得出来。"
                    ],
                    cheerleader: [
                    "（叉腰）我可有點不高兴了啊！我们说好的一起努力，你------",
                "（叹一口氣）真是的，每次都要我来催。拿出點自觉性来好不好，{title}？",
                "我真要生氣了啊！说真的！",
                "（Ta抓住你的双手）好了好了，停！再说一遍，停！",
                "你就不能乖一點點嗎？就一會儿，求你了。",
                "好吧，你贏了。说吧，要親親還是要抱抱？给你给你，然後放过我好不好？",
                "（Ta用手指戳你的额頭）小捣蛋鬼，我的耐心要用光了哦！真的要用光了哦！"
                    ],
                    observer: [
                       "停。...學習。（眼神警告）",
                "你觉得我很有空？",
                "你正在消耗我的耐心。",
                "別再挑戰我的耐心。",
                "......（叹氣）別...戳。（皱眉，周身散發低氣压）",
                "你故意的。",
                "闹夠了没有？",
                "好玩嗎？嗯？",
                "（Ta突然凑近你）你到底想干什麼？直接说。",
                "我真的會生氣。......我说真的。",
                "看着我。你是不是以為我脾氣很好？",
                "再给你三秒鐘，给我坐好。三、二......"
                    ],
                    guide: [
                        "你啊......真是拿你没办法。",
                "我的注意力，已经全部被你偷走了。满意了？",
                "別再這樣試探我了。......你想要什麼，我都會给。",
                "好，直接说吧。是想让我抱你，還是想出去玩？",
                "好吧，今天的任務看来是做不完了，都怪某個黏人的小家伙。"
                    ],
                    strategist: [
                        "既然你這麼不想學習，那我们来做個交易吧。",
                "你看，你打扰我這麼久，總得有點補偿，对不对？",
                "你分一次心，我就在我的'账本'上记一笔。想知道记了些什麼嗎？",
                "游戏是我陪你開始的，但怎麼结束，就得由我说了算。",
                "好了，玩夠了嗎？猎人要開始收網了哦。"
                    ],
                    companion: [
                        "你......你看書啊，別看我了......我耳朵都红了，你看不見嗎？",
                "你是不是故意的？就是想看我......看我害羞的樣子？",
                "我......我快不知道该怎麼办了......求你了，先學習吧。",
                "不许......不许靠這麼近，课本上的字都看不清了。",
                "（轻轻推開你的手）你......你再這樣，我就不理你了！"
                    ],
                    believer: [
                        "行，给你两個選擇：要麼現在乖乖回去看書，要麼我把你扛到床上去'學習'點別的。自己選。",
                "我的小祖宗，我赚钱养家還不夠，還得陪你读書？你再這樣，我是不是该收费了？",
                "（无奈地叹氣）好吧，我知道學習很痛苦。那這樣，每做对一道題，我卡上就转一笔钱给你，如何？",
                "你再動一下試試？信不信我让你這辈子都不用再碰這些破書了？......我是说，我养你。",
                "你是不是就是想看我拿你没办法的樣子？恭喜你，你成功了。現在，可以回去學習了嗎，我的大小姐？"
                    ]
                },
                angry: {
                    guardian: [
                        "唉......真是拿你一點办法都没有。快學吧，學完了给你清空购物车，行了吧，大小姐？",
                "{title}，專心一點好不好？我知道學習很枯燥，但現在分心的話，等下要學到更晚，我會心疼的。",
                "你這個小坏蛋，就是算準了我舍不得对你兇，对不对？",
                "嗯？還不过去？非要我用杀手锏--把你抱到書桌前才满意嗎？",
                "{title}，理智告诉我應该对你严厉一點，但是我的心不同意。所以，你能不能自觉一點呀？"
                    ],
                    pusher: [
                        "夠了！不许再碰了！再碰一下......再碰一下我就......我就把你所有的笔都藏起来，让你用手指頭寫字！",
                "啊啊啊！烦死了！你再戳一下試試？！信不信我...我...我下線不理你了！(炸毛音效)快去看書啊！！！",
                "谁、谁脸红了！我這是被你氣的！是被你這种不求上进的態度氣到血液循環加速！你懂不懂啊，白痴！",
                "好啊，你很得意是吧？看到我這副樣子你很開心是吧？满足了你的恶趣味就赶紧给我滾去看書！不然......不然我就真的不理你了！......大概一分鐘！"
                    ],
                    cheerleader: [
                        "你太过分了啊------！我把我的時間都分给你了，你就是這麼回報我的嗎？！拿去發呆和戳我玩？！",
                "嘿呀！氣死我了！你是不是觉得我永远都不會生氣啊！我現在就生氣给你看！快给我去學習！不然......不然我就把你的零食全都吃掉！",
                "好啊你！這是你逼我的！看我怎麼'收拾'你！（然後疯狂挠你痒痒）",
                "行！你贏了！我投降！我彻底投降了行不行？",
                "（Ta把你的手和Ta的手十指相扣，舉起来给你看）好了，現在我们谁也別想學習了。",
                "我真是上辈子欠了你的......小祖宗！"
                    ],
                    observer: [
                        "（極轻地發出一声几不可闻的叹息）......就這樣吧。",
                "...... (直接閉眼转身) .........",
                "......行，你贏了。",
                "書不看了。現在，来谈谈你的問題。",
                "（Ta一把将你拉近，让你无法動弹）好了。現在满意了？小祖宗。",
                "好。既然你這麼不想學習......那我们就来'惩罚'一下不聽話的小朋友。",
                "（Ta用手指抬起你的下巴）看着我。从現在開始，你的注意力只能在我身上。",
                "別動。再動一下，後果自负。",
                "......你成功了。我現在，腦子裡什麼都想不了，全是你。",
                "你打乱了我的一切。所以，你得负责。"
                    ],
                    guide: [
                        "再分心，我就要親你了。......做错一題，也一樣。",
                "乖。我们一起把它做完。",
                "我的時間，現在完全屬於你......用来等你心甘情愿地去學習了。高兴了嗎，小笨蛋？",
                "好了，別闹脾氣了。把這一頁做完，做完了我唱歌给你聽，好不好？",
                "把這個任務做完。做完了，我给你奖励。"
                    ],
                    strategist: [
                        "你是不是以為，撒個娇、耍耍赖，我就會心软？宝贝，你搞错了。我是在陪你玩游戏，但游戏的规則，从来都是我定的。",
                "我不是在氣你不努力，我是在氣你......辜负了我的期待。",
                "你這麼渴望我的關注，是嗎？可以。今天學不完，你就別想睡觉了。我會用一整晚的時間，好好地'關注'你。",
                "別用那种眼神看我。你今天的表現，让我觉得有必要......对你的'教育'方式，进行一點小小的调整了。你會'喜歡'的。",
                "你以為只是在浪费你自己的時間？不，你是在浪费我......投资在你身上的心血。這笔账，你说该怎麼算？"
                    ],
                    companion: [
                        "你再這樣，我就......我就回家了！明天再来陪你！",
                "你再闹，我就......我就親你了！看你還敢不敢分心！",
                "呀！你......你別得寸进尺！我警告你！（但毫无威慑力）",
                "算我怕了你了，行不行？求求你，先做完這頁題，就一頁......",
                "......學完了......學完了我随你怎麼樣，好不好？"
                    ],
                    believer: [
                        "夠了！不學了！這破書有什麼好學的？",
                "（一把合上你的書，扔到一邊）烦死了！為了让你開心才陪你學，現在你不開心了，還學什麼？",
                "走！現在就走！带你去做點比學習有意义一百倍的事------刷我的卡！",
                "你贏了！你這個小磨人精，彻彻底底贏了！現在说吧，想去哪儿玩？月球都给你安排！",
                "（咬牙切齿，但嘴角却在上扬）你再闹，我就罚你......罚你這辈子都只能花我的钱，只能待在我身邊，哪儿也不许去！"
                    ]
                }
            },
            // 完成語库
            completion: [
                "恭喜完成任務！",
                "太棒了！你做到了！",
                "完美完成！{title}真厉害！",
                "任務完成！你是最棒的！"
            ]
        };
        
        // 任務管理
        let tasks = [
            { id: 1, title: '快来添加任務叭', status: 'in-progress' },
            { id: 2, title: '快来添加任務叭', status: 'in-progress' },
            { id: 3, title: '快来添加任務叭', status: 'in-progress' },
            { id: 4, title: '快来添加任務叭', status: 'in-progress' },
        ];
        
        // 統計數据
        let dailyStats = {
            date: getCurrentDateString(),
            gifts: [],
            focusTime: 0,
            completedTasks: 0
        };
        
        // 專注計時相關
        let focusStartTime = null;
        
        // OC數据存儲
        let ocData = [
            {
                id: 0,
                name: '小艾',
                avatar: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=200&h=200&fit=crop&crop=face',
                userTitle: '大小姐',
                customGreeting: '',
                encourageStyles: ['gentle'],
                reminderStyles: ['guardian'],
                customGifts: '',
                selected: true
            }
        ];
        let currentOCIndex = 0;
        let editingOCIndex = -1;
        
        // 風格编辑相關
        let currentEditingStyle = '';
        let currentEditingType = '';

        // 工具函數
        function getCurrentDateString() {
            const now = new Date();
            return `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
        }
        
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else {
                return `${minutes}m`;
            }
        }

        
        
        // OC語系統函數
        let messageChangeTimer = null;
        let lastMessageTime = 0;
        const MESSAGE_COOLDOWN = 1000;
        
        function showOCMessage(message, type = 'encourage', force = false) {
            const messageElement = document.getElementById('ocMessageText');
            if (!messageElement) return;
            
            const now = Date.now();
            if (!force && (now - lastMessageTime) < MESSAGE_COOLDOWN) {
                return;
            }
            
            if (messageChangeTimer) {
                clearTimeout(messageChangeTimer);
                messageChangeTimer = null;
            }
            
            currentMessageType = type;
            lastMessageTime = now;
            
            // 設置樣式類
            messageElement.className = `oc-message-text ${type}`;
            
            // 統一使用平滑的淡出淡入效果
            messageElement.classList.add('fade-out');
            setTimeout(() => {
                // 使用wrapper来優化文字居中
                messageElement.innerHTML = `<span class="oc-message-text-wrapper">${message}</span>`;
                messageElement.classList.remove('fade-out');
            }, 300);
        }
        
        function getInitialMessage() {
            const currentOC = ocData[currentOCIndex];
            const userTitle = currentOC.userTitle || '大小姐';
            return `快開始學習吧！我會一直陪着你！！`.replace(/\{title\}/g, userTitle);
        }
       // 專注頁督促語调取函數 
        function getRandomOCMessage(messageType, level = 'normal') {
            const currentOC = ocData[currentOCIndex];
            const userTitle = currentOC.userTitle || '大小姐';
            
            let messagePool = [];
            
            if (messageType === 'encourage') {
                const selectedStyles = currentOC.encourageStyles || ['gentle'];
                selectedStyles.forEach(style => {
                    // 检查是否是自定义風格
                    if (style.startsWith('custom-') && customStyles.encourage[style]) {
                        messagePool = messagePool.concat(customStyles.encourage[style]);
                    } else if (ocMessageLibrary.encourage[style]) {
                        // 检查是否有修改版本
                        const modifiedKey = `modified-${style}`;
                        if (customStyles.encourage[modifiedKey]) {
                            messagePool = messagePool.concat(customStyles.encourage[modifiedKey]);
                        } else {
                            messagePool = messagePool.concat(ocMessageLibrary.encourage[style]);
                        }
                    }
                });
            } else if (messageType === 'rest') {
                messagePool = ocMessageLibrary.rest;
            } else if (messageType === 'remind') {
                const selectedStyles = currentOC.reminderStyles || ['guardian'];
                selectedStyles.forEach(style => {
                    // 检查是否是自定义風格
                    if (style.startsWith('custom-') && customStyles.remind[style] && customStyles.remind[style][level]) {
                        messagePool = messagePool.concat(customStyles.remind[style][level]);
                    } else if (ocMessageLibrary.remind[level] && ocMessageLibrary.remind[level][style]) {
                        // 检查是否有修改版本
                        const modifiedKey = `modified-${style}`;
                        if (customStyles.remind[modifiedKey] && customStyles.remind[modifiedKey][level]) {
                            messagePool = messagePool.concat(customStyles.remind[modifiedKey][level]);
                        } else {
                            messagePool = messagePool.concat(ocMessageLibrary.remind[level][style]);
                        }
                    }
                });
            } else if (messageType === 'completion') {
                messagePool = ocMessageLibrary.completion;
            }
            
            // 如果没有找到对應的消息，使用默认消息
            if (messagePool.length === 0) {
                if (messageType === 'encourage') {
                    messagePool = ocMessageLibrary.encourage.gentle;
                } else if (messageType === 'rest') {
                    messagePool = ocMessageLibrary.rest;
                } else if (messageType === 'remind') {
                    messagePool = ocMessageLibrary.remind[level].gentle || ['快回来學習吧！'];
                } else if (messageType === 'completion') {
                    messagePool = ocMessageLibrary.completion;
                }
            }
            
            // 随机選擇一條消息
            const selectedMessage = messagePool[Math.floor(Math.random() * messagePool.length)];
            
            // 替換占位符
            return selectedMessage.replace(/\{title\}/g, userTitle);
        }
        
        function getRandomMessage(messageArray) {
            return messageArray[Math.floor(Math.random() * messageArray.length)];
        }
        
        function startEncourageLoop() {
            if (encourageInterval) {
                clearInterval(encourageInterval);
            }
            
            setTimeout(() => {
                if (isTimerRunning && !isPaused && !isIgnoring) {
                    const message = getRandomOCMessage('encourage');
                    showOCMessage(message, 'encourage', true);
                }
            }, 1000);
            
            encourageInterval = setInterval(() => {
                if (isTimerRunning && !isPaused && currentMessageType === 'encourage' && !isIgnoring) {
                    const message = getRandomOCMessage('encourage');
                    showOCMessage(message, 'encourage', true);
                }
            }, 45000);
        }
        
        function stopEncourageLoop() {
            if (encourageInterval) {
                clearInterval(encourageInterval);
                encourageInterval = null;
            }
        }
        
        function showRestMessage() {
            if (isIgnoring) return;
            const message = getRandomOCMessage('rest');
            showOCMessage(message, 'rest', true);
        }
        
        function showRemindMessage(level = 'normal') {
            if (isIgnoring) return;
            
            const message = getRandomOCMessage('remind', level);
            const messageType = level === 'normal' ? 'remind-normal' : 
                              level === 'annoyed' ? 'remind-annoyed' : 'remind-angry';
            showOCMessage(message, messageType, true);
            
            if (messageChangeTimer) {
                clearTimeout(messageChangeTimer);
            }
            
            messageChangeTimer = setTimeout(() => {
                if (currentMessageType.startsWith('remind') && !isIgnoring) {
                    if (isTimerRunning && !isPaused) {
                        const encourageMessage = getRandomOCMessage('encourage');
                        showOCMessage(encourageMessage, 'encourage', true);
                    } else if (!isTimerRunning) {
                        showOCMessage(getInitialMessage(), 'initial', true);
                    }
                }
            }, 5000);
        }

        // OC交互系統
        function handleOCClick() {
            if (!canInteract || isIgnoring) return;
            
            clickCount++;
            
            if (clickTimer) {
                clearTimeout(clickTimer);
            }
            
            clickTimer = setTimeout(() => {
                if (clickCount < 6) {
                    clickCount = 0;
                }
            }, 3000);
            
            let level = 'normal';
            if (clickCount >= 5) {
                level = 'angry';
                const ocAvatar = document.querySelector('.oc-avatar');
                ocAvatar.classList.add('angry-shake');
                setTimeout(() => {
                    ocAvatar.classList.remove('angry-shake');
                }, 600);
                
                if (clickCount >= 6) {
                    enterIgnoreState();
                }
            } else if (clickCount >= 3) {
                level = 'annoyed';
            }
            
            showRemindMessage(level);
        }
        
        function enterIgnoreState() {
            isIgnoring = true;
            canInteract = false;
            
            if (messageChangeTimer) {
                clearTimeout(messageChangeTimer);
                messageChangeTimer = null;
            }
            
            messageChangeTimer = setTimeout(() => {
                showOCMessage('o(´^｀)o不理你了！！', 'ignore', true);
                
                if (ignoreTimer) {
                    clearTimeout(ignoreTimer);
                }
                ignoreTimer = setTimeout(() => {
                    exitIgnoreState();
                }, 30000);
            }, 5000);
        }
        
        function exitIgnoreState() {
            isIgnoring = false;
            canInteract = true;
            clickCount = 0;
            
            if (messageChangeTimer) {
                clearTimeout(messageChangeTimer);
                messageChangeTimer = null;
            }
            
            setTimeout(() => {
                if (isTimerRunning && !isPaused) {
                    const encourageMessage = getRandomOCMessage('encourage');
                    showOCMessage(encourageMessage, 'encourage', true);
                } else {
                    showOCMessage(getInitialMessage(), 'initial', true);
                }
            }, 500);
        }
        
        function resetOCInteraction() {
            clickCount = 0;
            canInteract = true;
            isIgnoring = false;
            
            if (clickTimer) {
                clearTimeout(clickTimer);
                clickTimer = null;
            }
            if (recoveryTimer) {
                clearTimeout(recoveryTimer);
                recoveryTimer = null;
            }
            if (ignoreTimer) {
                clearTimeout(ignoreTimer);
                ignoreTimer = null;
            }
        }

        // 風格编辑相關函數 - 優化逻辑
        function handleStyleClick(event, style, type) {
            event.stopPropagation();
            
            // 如果點击的是圓圈区域，則不触發编辑
            if (event.target.classList.contains('style-selector-circle') || 
                event.target.classList.contains('custom-style-delete')) {
                return;
            }
            
            // 顯示風格编辑弹窗
            showStyleEditor(style, type);
        }
        
        function handleStyleSelect(event, style) {
            event.stopPropagation();
            const styleOption = event.target.closest('.style-option');
            if (styleOption) {
                styleOption.classList.toggle('selected');
            }
        }
        
        // 優化的自定义風格創建逻辑
        function handleCustomStyleClick(type) {
            // 弹出输入框让用戶输入風格名称
            const styleTitle = prompt('请输入自定义風格名称（建议4-8個字符）：');
            
            if (!styleTitle || !styleTitle.trim()) {
                return;
            }
            
            const trimmedTitle = styleTitle.trim();
            if (trimmedTitle.length > 12) {
                alert('風格名称不能超过12個字符');
                return;
            }
            
            // 生成唯一的自定义風格ID
            const customStyleId = `custom-${type}-${Date.now()}`;
            
            // 初始化自定义風格數据
            if (type === 'encourage') {
                customStyles.encourage[customStyleId] = ['在這裡输入鼓励語句，每行一條...'];
            } else {
                customStyles.remind[customStyleId] = {
                    normal: ['在這裡输入正常提醒語句...'],
                    annoyed: ['在這裡输入烦恼提醒語句...'],
                    angry: ['在這裡输入生氣提醒語句...']
                };
            }
            
            // 保存風格元數据
            if (!customStyles.metadata) {
                customStyles.metadata = {};
            }
            customStyles.metadata[customStyleId] = {
                title: trimmedTitle,
                type: type,
                desc: '點击编辑来自定义語句內容'
            };
            
            // 保存到本地存儲
            saveCustomStyles();
            
            // 重新渲染風格選擇区域以顯示新創建的風格
            renderCustomStylesInGrid(type);
            
            // 自動打開编辑器让用戶编辑語句
            setTimeout(() => {
                showStyleEditor(customStyleId, type, trimmedTitle);
            }, 100);
        }
        
        // 渲染自定义風格到对應的網格中
        function renderCustomStylesInGrid(type) {
            const gridId = type === 'encourage' ? 'encourageStyleGrid' : 'reminderStyleGrid';
            const grid = document.getElementById(gridId);
            if (!grid) return;
            
            // 移除舊的自定义風格卡片（保留预設風格和"自定义"按钮）
            const customCards = grid.querySelectorAll('.style-option[data-style^="custom-"]:not([data-style="custom-encourage"]):not([data-style="custom-remind"])');
            customCards.forEach(card => card.remove());
            
            // 获取对應類型的自定义風格
            const customStylesOfType = Object.keys(customStyles.metadata || {})
                .filter(styleId => customStyles.metadata[styleId].type === type);
            
            // 為每個自定义風格創建卡片
            customStylesOfType.forEach(styleId => {
                const metadata = customStyles.metadata[styleId];
                const styleCard = createCustomStyleCard(styleId, metadata);
                
                // 插入到"自定义"按钮之前
                const customButton = grid.querySelector('[data-style="custom-' + type + '"]');
                if (customButton) {
                    grid.insertBefore(styleCard, customButton);
                }
            });
        }
        
        // 創建自定义風格卡片
        function createCustomStyleCard(styleId, metadata) {
            const styleCard = document.createElement('div');
            styleCard.className = 'style-option';
            styleCard.setAttribute('data-style', styleId);
            styleCard.onclick = (event) => handleStyleClick(event, styleId, metadata.type);
            
            styleCard.innerHTML = `
                <div class="style-title">${metadata.title}</div>
                <div class="style-desc">${metadata.desc}</div>
                <div class="style-selector-circle" onclick="event.stopPropagation(); handleStyleSelect(event, '${styleId}')"></div>
                <button class="custom-style-delete" onclick="event.stopPropagation(); deleteCustomStyle('${styleId}', '${metadata.type}')" title="刪除此自定义風格">
                    <svg class="w-3 h-3 text-red-500" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            `;
            
            return styleCard;
        }
        
        // 刪除自定义風格
        function deleteCustomStyle(styleId, type) {
            if (confirm('確定要刪除這個自定义風格嗎？此操作不可恢複。')) {
                // 从存儲中刪除
                if (customStyles.encourage && customStyles.encourage[styleId]) {
                    delete customStyles.encourage[styleId];
                }
                if (customStyles.remind && customStyles.remind[styleId]) {
                    delete customStyles.remind[styleId];
                }
                if (customStyles.metadata && customStyles.metadata[styleId]) {
                    delete customStyles.metadata[styleId];
                }
                
                // 从当前编辑的OC中移除该風格
                const currentOC = ocData[editingOCIndex >= 0 ? editingOCIndex : currentOCIndex];
                if (currentOC) {
                    if (type === 'encourage' && currentOC.encourageStyles) {
                        currentOC.encourageStyles = currentOC.encourageStyles.filter(s => s !== styleId);
                    } else if (type === 'remind' && currentOC.reminderStyles) {
                        currentOC.reminderStyles = currentOC.reminderStyles.filter(s => s !== styleId);
                    }
                }
                
                // 保存更改
                saveCustomStyles();
                
                // 重新渲染
                renderCustomStylesInGrid(type);
                
                // 如果当前正在编辑這個風格，關閉编辑器
                if (currentEditingStyle === styleId) {
                    closeStyleEditor();
                }
            }
        }
        
        function showStyleEditor(style, type, customTitle = '') {
            currentEditingStyle = style;
            currentEditingType = type;
            
            const modal = document.getElementById('styleEditorModal');
            const title = document.getElementById('styleEditorTitle');
            const desc = document.getElementById('styleEditorDesc');
            const textarea = document.getElementById('styleEditorTextarea');
            
            // 設置标題
            let styleTitle = customTitle || getStyleTitle(style);
            title.textContent = `编辑${styleTitle}語句`;
            
            // 設置描述
            if (type === 'encourage') {
                desc.textContent = '每行一條鼓励語句，{title} 會被替換為用戶称呼';
            } else {
                desc.textContent = '每行一條督促語句，分為三個級別：正常/烦恼/生氣';
            }
            
            // 加载当前語句
            let messages = [];
            if (type === 'encourage') {
                if (style.startsWith('custom-') && customStyles.encourage[style]) {
                    messages = [...customStyles.encourage[style]];
                } else if (ocMessageLibrary.encourage[style]) {
                    // 检查是否有自定义修改的版本
                    const modifiedKey = `modified-${style}`;
                    if (customStyles.encourage[modifiedKey]) {
                        messages = [...customStyles.encourage[modifiedKey]];
                    } else {
                        messages = [...ocMessageLibrary.encourage[style]];
                    }
                }
            } else {
                if (style.startsWith('custom-') && customStyles.remind[style]) {
                    // 自定义督促風格，顯示所有級別
                    messages = [
                        '=== 正常提醒 ===',
                        ...customStyles.remind[style].normal,
                        '',
                        '=== 烦恼提醒 ===',
                        ...customStyles.remind[style].annoyed,
                        '',
                        '=== 生氣提醒 ===',
                        ...customStyles.remind[style].angry
                    ];
                } else if (ocMessageLibrary.remind.normal[style]) {
                    // 检查是否有自定义修改的版本
                    const modifiedKey = `modified-${style}`;
                    if (customStyles.remind[modifiedKey]) {
                        messages = [
                            '=== 正常提醒 ===',
                            ...customStyles.remind[modifiedKey].normal,
                            '',
                            '=== 烦恼提醒 ===',
                            ...customStyles.remind[modifiedKey].annoyed,
                            '',
                            '=== 生氣提醒 ===',
                            ...customStyles.remind[modifiedKey].angry
                        ];
                    } else {
                        // 预設督促風格，顯示所有級別
                        messages = [
                            '=== 正常提醒 ===',
                            ...ocMessageLibrary.remind.normal[style],
                            '',
                            '=== 烦恼提醒 ===',
                            ...ocMessageLibrary.remind.annoyed[style],
                            '',
                            '=== 生氣提醒 ===',
                            ...ocMessageLibrary.remind.angry[style]
                        ];
                    }
                }
            }
            
            textarea.value = messages.join('\n');
            modal.classList.add('show');
        }
        
        function getStyleTitle(style) {
            // 首先检查是否是自定义風格
            if (customStyles.metadata && customStyles.metadata[style]) {
                return customStyles.metadata[style].title;
            }
            
            // 预設風格标題
            const styleTitles = {
                gentle: '温柔守護型',
                tsundere: '傲娇毒舌型',
                cheerful: '陽光開朗型',
                aloof: '淡漠深沉型',
                mature: '成熟包容型',
                cunning: '腹黑心机型',
                shy: '纯情害羞型',
                doting: '无腦溺愛型',
                guardian: '守護者',
                pusher: '鞭策者',
                cheerleader: '應援者',
                observer: '观察者',
                guide: '引導者',
                strategist: '布局者',
                companion: '陪伴者',
                believer: '溺愛者'
            };
            
            return styleTitles[style] || '自定义風格';
        }
        
        function closeStyleEditor() {
            document.getElementById('styleEditorModal').classList.remove('show');
        }
        
        function saveStyleMessages() {
            const textarea = document.getElementById('styleEditorTextarea');
            const messages = textarea.value.trim().split('\n').filter(line => line.trim());
            
            if (currentEditingType === 'encourage') {
                // 保存鼓励語句
                if (currentEditingStyle.startsWith('custom-')) {
                    // 自定义風格直接保存
                    customStyles.encourage[currentEditingStyle] = messages;
                } else {
                    // 预設風格保存為修改版本
                    const modifiedKey = `modified-${currentEditingStyle}`;
                    customStyles.encourage[modifiedKey] = messages;
                }
            } else {
                // 保存督促語句
                const normalMessages = [];
                const annoyedMessages = [];
                const angryMessages = [];
                
                let currentLevel = 'normal';
                messages.forEach(line => {
                    if (line.includes('=== 正常提醒 ===')) {
                        currentLevel = 'normal';
                    } else if (line.includes('=== 烦恼提醒 ===')) {
                        currentLevel = 'annoyed';
                    } else if (line.includes('=== 生氣提醒 ===')) {
                        currentLevel = 'angry';
                    } else if (line.trim()) {
                        if (currentLevel === 'normal') {
                            normalMessages.push(line);
                        } else if (currentLevel === 'annoyed') {
                            annoyedMessages.push(line);
                        } else {
                            angryMessages.push(line);
                        }
                    }
                });
                
                if (currentEditingStyle.startsWith('custom-')) {
                    // 自定义風格直接保存
                    customStyles.remind[currentEditingStyle] = {
                        normal: normalMessages,
                        annoyed: annoyedMessages,
                        angry: angryMessages
                    };
                } else {
                    // 预設風格保存為修改版本
                    const modifiedKey = `modified-${currentEditingStyle}`;
                    customStyles.remind[modifiedKey] = {
                        normal: normalMessages,
                        annoyed: annoyedMessages,
                        angry: angryMessages
                    };
                }
            }
            
            saveCustomStyles();
            closeStyleEditor();
            alert('語句已保存！修改将在專注頁面生效。');
        }
        
        function saveCustomStyles() {
            localStorage.setItem('customStyles', JSON.stringify(customStyles));
        }
        
        function loadCustomStyles() {
            const saved = localStorage.getItem('customStyles');
            if (saved) {
                try {
                    const loaded = JSON.parse(saved);
                    customStyles = {
                        encourage: loaded.encourage || {},
                        remind: loaded.remind || {},
                        metadata: loaded.metadata || {}
                    };
                } catch (e) {
                    console.log('Failed to parse custom styles');
                }
            }
        }

        // 統計數据管理
        function loadDailyStats() {
            const today = getCurrentDateString();
            const savedStats = localStorage.getItem('dailyStats_' + today);
            
            if (savedStats) {
                try {
                    dailyStats = JSON.parse(savedStats);
                } catch (e) {
                    console.log('Failed to parse daily stats');
                    dailyStats = {
                        date: today,
                        gifts: [],
                        focusTime: 0,
                        completedTasks: 0
                    };
                }
            } else {
                dailyStats = {
                    date: today,
                    gifts: [],
                    focusTime: 0,
                    completedTasks: 0
                };
            }
            
            updateStatsDisplay();
        }
        
        function saveDailyStats() {
            localStorage.setItem('dailyStats_' + dailyStats.date, JSON.stringify(dailyStats));
        }
        
        function updateStatsDisplay() {
            document.getElementById('todayGifts').textContent = dailyStats.gifts.length;
            document.getElementById('focusTime').textContent = formatTime(dailyStats.focusTime);
            document.getElementById('todayCompleted').textContent = dailyStats.completedTasks;
        }
        
        function addGift(giftText, senderOCIndex) {
            const now = new Date();
            const senderOC = ocData[senderOCIndex] || ocData[0];
            const gift = {
                text: giftText,
                time: now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }),
                timestamp: now.getTime(),
                senderName: senderOC.name,
                senderIndex: senderOCIndex
            };
            
            dailyStats.gifts.push(gift);
            saveDailyStats();
            updateStatsDisplay();
        }
        
        function addFocusTime(seconds) {
            dailyStats.focusTime += seconds;
            saveDailyStats();
            updateStatsDisplay();
        }
        
        function incrementCompletedTasks() {
            dailyStats.completedTasks++;
            saveDailyStats();
            updateStatsDisplay();
        }
        
        // 禮物弹窗
        function showGiftModal() {
            const modal = document.getElementById('giftModal');
            const giftList = document.getElementById('giftList');
            
            if (dailyStats.gifts.length === 0) {
                giftList.innerHTML = `
                    <div class="text-center text-slate-500 py-8">
                        <div class="text-4xl mb-2">🎁</div>
                        <p>今天還没有收到禮物呢～<br>完成番茄鐘就能获得夢角的禮物奖励！</p>
                    </div>
                `;
            } else {
                giftList.innerHTML = dailyStats.gifts.map(gift => `
                    <div class="gift-item">
                        <div class="flex-1">
                            <div class="text-sm text-slate-700 mb-1">${gift.text}</div>
                            <div class="gift-sender">来自 ${gift.senderName}</div>
                        </div>
                        <div class="gift-time">${gift.time}</div>
                    </div>
                `).join('');
            }
            
            modal.classList.add('show');
        }
        
        function closeGiftModal() {
            document.getElementById('giftModal').classList.remove('show');
        }
        
        // 已完成任務弹窗
        function showCompletedTasksModal() {
            const modal = document.getElementById('completedTasksModal');
            const completedTasksList = document.getElementById('completedTasksList');
            
            const completedTasks = tasks.filter(task => task.status === 'completed');
            
            if (completedTasks.length === 0) {
                completedTasksList.innerHTML = `
                    <div class="text-center text-slate-500 py-8">
                        <div class="text-4xl mb-2">📝</div>
                        <p>今天還没有完成任何任務呢～<br>快去完成一些任務吧！</p>
                    </div>
                `;
            } else {
                completedTasksList.innerHTML = completedTasks.map(task => `
                    <div class="completed-task-item">
                        <div class="w-5 h-5 bg-slate-400 rounded-full flex items-center justify-center flex-shrink-0">
                            <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                            </svg>
                        </div>
                        <div class="completed-task-title">${task.title}</div>
                        <button class="undo-btn" onclick="undoTaskCompletion(${task.id})">撤销</button>
                    </div>
                `).join('');
            }
            
            modal.classList.add('show');
        }
        
        function closeCompletedTasksModal() {
            document.getElementById('completedTasksModal').classList.remove('show');
        }
        
        function undoTaskCompletion(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.status = 'pending';
                if (dailyStats.completedTasks > 0) {
                    dailyStats.completedTasks--;
                    saveDailyStats();
                    updateStatsDisplay();
                }
                saveTasks();
                renderTasks();
                showCompletedTasksModal();
            }
        }

        // 任務管理函數
        function renderTasks() {
            const taskList = document.getElementById('taskList');
            if (!taskList) return;
            
            const uncompletedTasks = tasks.filter(task => task.status !== 'completed');
            
            taskList.innerHTML = '';
            
            uncompletedTasks.forEach((task, index) => {
                const taskItem = document.createElement('div');
                const displayStatus = 'in-progress';
                taskItem.className = `task-item ${displayStatus}`;
                taskItem.dataset.taskId = task.id;
                
                taskItem.innerHTML = `
                    <div class="flex items-center">
                        <div class="task-checkbox ${displayStatus}" onclick="toggleTaskStatus(${task.id})">
                        </div>
                        <div class="task-title">${task.title}</div>
                        <div class="task-actions">
                            <div class="task-action-btn task-edit-btn" onclick="event.stopPropagation(); editTask(${task.id})">
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                </svg>
                            </div>
                            <div class="task-action-btn task-delete-btn" onclick="event.stopPropagation(); deleteTask(${task.id})">
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                `;
                
                taskList.appendChild(taskItem);
            });
            
            updateTaskProgress();
            updateTaskSelector();
        }
        
        function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const newTitle = prompt('编辑任務內容：', task.title);
            if (newTitle && newTitle.trim() && newTitle.trim() !== task.title) {
                task.title = newTitle.trim();
                saveTasks();
                renderTasks();
            }
        }
        
        function deleteTask(taskId) {
            tasks = tasks.filter(t => t.id !== taskId);
            saveTasks();
            renderTasks();
        }
        
        function updateTaskSelector() {
            const taskSelector = document.getElementById('taskSelector');
            if (!taskSelector) return;
            
            taskSelector.innerHTML = '';
            
            const uncompletedTasks = tasks.filter(task => task.status !== 'completed');
            
            uncompletedTasks.forEach(task => {
                const taskOption = document.createElement('div');
                taskOption.className = 'task-option';
                const displayStatus = 'in-progress';
                taskOption.onclick = () => selectTask(task.title, getTaskStatusText(displayStatus), getTaskStatusColor(displayStatus));
                
                taskOption.innerHTML = `
                    <div class="flex items-center justify-between w-full">
                        <span>${task.title}</span>
                        <div class="w-4 h-4 border-2 border-blue-400 rounded-full flex items-center justify-center">
                        </div>
                    </div>
                `;
                
                taskSelector.appendChild(taskOption);
            });
        }
        
        function getTaskStatusText(status) {
            switch(status) {
                case 'completed': return '已完成';
                case 'in-progress': return '进行中';
                case 'pending': return '待開始';
                default: return '进行中';
            }
        }
        
        function getTaskStatusColor(status) {
            switch(status) {
                case 'completed': return 'slate';
                case 'in-progress': return 'blue';
                case 'pending': return 'blue';
                default: return 'blue';
            }
        }
        
        function addNewTask() {
            const taskList = document.getElementById('taskList');
            
            const inputContainer = document.createElement('div');
            inputContainer.className = 'mb-2';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'add-task-input';
            input.placeholder = '输入新任務內容...';
            input.autofocus = true;
            
            const handleAddTask = () => {
                const title = input.value.trim();
                if (title) {
                    const newTask = {
                        id: Date.now(),
                        title: title,
                        status: 'pending'
                    };
                    tasks.push(newTask);
                    saveTasks();
                    renderTasks();
                } else {
                    inputContainer.remove();
                }
            };
            
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleAddTask();
                }
            });
            
            input.addEventListener('blur', handleAddTask);
            
            inputContainer.appendChild(input);
            taskList.insertBefore(inputContainer, taskList.firstChild);
        }
        
        function toggleTaskStatus(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const wasCompleted = task.status === 'completed';
            
            if (task.status === 'completed') {
                task.status = 'pending';
            } else {
                task.status = 'completed';
                if (!wasCompleted) {
                    incrementCompletedTasks();
                }
            }
            
            saveTasks();
            renderTasks();
        }
        
        function updateTaskProgress() {
            const completed = tasks.filter(t => t.status === 'completed').length;
            const uncompleted = tasks.filter(t => t.status !== 'completed').length;
            const progressElement = document.getElementById('taskProgress');
            if (progressElement) {
                progressElement.textContent = `${completed}/${completed + uncompleted} 完成`;
            }
        }
        
        function saveTasks() {
            localStorage.setItem('tasks', JSON.stringify(tasks));
        }
        
        function loadTasks() {
            const savedTasks = localStorage.getItem('tasks');
            if (savedTasks) {
                try {
                    tasks = JSON.parse(savedTasks);
                } catch (e) {
                    console.log('Failed to parse saved tasks');
                }
            }
        }

        // 頁面切換函數
        function showPage(pageId) {
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => {
                if (page.id === pageId) {
                    page.classList.remove('hidden');
                    page.classList.add('show');
                } else {
                    page.classList.add('hidden');
                    page.classList.remove('show');
                }
            });
            currentPage = pageId.replace('Page', '');
            
            if (pageId === 'homePage') {
                setTimeout(renderTasks, 100);
            }
        }

        function goToFocus() {
    showPage('focusPage');
    isStatusSelected = false;
    currentStatus = { name: '', icon: '⚪' };
    resetOCInteraction();
    
    setTimeout(() => {
        // 使用優化的狀態文字設置
        const statusButton = document.getElementById('statusButton');
        statusButton.innerHTML = '<span class="oc-status-pure-text">狀態待選擇</span> <span class="oc-status-emoji">⚪</span>';
        
        const startBtnHint = document.getElementById('startBtnHint');
        startBtnHint.classList.add('hidden');
        
        stopHeartbeatAnimation();
        document.querySelectorAll('.status-option').forEach(option => {
            option.classList.remove('active');
        });
        
        // 初始化自定义狀態到專注頁
        initCustomStatusInFocusPage();
    }, 100);
}



        function goToOCCards() {
            showPage('ocCardsPage');
            renderOCCards();
        }

        function goBackToHome() {
            showPage('homePage');
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
                isTimerRunning = false;
                isPaused = false;
                
                if (focusStartTime) {
                    const focusedSeconds = Math.floor((Date.now() - focusStartTime) / 1000);
                    addFocusTime(focusedSeconds);
                    focusStartTime = null;
                }
                
                resetToSingleButton();
                enableModeSwitch();
                stopHeartbeatAnimation();
                stopEncourageLoop();
            }
            
            document.getElementById('statusSelector').classList.remove('show');
            document.getElementById('timeSelector').classList.remove('show');
            document.getElementById('taskSelector').classList.remove('show');
            
            // 重置狀態
            isStatusSelected = false;
            currentStatus = { name: '', icon: '⚪' };
            const statusButton = document.getElementById('statusButton');
            statusButton.innerHTML = '<span class="oc-status-pure-text">狀態待選擇</span> <span class="oc-status-emoji">⚪</span>';
            
            const startBtnHint = document.getElementById('startBtnHint');
            if (startBtnHint) {
                startBtnHint.classList.add('hidden');
            }
            
            resetOCInteraction();
        }

        function goBackHome() {
            goBackToHome();
        }

        function goBackToOCCards() {
            showPage('ocCardsPage');
        }

        // OC卡片相關函數
        function renderOCCards() {
            const grid = document.getElementById('ocCardsGrid');
            const createCard = grid.querySelector('.create-card');
            grid.innerHTML = '';
            grid.appendChild(createCard);
            
            ocData.forEach((oc, index) => {
                const card = document.createElement('div');
                card.className = 'oc-card';
                card.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <img src="${oc.avatar}" alt="${oc.name}" class="oc-card-avatar" onclick="editOC(${index})">
                        <div class="flex-1" onclick="editOC(${index})">
                            <h3 class="font-semibold text-slate-800 mb-1">${oc.name}</h3>
                            <p class="text-xs text-slate-500">你的學習搭子</p>
                        </div>
                        <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center cursor-pointer transition-all ${
                            oc.selected ? 'border-purple-500 bg-purple-500' : 'border-slate-300'
                        }" onclick="selectOC(${index})">
                            ${oc.selected ? '<svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' : ''}
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function selectOC(index) {
            ocData.forEach((oc, i) => {
                oc.selected = i === index;
            });
            
            currentOCIndex = index;
            updateCurrentOC(index);
            renderOCCards();
            
            localStorage.setItem('ocData', JSON.stringify(ocData));
            localStorage.setItem('currentOCIndex', index.toString());
        }

        function createNewOC() {
            editingOCIndex = -1;
            const newOC = {
                id: Date.now(),
                name: '新夢角',
                avatar: 'https://images.unsplash.com/photo-1494790108755-2616c359140b?w=200&h=200&fit=crop&crop=face',
                userTitle: '大小姐',
                customGreeting: '',
                encourageStyles: ['gentle'],
                reminderStyles: ['guardian'],
                customGifts: '',
                selected: false
            };
            
            document.getElementById('ocNameInput').value = newOC.name;
            document.getElementById('userTitleInput').value = newOC.userTitle;
            document.getElementById('customGreeting').value = newOC.customGreeting;
            document.getElementById('customGiftsInput').value = newOC.customGifts;
            document.getElementById('avatarPreview').src = newOC.avatar;
            
            // 重置風格選擇
            resetStyleSelections();
            selectStyleOptions('encourageStyleGrid', newOC.encourageStyles);
            selectStyleOptions('reminderStyleGrid', newOC.reminderStyles);
            
            showPage('ocSettingPage');
            
            // 渲染自定义風格和狀態禮物
            setTimeout(() => {
    renderCustomStylesInGrid('encourage');
    renderCustomStylesInGrid('remind');
    loadStatusGiftsFromStorage();
    // 只需要调用一次初始化，內部會處理事件綁定
    initializeStatusGiftPreviews();
}, 150);
        }

        function editOC(index) {
            editingOCIndex = index;
            const oc = ocData[index];
            
            document.getElementById('ocNameInput').value = oc.name;
            document.getElementById('userTitleInput').value = oc.userTitle;
            document.getElementById('customGreeting').value = oc.customGreeting || '';
            document.getElementById('customGiftsInput').value = oc.customGifts || '';
            document.getElementById('avatarPreview').src = oc.avatar;
            
            // 設置風格選擇
            resetStyleSelections();
            selectStyleOptions('encourageStyleGrid', oc.encourageStyles || ['gentle']);
            selectStyleOptions('reminderStyleGrid', oc.reminderStyles || ['guardian']);
            
            showPage('ocSettingPage');
            
            // 渲染自定义風格和狀態禮物
            setTimeout(() => {
    renderCustomStylesInGrid('encourage');
    renderCustomStylesInGrid('remind');
    loadStatusGiftsFromStorage();
    // 只需要调用一次初始化，內部會處理事件綁定
    initializeStatusGiftPreviews();
}, 150);
        }

        function resetStyleSelections() {
            document.querySelectorAll('.style-option').forEach(option => {
                option.classList.remove('selected');
            });
        }

        function selectStyleOptions(gridId, styles) {
            const grid = document.getElementById(gridId);
            if (!grid) return;
            
            styles.forEach(style => {
                const option = grid.querySelector(`[data-style="${style}"]`);
                if (option) {
                    option.classList.add('selected');
                }
            });
        }

        function getSelectedStyles(gridId) {
            const grid = document.getElementById(gridId);
            if (!grid) return [];
            
            const selectedOptions = grid.querySelectorAll('.style-option.selected');
            return Array.from(selectedOptions).map(option => option.dataset.style);
        }

        function uploadAvatar() {
            document.getElementById('avatarInput').click();
        }

        function previewAvatar(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('avatarPreview').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function saveOCSettings() {
            const ocSettings = {
                name: document.getElementById('ocNameInput').value.trim(),
                avatar: document.getElementById('avatarPreview').src,
                userTitle: document.getElementById('userTitleInput').value.trim(),
                customGreeting: document.getElementById('customGreeting').value.trim(),
                encourageStyles: getSelectedStyles('encourageStyleGrid'),
                reminderStyles: getSelectedStyles('reminderStyleGrid'),
                customGifts: document.getElementById('customGiftsInput').value.trim()
            };

            if (!ocSettings.name) {
                alert('请输入夢角名字');
                return;
            }

            if (ocSettings.encourageStyles.length === 0) {
                alert('请至少選擇一种鼓励風格');
                return;
            }

            if (ocSettings.reminderStyles.length === 0) {
                alert('请至少選擇一种督促風格');
                return;
            }

            if (editingOCIndex === -1) {
                ocSettings.id = Date.now();
                ocSettings.selected = false;
                ocData.push(ocSettings);
            } else {
                ocData[editingOCIndex] = { ...ocData[editingOCIndex], ...ocSettings };
            }

            localStorage.setItem('ocData', JSON.stringify(ocData));
            
            if (editingOCIndex === currentOCIndex || editingOCIndex === -1) {
                updateCurrentOC(editingOCIndex === -1 ? ocData.length - 1 : editingOCIndex);
            }

            const saveBtn = event.currentTarget;
            const originalContent = saveBtn.innerHTML;
            saveBtn.innerHTML = '<span class="text-green-500">已保存 ✓</span>';
            setTimeout(() => {
                saveBtn.innerHTML = originalContent;
                goBackToOCCards();
            }, 1000);
        }

        function deleteOC() {
            if (editingOCIndex === -1) return;
            
            if (ocData.length <= 1) {
                alert('至少需要保留一個夢角');
                return;
            }
            
            if (confirm('確定要刪除這個夢角嗎？此操作不可恢複。')) {
                ocData.splice(editingOCIndex, 1);
                
                if (editingOCIndex === currentOCIndex) {
                    ocData[0].selected = true;
                    updateCurrentOC(0);
                } else if (editingOCIndex < currentOCIndex) {
                    currentOCIndex--;
                }
                
                localStorage.setItem('ocData', JSON.stringify(ocData));
                
                goBackToOCCards();
            }
        }

        function updateCurrentOC(index) {
            currentOCIndex = index;
            const oc = ocData[index];
            
            document.getElementById('currentOCAvatar').src = oc.avatar;
            document.getElementById('currentOCName').textContent = oc.name;
            
            let greeting;
            if (oc.customGreeting && oc.customGreeting.trim()) {
                greeting = oc.customGreeting;
            } else {
                const hour = new Date().getHours();
                const title = oc.userTitle || '大小姐';
                if (hour < 12) {
                    greeting = `早安，${title}！`;
                } else if (hour < 18) {
                    greeting = `下午好，${title}！`;
                } else {
                    greeting = `晚上好，${title}！`;
                }
            }
            document.getElementById('currentOCGreeting').textContent = greeting;
            
            if (document.getElementById('focusOCAvatar')) {
                document.getElementById('focusOCAvatar').src = oc.avatar;
            }
            
            if (document.getElementById('ocMessageText') && currentPage === 'focus') {
                const ocMessageElement = document.getElementById('ocMessageText');
                if (ocMessageElement.textContent.includes('快開始學習吧') || currentMessageType === 'initial') {
                    ocMessageElement.innerHTML = `<span class="oc-message-text-wrapper">${getInitialMessage()}</span>`;
                }
            }
            
            localStorage.setItem('currentOCIndex', index.toString());
        }

        // 計時器相關函數
        function updateTimerDisplay() {
            const minutes = Math.floor(currentTime / 60);
            const seconds = currentTime % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('timerDisplay').textContent = display;
        }

        function switchMode(mode) {
            if (isTimerRunning) return;
            
            currentMode = mode;
            const pomodoroBtn = document.getElementById('pomodoroBtn');
            const timerBtn = document.getElementById('timerBtn');
            
            if (mode === 'pomodoro') {
                pomodoroBtn.classList.add('mode-active');
                pomodoroBtn.classList.remove('text-slate-600');
                timerBtn.classList.remove('mode-active');
                timerBtn.classList.add('text-slate-600');
                currentTime = selectedMinutes * 60;
                updateTimerDisplay();
            } else {
                timerBtn.classList.add('mode-active');
                timerBtn.classList.remove('text-slate-600');
                pomodoroBtn.classList.remove('mode-active');
                pomodoroBtn.classList.add('text-slate-600');
                currentTime = 0;
                updateTimerDisplay();
            }
        }

        function toggleTimeSelector() {
            if (isTimerRunning) return;
            
            const selector = document.getElementById('timeSelector');
            const isVisible = selector.classList.contains('show');
            
            if (isVisible) {
                selector.classList.remove('show');
            } else {
                selector.classList.add('show');
                document.getElementById('statusSelector').classList.remove('show');
                document.getElementById('taskSelector').classList.remove('show');
            }
        }

        function selectTime(minutes) {
            if (isTimerRunning) return;
            
            selectedMinutes = minutes;
            currentTime = minutes * 60;
            updateTimerDisplay();
            
            document.querySelectorAll('.time-option').forEach(option => {
                option.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            document.getElementById('timeSelector').classList.remove('show');
        }

        function handleCustomTimeEnter(event) {
            if (event.key === 'Enter') {
                selectCustomTime();
            }
        }

        function selectCustomTime() {
            if (isTimerRunning) return;
            
            const customInput = document.getElementById('customTimeInput');
            const customValue = parseInt(customInput.value);
            
            if (isNaN(customValue) || customValue < 1 || customValue > 120) {
                alert('请输入1-120之間的數值');
                customInput.focus();
                return;
            }
            
            selectedMinutes = customValue;
            currentTime = customValue * 60;
            updateTimerDisplay();
            
            document.querySelectorAll('.time-option').forEach(option => {
                option.classList.remove('active');
            });
            
            document.getElementById('timeSelector').classList.remove('show');
        }

        function showTaskSelector() {
            const selector = document.getElementById('taskSelector');
            const isVisible = selector.classList.contains('show');
            
            if (isVisible) {
                selector.classList.remove('show');
            } else {
                selector.classList.add('show');
                document.getElementById('statusSelector').classList.remove('show');
                document.getElementById('timeSelector').classList.remove('show');
            }
        }

        function selectTask(name, status, color) {
            currentTask = { name, status, color };
            
            document.getElementById('currentTaskName').textContent = name;
            const statusElement = document.getElementById('currentTaskStatus');
            statusElement.textContent = status;
            
            statusElement.className = 'text-xs px-2 py-1 rounded-full';
            if (color === 'slate') {
                statusElement.classList.add('text-slate-500', 'bg-slate-100');
            } else {
                statusElement.classList.add('text-blue-500', 'bg-blue-100');
            }
            
            document.querySelectorAll('.task-option').forEach(option => {
                option.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            document.getElementById('taskSelector').classList.remove('show');
        }

        function toggleStatusSelector() {
            const selector = document.getElementById('statusSelector');
            const isVisible = selector.classList.contains('show');
            
            if (isVisible) {
                selector.classList.remove('show');
            } else {
                selector.classList.add('show');
                document.getElementById('timeSelector').classList.remove('show');
                document.getElementById('taskSelector').classList.remove('show');
            }
        }

        function selectStatus(name, icon) {
            currentStatus = { name, icon };
            isStatusSelected = true;
            
            const startBtnHint = document.getElementById('startBtnHint');
            startBtnHint.classList.add('hidden');
            
            const currentOC = ocData[currentOCIndex];
            const ocName = currentOC.name;
            
            let statusText;
            if (name === '學習' || name === '工作') {
                statusText = `${ocName}專注${name}中`;
            } else {
                statusText = `${ocName}${name}中`;
            }
            
            // 使用優化的狀態文字設置
            const statusButton = document.getElementById('statusButton');
            statusButton.innerHTML = `<span class="oc-status-pure-text">${statusText}</span> <span class="oc-status-emoji">${icon}</span>`;
            
            document.querySelectorAll('.status-option').forEach(option => {
                option.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            document.getElementById('statusSelector').classList.remove('show');
            
            if (!isTimerRunning && !isIgnoring) {
                showOCMessage(getInitialMessage(), 'initial', true);
            }
        }
        
        function showCustomStatusInput() {
            const customInput = document.getElementById('customStatusInput');
            const statusGrid = document.querySelector('.status-grid');
            
            statusGrid.style.display = 'none';
            customInput.classList.remove('hidden');
            
            document.getElementById('customStatusText').focus();
        }
        
        function handleCustomStatusEnter(event) {
            if (event.key === 'Enter') {
                confirmCustomStatus();
            }
        }
        
        function confirmCustomStatus() {
            const customText = document.getElementById('customStatusText').value.trim();
            if (!customText) {
                alert('请输入狀態內容');
                return;
            }
            
            if (customText.length > 10) {
                alert('狀態內容不能超过10個字符');
                return;
            }
            
            selectCustomStatus(customText, '✨');
            hideCustomStatusInput();
        }
        
        function cancelCustomStatus() {
            hideCustomStatusInput();
        }
        
        function hideCustomStatusInput() {
            const customInput = document.getElementById('customStatusInput');
            const statusGrid = document.querySelector('.status-grid');
            
            statusGrid.style.display = 'grid';
            customInput.classList.add('hidden');
            
            document.getElementById('customStatusText').value = '';
        }
        
        function selectCustomStatus(name, icon) {
            currentStatus = { name, icon };
            isStatusSelected = true;
            
            const startBtnHint = document.getElementById('startBtnHint');
            startBtnHint.classList.add('hidden');
            
            const currentOC = ocData[currentOCIndex];
            const ocName = currentOC.name;
            const statusText = `${ocName}${name}中`;
            
            // 使用優化的狀態文字設置
            const statusButton = document.getElementById('statusButton');
            statusButton.innerHTML = `<span class="oc-status-pure-text">${statusText}</span> <span class="oc-status-emoji">${icon}</span>`;
            
            document.getElementById('statusSelector').classList.remove('show');
            
            if (!isTimerRunning && !isIgnoring) {
                showOCMessage(getInitialMessage(), 'initial', true);
            }
        }

        function startStopTimer() {
            // 尝試啟動背景音樂（解决浏覽器自動播放限制）
    if (currentMusicMode > 0 && !currentBackgroundMusic && isStatusSelected) {
        const musicType = currentMusicMode === 1 ? 'music' : 'rain';
        playBackgroundMusic(musicType);
    }
            if (!isStatusSelected) {
                const startBtnHint = document.getElementById('startBtnHint');
                startBtnHint.classList.remove('hidden');
                
                const startBtn = document.getElementById('startBtn');
                startBtn.classList.add('vibration');
                setTimeout(() => {
                    startBtn.classList.remove('vibration');
                }, 500);
                
                return;
            }
            
            if (!isTimerRunning) {
                isTimerRunning = true;
                isPaused = false;
                focusStartTime = Date.now();
                focusStartOCIndex = currentOCIndex;
                startHeartbeatAnimation();
                startEncourageLoop();
                
                document.getElementById('singleButtonLayout').classList.add('hidden');
                document.getElementById('threeButtonLayout').classList.remove('hidden');
                
                document.getElementById('pomodoroBtn').style.pointerEvents = 'none';
                document.getElementById('timerBtn').style.pointerEvents = 'none';
                document.getElementById('pomodoroBtn').style.opacity = '0.6';
                document.getElementById('timerBtn').style.opacity = '0.6';
                
                timerInterval = setInterval(() => {
                    if (currentMode === 'pomodoro') {
                        currentTime--;
                        if (currentTime <= 0) {
                            clearInterval(timerInterval);
                            isTimerRunning = false;
                            isPaused = false;
                            
                            if (focusStartTime) {
                                const focusedSeconds = selectedMinutes * 60;
                                addFocusTime(focusedSeconds);
                                focusStartTime = null;
                            }
                            
                            showPomodoroComplete();
                            enableModeSwitch();
                            resetToSingleButton();
                            stopHeartbeatAnimation();
                            stopEncourageLoop();
                            return;
                        }
                    } else {
                        currentTime++;
                    }
                    updateTimerDisplay();
                }, 1000);
            }
        }

        function pauseResumeTimer() {
    if (isTimerRunning) {
        clearInterval(timerInterval);
        isTimerRunning = false;
        isPaused = true;
        stopHeartbeatAnimation();
        stopEncourageLoop();
        // 修改：暂停背景音樂但保留进度
        pauseBackgroundMusic();
        
        if (focusStartTime) {
            const focusedSeconds = Math.floor((Date.now() - focusStartTime) / 1000);
            addFocusTime(focusedSeconds);
            focusStartTime = null;
        }
        
        showRestMessage();
        
        document.getElementById('pauseBtn').innerHTML = `
            <svg class="w-8 h-8" fill="white" viewBox="0 0 24 24">
                <path d="M8 5v14l11-7z"/>
            </svg>
        `;
        enableModeSwitch();
    } else if (isPaused) {
        isTimerRunning = true;
        isPaused = false;
        focusStartTime = Date.now();
        startHeartbeatAnimation();
        startEncourageLoop();
        // 新增：恢複背景音樂播放
        resumeBackgroundMusic();
        
        document.getElementById('pauseBtn').innerHTML = `
            <svg class="w-8 h-8" fill="white" viewBox="0 0 24 24">
                <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
            </svg>
        `;
        
        document.getElementById('pomodoroBtn').style.pointerEvents = 'none';
        document.getElementById('timerBtn').style.pointerEvents = 'none';
        document.getElementById('pomodoroBtn').style.opacity = '0.6';
        document.getElementById('timerBtn').style.opacity = '0.6';
        
        timerInterval = setInterval(() => {
            if (currentMode === 'pomodoro') {
                currentTime--;
                if (currentTime <= 0) {
                    clearInterval(timerInterval);
                    isTimerRunning = false;
                    isPaused = false;
                    
                    if (focusStartTime) {
                        const focusedSeconds = Math.floor((Date.now() - focusStartTime) / 1000);
                        addFocusTime(focusedSeconds);
                        focusStartTime = null;
                    }
                    
                    showPomodoroComplete();
                    enableModeSwitch();
                    resetToSingleButton();
                    stopHeartbeatAnimation();
                    stopEncourageLoop();
                    return;
                }
            } else {
                currentTime++;
            }
            updateTimerDisplay();
        }, 1000);
    }
}

function stopTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
        
        if (focusStartTime) {
            const focusedSeconds = Math.floor((Date.now() - focusStartTime) / 1000);
            addFocusTime(focusedSeconds);
            focusStartTime = null;
        }
    }
    isTimerRunning = false;
    isPaused = false;
    
    stopHeartbeatAnimation();
    stopEncourageLoop();
    // 修改：停止音樂并重置进度
    stopBackgroundMusic();
    
    if (currentMode === 'pomodoro') {
        currentTime = selectedMinutes * 60;
    } else {
        currentTime = 0;
    }
    updateTimerDisplay();
    
    resetToSingleButton();
    enableModeSwitch();
    
    if (!isIgnoring) {
        showOCMessage(getInitialMessage(), 'initial', true);
    }
}

        function resetToSingleButton() {
            document.getElementById('threeButtonLayout').classList.add('hidden');
            document.getElementById('singleButtonLayout').classList.remove('hidden');
            
            const startBtnHint = document.getElementById('startBtnHint');
            if (!isStatusSelected) {
                startBtnHint.classList.remove('hidden');
            } else {
                startBtnHint.classList.add('hidden');
            }
            
            document.getElementById('pauseBtn').innerHTML = `
                <svg class="w-8 h-8" fill="white" viewBox="0 0 24 24">
                    <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                </svg>
            `;
        }

        function startHeartbeatAnimation() {
            const leftPath = document.querySelector('.heartbeat-path-left');
            const rightPath = document.querySelector('.heartbeat-path-right');
            
            if (leftPath) leftPath.classList.remove('static');
            if (rightPath) rightPath.classList.remove('static');
        }

        function stopHeartbeatAnimation() {
            const leftPath = document.querySelector('.heartbeat-path-left');
            const rightPath = document.querySelector('.heartbeat-path-right');
            
            if (leftPath) leftPath.classList.add('static');
            if (rightPath) rightPath.classList.add('static');
        }

        function enableModeSwitch() {
            document.getElementById('pomodoroBtn').style.pointerEvents = 'auto';
            document.getElementById('timerBtn').style.pointerEvents = 'auto';
            document.getElementById('pomodoroBtn').style.opacity = '1';
            document.getElementById('timerBtn').style.opacity = '1';
        }

// 音频管理函數
function initAudio() {
    // 预加载完成音效
    completionAudio = new Audio(audioFiles.completion);
    completionAudio.preload = 'auto';
    completionAudio.volume = 0.7;
    
    // 错误處理
    completionAudio.addEventListener('error', function(e) {
        console.log('完成音效加载失败:', e);
    });
}

function playBackgroundMusic(type) {
    stopBackgroundMusic();
    
    if (!isMusicEnabled || type === 'mute') return;
    
    musicType = type; // 记錄当前音樂類型
    const audioUrl = type === 'music' ? audioFiles.music : audioFiles.rain;
    
    try {
        currentBackgroundMusic = new Audio(audioUrl);
        currentBackgroundMusic.loop = true;
        currentBackgroundMusic.volume = 0.3;
        
        // 設置播放进度
        if (musicPausedTime > 0) {
            currentBackgroundMusic.currentTime = musicPausedTime;
        }
        
        // 添加错误處理
        currentBackgroundMusic.addEventListener('error', function(e) {
            console.log('背景音樂加载失败:', e);
            currentBackgroundMusic = null;
        });
        
        // 添加加载完成處理
        currentBackgroundMusic.addEventListener('canplaythrough', function() {
            if (currentBackgroundMusic) {
                currentBackgroundMusic.play().catch(e => {
                    console.log('音樂播放失败，可能需要用戶交互:', e);
                });
            }
        });
        
    } catch (error) {
        console.log('創建音频对象失败:', error);
    }
}

function stopBackgroundMusic() {
    if (currentBackgroundMusic) {
        currentBackgroundMusic.pause();
        currentBackgroundMusic.currentTime = 0;
        currentBackgroundMusic = null;
    }
    musicPausedTime = 0; // 重置进度
}

function pauseBackgroundMusic() {
    if (currentBackgroundMusic) {
        musicPausedTime = currentBackgroundMusic.currentTime; // 保存当前播放进度
        currentBackgroundMusic.pause();
    }
}

function resumeBackgroundMusic() {
    if (musicType !== 'mute' && currentMusicMode > 0) {
        playBackgroundMusic(musicType);
    }
}

function stopCompletionSound() {
    if (completionAudio) {
        completionAudio.pause();
        completionAudio.currentTime = 0;
    }
}



function stopBackgroundMusic() {
    if (currentBackgroundMusic) {
        currentBackgroundMusic.pause();
        currentBackgroundMusic.currentTime = 0;
        currentBackgroundMusic = null;
    }
}

function playCompletionSound() {
    if (!isMusicEnabled || !completionAudio) return;
    
    try {
        completionAudio.currentTime = 0;
        completionAudio.play().catch(e => {
            console.log('完成音效播放失败:', e);
        });
    } catch (error) {
        console.log('播放完成音效時出错:', error);
    }
}


function toggleMusic() {
    currentMusicMode = (currentMusicMode + 1) % 3;
    const musicBtn = document.getElementById('musicBtn');
    const icon = musicIcons[currentMusicMode];
    
    // 更新按钮圖标
    musicBtn.innerHTML = `<span style="font-size: 28px;">${icon}</span>`;
    
    // 根据模式播放相應音樂
    switch(currentMusicMode) {
        case 0: // 静音
            stopBackgroundMusic();
            break;
        case 1: // 音樂
            playBackgroundMusic('music');
            break;
        case 2: // 雨声
            playBackgroundMusic('rain');
            break;
    }
}

        // 番茄鐘完成相關
        function showPomodoroComplete() {
            stopBackgroundMusic();
            playCompletionSound();
            const ocAvatar = document.querySelector('.oc-avatar');
            if (ocAvatar) {
                ocAvatar.classList.add('celebration');
                setTimeout(() => {
                    ocAvatar.classList.remove('celebration');
                }, 1000);
            }
            
            const gift = getRandomGift();
            const completionMessage = getRandomOCMessage('completion');
            const senderOC = ocData[focusStartOCIndex] || ocData[currentOCIndex];
            
            addGift(gift, focusStartOCIndex);
            
            createCelebrationParticles();
            
            showCompletionModal(completionMessage, senderOC.name, currentStatus.name, gift);
            
            currentTime = selectedMinutes * 60;
            updateTimerDisplay();
            if (!isIgnoring) {
                showOCMessage(getInitialMessage(), 'initial', true);
            }
        }

        function getRandomGift() {
            const senderOC = ocData[focusStartOCIndex] || ocData[currentOCIndex];
    
    // 優先使用狀態对應的禮物
    if (currentStatus.name && statusGifts[currentStatus.name] && statusGifts[currentStatus.name].length > 0) {
        const statusGiftList = statusGifts[currentStatus.name];
        return statusGiftList[Math.floor(Math.random() * statusGiftList.length)];
    }
    
    // 其次使用自定义禮物
    if (senderOC.customGifts && senderOC.customGifts.trim()) {
        const customGifts = senderOC.customGifts.trim().split('\n').filter(gift => gift.trim());
        if (customGifts.length > 0) {
            return customGifts[Math.floor(Math.random() * customGifts.length)].trim();
        }
    }
    
    // 最後使用默认禮物
    const defaultGifts = [
        '🎁 專屬定制奖杯！你是最棒的！',
        '⭐ 闪亮星星徽章！继续加油！',
        '💎 珍贵宝石！你的努力很珍贵！',
        '🏆 成就勋章！為你的坚持喝彩！',
        '🌟 光芒四射！你闪闪發光！'
    ];
    
    return defaultGifts[Math.floor(Math.random() * defaultGifts.length)];
}

        function createCelebrationParticles() {
            const particles = ['⭐', '💎', '🌟', '✨', '💫', '🔸', '🔹'];
            
            for (let i = 0; i < 12; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.className = 'celebration-particle';
                    particle.textContent = particles[Math.floor(Math.random() * particles.length)];
                    particle.style.left = Math.random() * window.innerWidth + 'px';
                    particle.style.animationDelay = Math.random() * 0.5 + 's';
                    particle.style.animationDuration = (Math.random() * 2 + 3) + 's';
                    document.body.appendChild(particle);
                    
                    setTimeout(() => {
                        if (particle.parentNode) {
                            particle.remove();
                        }
                    }, 4500);
                }, i * 150);
            }
        }

        function showCompletionModal(completionMessage, ocName, statusName, gift) {
    const modal = document.getElementById('completionModal');
    const titleElement = document.getElementById('completionTitle');
    const giftElement = document.getElementById('completionGift');
    
    titleElement.textContent = `🎉 ${completionMessage}`;
    // 修改：改變排版格式，添加換行
    giftElement.innerHTML = `${ocName}${statusName}结束啦，给你带回了<br>${gift}`;
    
    modal.classList.add('show');
}

        function closeCompletionModal() {
            document.getElementById('completionModal').classList.remove('show');
            stopCompletionSound();
        }




        // 飘落效果
        function createFallingElements() {
            const elements = ['🌸'];
            
            function createSingleElement() {
                const element = document.createElement('div');
                element.className = 'falling-petals';
                element.textContent = elements[Math.floor(Math.random() * elements.length)];
                element.style.left = Math.random() * window.innerWidth + 'px';
                element.style.animationDuration = (Math.random() * 3 + 4) + 's';
                element.style.animationDelay = Math.random() * 2 + 's';
                
                document.body.appendChild(element);
                
                setTimeout(() => {
                    if (element.parentNode) {
                        element.remove();
                    }
                }, 9000);
            }
            
            for (let i = 0; i < 3; i++) {
                setTimeout(createSingleElement, i * 1000);
            }
            
            setInterval(createSingleElement, 2000);
        }

        // 初始化和事件监聽
        function loadStoredData() {
            const storedOCData = localStorage.getItem('ocData');
            if (storedOCData) {
                try {
                    const loadedData = JSON.parse(storedOCData);
                    ocData = loadedData.map(oc => ({
                        ...oc,
                        customGifts: oc.customGifts || '',
                        encourageStyles: oc.encourageStyles || [oc.personality || 'gentle'],
                        reminderStyles: oc.reminderStyles || [oc.reminderStyle || 'guardian']
                    }));
                } catch (e) {
                    console.log('Failed to parse stored OC data');
                }
            }
            
            const storedOCIndex = localStorage.getItem('currentOCIndex');
            if (storedOCIndex && parseInt(storedOCIndex) < ocData.length) {
                currentOCIndex = parseInt(storedOCIndex);
            }
            
            updateCurrentOC(currentOCIndex);
            loadTasks();
            loadDailyStats();
            loadCustomStyles();
            loadStatusGiftsFromStorage();
            loadCustomStatusesFromStorage(); 
        }

        function initPageAnimation() {
            const cards = document.querySelectorAll('.glass-card');
            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    card.style.transition = 'all 0.6s ease';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 100 + 200);
            });
        }

        function updateCurrentDate() {
            const now = new Date();
            const weekdays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
            const dateStr = `${now.getFullYear()}年${(now.getMonth() + 1).toString().padStart(2, '0')}月${now.getDate().toString().padStart(2, '0')}日 ${weekdays[now.getDay()]}`;
            document.getElementById('currentDate').textContent = dateStr;
        }

        function initEventListeners() {
            document.getElementById('pomodoroBtn').addEventListener('click', () => switchMode('pomodoro'));
            document.getElementById('timerBtn').addEventListener('click', () => switchMode('timer'));
            
            document.addEventListener('click', function(e) {
                const statusSelector = document.getElementById('statusSelector');
                const statusButton = document.getElementById('statusButton');
                const timeSelector = document.getElementById('timeSelector');
                const timerDisplay = document.getElementById('timerDisplay');
                const taskSelector = document.getElementById('taskSelector');
                const taskContainer = document.querySelector('[onclick="showTaskSelector()"]');
                const giftModal = document.getElementById('giftModal');
                const completedTasksModal = document.getElementById('completedTasksModal');
                const completionModal = document.getElementById('completionModal');
                const styleEditorModal = document.getElementById('styleEditorModal');
                
                if (statusSelector && !statusSelector.contains(e.target) && 
                    e.target !== statusButton && !statusButton.contains(e.target)) {
                    statusSelector.classList.remove('show');
                    hideCustomStatusInput();
                }
                
                if (timeSelector && !timeSelector.contains(e.target) && 
                    e.target !== timerDisplay) {
                    timeSelector.classList.remove('show');
                }
                
                if (taskSelector && !taskSelector.contains(e.target) && 
                    taskContainer && !taskContainer.contains(e.target)) {
                    taskSelector.classList.remove('show');
                }
                
                if (giftModal && giftModal.classList.contains('show') && e.target === giftModal) {
                    closeGiftModal();
                }
                
                if (completedTasksModal && completedTasksModal.classList.contains('show') && e.target === completedTasksModal) {
                    closeCompletedTasksModal();
                }
                
                if (completionModal && completionModal.classList.contains('show') && e.target === completionModal) {
                    closeCompletionModal();
                }
                
                if (styleEditorModal && styleEditorModal.classList.contains('show') && e.target === styleEditorModal) {
                    closeStyleEditor();
                    const statusGiftEditorModal = document.getElementById('statusGiftEditorModal');
if (statusGiftEditorModal && statusGiftEditorModal.classList.contains('show') && e.target === statusGiftEditorModal) {
    closeStatusGiftEditor();
}
                }
            });
        }

        // 頁面初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadStoredData();
            updateCurrentDate();
            updateTimerDisplay();
            initAudio();
            
            const musicBtn = document.getElementById('musicBtn');
            if (musicBtn) {
                musicBtn.innerHTML = `
                    <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24">
                        <text x="12" y="16" text-anchor="middle" font-size="16">🔇</text>
                    </svg>
                `;
            }
            
            initEventListeners();
            createFallingElements();
            setTimeout(initPageAnimation, 100);
            renderTasks();
        });

        window.addEventListener('load', function() {
            initPageAnimation();
        });
    </script>

<script id="oc-phrases-and-cleanup">
(function(){
  try{
    var giftModal = document.getElementById('giftModal');
    if(giftModal) giftModal.remove();
    var giftsCardNum = document.getElementById('todayGifts');
    if(giftsCardNum && giftsCardNum.closest('.stat-clickable')) {
      var card = giftsCardNum.closest('.stat-clickable');
      if(card && card.parentElement){ card.parentElement.removeChild(card); }
    }
  }catch(e){}
  window.showGiftModal = function(){};
  window.closeGiftModal = function(){};

  function getTextarea(){ return document.querySelector('#styleEditorTextarea, .style-editor-textarea'); }
  function savePhraseLibrary(){
    var ta = getTextarea();
    if(!ta) return;
    localStorage.setItem('oc_phrases', ta.value || '');
    try{ alert('已保存台詞庫'); }catch(e){}
  }
  var editorSaveBtn = document.querySelector('.style-editor-save');
  if(editorSaveBtn){
    editorSaveBtn.addEventListener('click', function(){ setTimeout(savePhraseLibrary, 0); });
  }

  function pickPhrase(){
    var raw = (localStorage.getItem('oc_phrases')||'').split('
').map(function(s){return s.trim();}).filter(Boolean);
    return raw.length ? raw[Math.floor(Math.random()*raw.length)] : '';
  }

  function setOCMessageNeutral(text){
    var el = document.querySelector('.oc-message-text');
    if(!el) return;
    el.className = 'oc-message-text';
    el.textContent = (text && text.trim()) ? text.trim() : pickPhrase();
  }

  if(window.setOCMessage){
    window.setOCMessage = function(txt){ setOCMessageNeutral(txt); };
  } else {
    document.addEventListener('DOMContentLoaded', function(){ setOCMessageNeutral(); });
    setTimeout(function(){ setOCMessageNeutral(); }, 800);
  }

  ['click','visibilitychange'].forEach(function(ev){
    document.addEventListener(ev, function(){ setOCMessageNeutral(); }, {passive:true});
  });
})();
</script>

</body>
</html>
