<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å°ˆæ³¨ç•ªèŒ„é˜ Â· Demo</title>
<style>
  :root{
    --bg:#0f1220; --card:#171a2b; --text:#eef2ff; --sub:#aab1d6;
    --accent:#7c8cff; --accent-2:#36d399; --danger:#ff6b6b;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:radial-gradient(1200px 600px at 80% -10%, #1d2040 0%, #0f1220 60%), var(--bg);
    color:var(--text); font:16px/1.6 system-ui, -apple-system, "Segoe UI", "PingFang TC", "Noto Sans TC", sans-serif;
    display:flex; min-height:100vh; justify-content:center; align-items:flex-start; padding:24px;
  }
  .app{
    width:100%; max-width:960px; display:grid; gap:16px;
    grid-template-columns: 1.2fr 1fr; align-items:start;
  }
  @media (max-width:880px){ .app{ grid-template-columns:1fr } }
  .card{
    background:rgba(23,26,43,.75); backdrop-filter:saturate(140%) blur(8px);
    border:1px solid rgba(124,140,255,.2); border-radius:16px; padding:16px 18px;
    box-shadow:0 10px 30px rgba(0,0,0,.25);
  }
  h1,h2,h3{margin:0 0 10px}
  h1{font-size:20px}
  .timer{
    display:flex; flex-direction:column; gap:14px; align-items:center; text-align:center;
  }
  .time{
    font-size:72px; font-weight:800; letter-spacing:2px; line-height:1; padding:8px 16px;
  }
  .presets{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center }
  .chip{
    border:1px solid rgba(124,140,255,.35); color:var(--text); background:transparent;
    padding:8px 12px; border-radius:999px; cursor:pointer;
  }
  .chip.active{ background:var(--accent); border-color:transparent }
  .controls{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center }
  .btn{
    border:none; padding:12px 16px; border-radius:12px; cursor:pointer; font-weight:700;
  }
  .btn.primary{ background:var(--accent); color:#0b0f1a }
  .btn.ok{ background:var(--accent-2); color:#05251a }
  .btn.ghost{ background:transparent; border:1px solid rgba(124,140,255,.35); color:var(--text) }
  .btn.danger{ background:var(--danger); color:#381111 }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  input[type="text"], input[type="number"], select, textarea{
    background:#0c0f1d; color:var(--text); border:1px solid rgba(124,140,255,.35);
    border-radius:10px; padding:10px 12px; outline:none;
  }
  .stat{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; text-align:center }
  .badge{ background:#0c0f1d; border:1px solid rgba(124,140,255,.35); padding:10px; border-radius:12px }
  .section-title{ color:var(--sub); font-size:13px; letter-spacing:.5px; text-transform:uppercase; margin-top:4px }
  .list{ display:flex; flex-direction:column; gap:8px; margin-top:8px }
  .pill{
    display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
    border:1px dashed rgba(124,140,255,.35); color:var(--sub); font-size:13px;
  }
  .gift{ padding:10px; border-radius:12px; background:#101427; border:1px solid rgba(124,140,255,.25) }
  .muted{ color:var(--sub) }
  .avatar{
    width:64px; height:64px; border-radius:50%; background:linear-gradient(135deg,#7c8cff, #36d399);
    display:grid; place-items:center; font-weight:800; color:#0b0f1a; user-select:none;
  }
  .divider{ height:1px; background:rgba(124,140,255,.15); margin:8px 0 }
  a{ color:#9fb1ff }
</style>
</head>
<body>
  <main class="app">
    <!-- å·¦ï¼šç•ªèŒ„é˜ -->
    <section class="card">
      <h1>å°ˆæ³¨ç•ªèŒ„é˜</h1>
      <div class="timer" aria-live="polite">
        <div class="time" id="time">25:00</div>
        <div class="presets" role="group" aria-label="é è¨­æ™‚é•·">
          <button class="chip active" data-min="25">25 åˆ†é˜</button>
          <button class="chip" data-min="50">50 åˆ†é˜</button>
          <button class="chip" data-min="10">10 åˆ†é˜</button>
          <label class="chip" style="display:inline-flex;align-items:center;gap:6px;">
            è‡ªè¨‚ <input id="customMin" type="number" min="1" value="30" style="width:64px">
          </label>
          <button class="chip" id="applyCustom">å¥—ç”¨</button>
        </div>
        <div class="row" style="justify-content:center">
          <input id="taskTitle" type="text" placeholder="ç•¶å‰ä»»å‹™ï¼ˆä¾‹å¦‚ï¼šè¤‡ç¿’å–®å­—ï¼‰" aria-label="ç•¶å‰ä»»å‹™" />
          <select id="taskState" aria-label="ç‹€æ…‹">
            <option>å­¸ç¿’</option>
            <option>å·¥ä½œ</option>
            <option>ç·´ç¿’</option>
            <option>ä¼‘æ¯</option>
          </select>
        </div>
        <div class="controls">
          <button id="startBtn" class="btn primary">é–‹å§‹</button>
          <button id="pauseBtn" class="btn ghost" disabled>æš«åœ</button>
          <button id="resetBtn" class="btn danger">é‡ç½®</button>
          <button id="doneBtn" class="btn ok" disabled>å®Œæˆæ­¤æ®µ</button>
        </div>
        <div class="stat">
          <div class="badge"><div class="section-title">ä»Šæ—¥å®Œæˆ</div><div id="statPom">0</div></div>
          <div class="badge"><div class="section-title">å°ˆæ³¨åˆ†é˜</div><div id="statMin">0m</div></div>
          <div class="badge"><div class="section-title">ç¦®ç‰©</div><div id="statGift">0</div></div>
        </div>
        <div class="muted" id="tip">è¼¸å…¥ä»»å‹™åç¨±å¾Œé–‹å§‹å§ï¼</div>
      </div>
      <div class="divider"></div>
      <h3>ä»Šæ—¥å·²å®Œæˆ</h3>
      <div id="doneList" class="list muted">å°šæœªå®Œæˆä»»ä½•ä»»å‹™</div>
    </section>

    <!-- å³ï¼šè§’è‰² / çå‹µ / è¨­å®š -->
    <aside class="card">
      <div class="row" style="align-items:center;justify-content:space-between">
        <div class="row" style="align-items:center">
          <div class="avatar" aria-hidden="true">AI</div>
          <div style="margin-left:10px">
            <div id="greet" style="font-weight:700">æ—©å®‰ï¼</div>
            <div class="muted" id="roleLine">æˆ‘æœƒé™ªä½ ä¸€èµ·åº¦éå°ˆæ³¨çš„ä¸€å¤© âœ¨</div>
          </div>
        </div>
        <button id="swapTone" class="btn ghost" title="åˆ‡æ›é¼“å‹µèªæ°£">åˆ‡æ›èªæ°£</button>
      </div>

      <div class="divider"></div>
      <h3>ä»Šæ—¥ç¦®ç‰©</h3>
      <div id="giftList" class="list muted">
        é‚„æ²’æœ‰ç²å¾—ç¦®ç‰©ï¼Œå®Œæˆä¸€å€‹ç•ªèŒ„å°±æœƒé€ä½ éš¨æ©Ÿå°ç¦®ç‰©ï¼
      </div>

      <div class="divider"></div>
      <h3>è‡ªè¨‚ç¦®ç‰©æ± </h3>
      <div class="gift">
        <textarea id="giftPool" rows="4" style="width:100%;" placeholder="æ¯è¡Œä¸€å€‹ç¦®ç‰©ï¼Œä¾‹å¦‚ï¼šğŸ† å­¸ç¿’å† è»"></textarea>
        <div class="row" style="margin-top:8px;justify-content:flex-end">
          <button id="saveGifts" class="btn primary">ä¿å­˜ç¦®ç‰©æ± </button>
        </div>
        <div class="muted" style="margin-top:6px">æœªè¨­å®šæ™‚æœƒä½¿ç”¨é è¨­ç¦®ç‰©æ± ã€‚</div>
      </div>
    </aside>
  </main>

<script>
(() => {
  // ====== ç‹€æ…‹ ======
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  const el = {
    time: $("#time"),
    start: $("#startBtn"),
    pause: $("#pauseBtn"),
    reset: $("#resetBtn"),
    done: $("#doneBtn"),
    tip: $("#tip"),
    statPom: $("#statPom"),
    statMin: $("#statMin"),
    statGift: $("#statGift"),
    doneList: $("#doneList"),
    greet: $("#greet"),
    roleLine: $("#roleLine"),
    taskTitle: $("#taskTitle"),
    taskState: $("#taskState"),
    giftList: $("#giftList"),
    giftPool: $("#giftPool"),
    saveGifts: $("#saveGifts"),
    applyCustom: $("#applyCustom"),
    customMin: $("#customMin"),
  };

  const tones = [
    ["æ—©å®‰ï¼", "æˆ‘æœƒé»˜é»˜å®ˆè­·ä½ çš„å°ˆæ³¨æ™‚é–“ã€‚"],
    ["åŠ æ²¹ï¼", "ä½ çš„æ¯ä¸€åˆ†é˜éƒ½åœ¨ç´¯ç©å‹åˆ©ã€‚"],
    ["è¡å‘€ï¼", "æˆ‘åœ¨æ—é‚Šæ–æ——å¶å–Šï¼"],
    ["ç©©ä½ï½", "æ…¢æ…¢ä¾†ï¼Œæ¯”è¼ƒå¿«ã€‚"]
  ];
  let toneIdx = 0;

  function setTone(i){
    toneIdx = (i + tones.length) % tones.length;
    el.greet.textContent = tones[toneIdx][0];
    el.roleLine.textContent = tones[toneIdx][2] || tones[toneIdx][1];
  }
  setTone(0);
  $("#swapTone").addEventListener("click", ()=> setTone(toneIdx+1));

  // ä»Šæ—¥ keyï¼ˆä¾æ—¥æœŸæ­¸æª”ï¼‰
  const todayKey = () => {
    const d = new Date();
    const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,"0"), da = String(d.getDate()).padStart(2,"0");
    return `pomodoro:${y}-${m}-${da}`;
  };

  // åˆå§‹çµ±è¨ˆ
  const state = {
    running:false,
    targetMs: 25*60*1000,
    endAt: null, // Date.now() + remain
    remainMs: 25*60*1000,
    tickHandle: null,
    giftsClaimed:0,
    completed:[], // {title, state, minutes, at}
  };

  // è¼‰å…¥ localStorage
  function loadToday(){
    const raw = localStorage.getItem(todayKey());
    if(!raw) return;
    try{
      const data = JSON.parse(raw);
      state.giftsClaimed = data.giftsClaimed||0;
      state.completed = data.completed||[];
      renderStats(); renderDoneList(); renderGifts();
    }catch{}
  }
  function saveToday(){
    const data = {
      giftsClaimed: state.giftsClaimed,
      completed: state.completed
    };
    localStorage.setItem(todayKey(), JSON.stringify(data));
  }

  // ====== é¡¯ç¤º ======
  function renderTime(ms){
    ms = Math.max(0, ms|0);
    const m = Math.floor(ms/60000);
    const s = Math.floor((ms%60000)/1000);
    el.time.textContent = `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  }
  function renderStats(){
    const mins = state.completed.reduce((a,b)=>a+b.minutes,0);
    el.statPom.textContent = state.completed.length;
    el.statMin.textContent = `${mins}m`;
    el.statGift.textContent = state.giftsClaimed;
  }
  function renderDoneList(){
    if(state.completed.length===0){
      el.doneList.classList.add("muted");
      el.doneList.innerHTML = "å°šæœªå®Œæˆä»»ä½•ä»»å‹™";
      return;
    }
    el.doneList.classList.remove("muted");
    el.doneList.innerHTML = "";
    state.completed.slice().reverse().forEach(item=>{
      const div = document.createElement("div");
      div.className = "pill";
      div.textContent = `âœ” ${item.title||"æœªå‘½å"} Â· ${item.state} Â· ${item.minutes}m Â· ${new Date(item.at).toLocaleTimeString()}`;
      el.doneList.appendChild(div);
    });
  }
  function speakTip(txt){ el.tip.textContent = txt; }

  // ====== ç¦®ç‰©æ±  ======
  const defaultGifts = [
    "ğŸ† å­¸ç¿’å† è»", "ğŸ« èƒ½é‡å·§å…‹åŠ›", "ğŸ“š æ›¸ç±¤", "ğŸŒŸ å°å°æˆå°±æ˜Ÿ", "â˜• ä¸€æ¯å¥½å’–å•¡", "ğŸ§ éŸ³æ¨‚ç‰‡åˆ»", "ğŸ§© ä¼‘é–’æ‹¼åœ–",
  ];
  function getGiftPool(){
    const raw = localStorage.getItem("giftPool");
    if(!raw) return defaultGifts;
    const lines = raw.split("\n").map(s=>s.trim()).filter(Boolean);
    return lines.length? lines : defaultGifts;
  }
  function claimGift(){
    const pool = getGiftPool();
    const g = pool[Math.floor(Math.random()*pool.length)];
    state.giftsClaimed++;
    const item = document.createElement("div");
    item.className = "gift";
    item.textContent = `ğŸ æ­å–œï¼ä½ ç²å¾—äº†ã€Œ${g}ã€`;
    el.giftList.prepend(item);
    renderStats(); saveToday();
    // è¼•å¾®éœ‡å‹•ï¼ˆæ”¯æ´çš„è£ç½®ï¼‰
    if(navigator.vibrate) navigator.vibrate(50);
  }
  function renderGifts(){
    el.giftList.innerHTML = "";
    for(let i=0;i<state.giftsClaimed;i++){
      const div = document.createElement("div"); div.className="gift";
      div.textContent = "ğŸ å·²ç²å¾—ç¦®ç‰©";
      el.giftList.appendChild(div);
    }
    if(state.giftsClaimed===0){
      el.giftList.innerHTML = "é‚„æ²’æœ‰ç²å¾—ç¦®ç‰©ï¼Œå®Œæˆä¸€å€‹ç•ªèŒ„å°±æœƒé€ä½ éš¨æ©Ÿå°ç¦®ç‰©ï¼";
      el.giftList.classList.add("muted");
    }else{
      el.giftList.classList.remove("muted");
    }
  }
  el.saveGifts.addEventListener("click", ()=>{
    localStorage.setItem("giftPool", el.giftPool.value);
    speakTip("å·²ä¿å­˜è‡ªè¨‚ç¦®ç‰©æ± ");
  });

  // ====== è¨ˆæ™‚æ ¸å¿ƒï¼ˆæŠ—ç¯€æµï¼Œæ¡çµ•å°æ™‚é–“ï¼‰ ======
  function startTimer(){
    if(state.running) return;
    state.running = true;
    const now = Date.now();
    state.endAt = now + state.remainMs;

    el.start.disabled = true;
    el.pause.disabled = false;
    el.done.disabled = true;

    speakTip("å·²é–‹å§‹ï¼Œå°ˆæ³¨ç•¶ä¸‹ï¼");
    tick();
  }
  function pauseTimer(){
    if(!state.running) return;
    state.running = false;
    state.remainMs = Math.max(0, state.endAt - Date.now());
    el.start.disabled = false;
    el.pause.disabled = true;
    el.done.disabled = state.remainMs>0;
    speakTip("å·²æš«åœï¼Œéœ€è¦æ™‚å†ç¹¼çºŒã€‚");
    if(state.tickHandle) cancelAnimationFrame(state.tickHandle);
  }
  function resetTimer(){
    if(state.tickHandle) cancelAnimationFrame(state.tickHandle);
    state.running = false;
    state.remainMs = state.targetMs;
    state.endAt = null;
    renderTime(state.remainMs);
    el.start.disabled = false;
    el.pause.disabled = true;
    el.done.disabled = true;
    speakTip("å·²é‡ç½®ï¼Œæº–å‚™å¥½å°±é–‹å§‹ã€‚");
  }
  function finishSegment(){
    const spentMin = Math.round((state.targetMs)/60000);
    state.completed.push({
      title: el.taskTitle.value.trim() || "æœªå‘½åä»»å‹™",
      state: el.taskState.value,
      minutes: spentMin,
      at: Date.now()
    });
    renderStats(); renderDoneList(); saveToday();
    claimGift();
    resetTimer();
  }
  function tick(){
    const now = Date.now();
    const remain = state.endAt - now;
    state.remainMs = Math.max(0, remain);
    renderTime(state.remainMs);

    if(remain <= 0){
      // å®Œæˆä¸€æ®µ
      state.running = false;
      el.start.disabled = false;
      el.pause.disabled = true;
      el.done.disabled = false;
      speakTip("æ™‚é–“åˆ°ï¼æŒ‰ã€Œå®Œæˆæ­¤æ®µã€è¨˜éŒ„ä¸¦é ˜å–ç¦®ç‰©ã€‚");
      // ç°¡å–®æç¤ºéŸ³
      try{
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.type="sine"; o.frequency.value=880; o.connect(g); g.connect(ctx.destination);
        g.gain.setValueAtTime(0.0001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.01);
        o.start();
        o.stop(ctx.currentTime+0.2);
      }catch{}
      return;
    }
    state.tickHandle = requestAnimationFrame(tick);
  }

  // ====== äº‹ä»¶ ======
  el.start.addEventListener("click", startTimer);
  el.pause.addEventListener("click", pauseTimer);
  el.reset.addEventListener("click", resetTimer);
  el.done.addEventListener("click", finishSegment);

  $$(".chip").forEach(ch=>{
    ch.addEventListener("click", ()=>{
      $$(".chip").forEach(c=>c.classList.remove("active"));
      ch.classList.add("active");
      const min = parseInt(ch.dataset.min||el.customMin.value||25,10);
      state.targetMs = min*60*1000;
      state.remainMs = state.targetMs;
      renderTime(state.remainMs);
      speakTip(`å·²è¨­å®šç‚º ${min} åˆ†é˜`);
    });
  });
  el.applyCustom.addEventListener("click", ()=>{
    $$(".chip").forEach(c=>c.classList.remove("active"));
    el.applyCustom.classList.add("active");
    const min = Math.max(1, parseInt(el.customMin.value||"30",10));
    state.targetMs = min*60*1000;
    state.remainMs = state.targetMs;
    renderTime(state.remainMs);
    speakTip(`å·²å¥—ç”¨è‡ªè¨‚ ${min} åˆ†é˜`);
  });

  // åˆæ¬¡æ¸²æŸ“
  renderTime(state.remainMs);
  loadToday();

  // æ ¹æ“šæ™‚é–“å•å€™
  (function setGreeting(){
    const h = new Date().getHours();
    if(h < 11) el.greet.textContent = "æ—©å®‰ï¼";
    else if(h < 18) el.greet.textContent = "åˆå®‰ï¼";
    else el.greet.textContent = "æ™šå®‰ï¼";
  })();
})();
</script>
</body>
</html>
