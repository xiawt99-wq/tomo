<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>專注番茄鐘 · Demo</title>
<style>
  :root{
    --bg:#0f1220; --card:#171a2b; --text:#eef2ff; --sub:#aab1d6;
    --accent:#7c8cff; --accent-2:#36d399; --danger:#ff6b6b;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:radial-gradient(1200px 600px at 80% -10%, #1d2040 0%, #0f1220 60%), var(--bg);
    color:var(--text); font:16px/1.6 system-ui, -apple-system, "Segoe UI", "PingFang TC", "Noto Sans TC", sans-serif;
    display:flex; min-height:100vh; justify-content:center; align-items:flex-start; padding:24px;
  }
  .app{
    width:100%; max-width:960px; display:grid; gap:16px;
    grid-template-columns: 1.2fr 1fr; align-items:start;
  }
  @media (max-width:880px){ .app{ grid-template-columns:1fr } }
  .card{
    background:rgba(23,26,43,.75); backdrop-filter:saturate(140%) blur(8px);
    border:1px solid rgba(124,140,255,.2); border-radius:16px; padding:16px 18px;
    box-shadow:0 10px 30px rgba(0,0,0,.25);
  }
  h1,h2,h3{margin:0 0 10px}
  h1{font-size:20px}
  .timer{
    display:flex; flex-direction:column; gap:14px; align-items:center; text-align:center;
  }
  .time{
    font-size:72px; font-weight:800; letter-spacing:2px; line-height:1; padding:8px 16px;
  }
  .presets{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center }
  .chip{
    border:1px solid rgba(124,140,255,.35); color:var(--text); background:transparent;
    padding:8px 12px; border-radius:999px; cursor:pointer;
  }
  .chip.active{ background:var(--accent); border-color:transparent }
  .controls{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center }
  .btn{
    border:none; padding:12px 16px; border-radius:12px; cursor:pointer; font-weight:700;
  }
  .btn.primary{ background:var(--accent); color:#0b0f1a }
  .btn.ok{ background:var(--accent-2); color:#05251a }
  .btn.ghost{ background:transparent; border:1px solid rgba(124,140,255,.35); color:var(--text) }
  .btn.danger{ background:var(--danger); color:#381111 }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  input[type="text"], input[type="number"], select, textarea{
    background:#0c0f1d; color:var(--text); border:1px solid rgba(124,140,255,.35);
    border-radius:10px; padding:10px 12px; outline:none;
  }
  .stat{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; text-align:center }
  .badge{ background:#0c0f1d; border:1px solid rgba(124,140,255,.35); padding:10px; border-radius:12px }
  .section-title{ color:var(--sub); font-size:13px; letter-spacing:.5px; text-transform:uppercase; margin-top:4px }
  .list{ display:flex; flex-direction:column; gap:8px; margin-top:8px }
  .pill{
    display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
    border:1px dashed rgba(124,140,255,.35); color:var(--sub); font-size:13px;
  }
  .gift{ padding:10px; border-radius:12px; background:#101427; border:1px solid rgba(124,140,255,.25) }
  .muted{ color:var(--sub) }
  .avatar{
    width:64px; height:64px; border-radius:50%; background:linear-gradient(135deg,#7c8cff, #36d399);
    display:grid; place-items:center; font-weight:800; color:#0b0f1a; user-select:none;
  }
  .divider{ height:1px; background:rgba(124,140,255,.15); margin:8px 0 }
  a{ color:#9fb1ff }
</style>
</head>
<body>
  <main class="app">
    <!-- 左：番茄鐘 -->
    <section class="card">
      <h1>專注番茄鐘</h1>
      <div class="timer" aria-live="polite">
        <div class="time" id="time">25:00</div>
        <div class="presets" role="group" aria-label="預設時長">
          <button class="chip active" data-min="25">25 分鐘</button>
          <button class="chip" data-min="50">50 分鐘</button>
          <button class="chip" data-min="10">10 分鐘</button>
          <label class="chip" style="display:inline-flex;align-items:center;gap:6px;">
            自訂 <input id="customMin" type="number" min="1" value="30" style="width:64px">
          </label>
          <button class="chip" id="applyCustom">套用</button>
        </div>
        <div class="row" style="justify-content:center">
          <input id="taskTitle" type="text" placeholder="當前任務（例如：複習單字）" aria-label="當前任務" />
          <select id="taskState" aria-label="狀態">
            <option>學習</option>
            <option>工作</option>
            <option>練習</option>
            <option>休息</option>
          </select>
        </div>
        <div class="controls">
          <button id="startBtn" class="btn primary">開始</button>
          <button id="pauseBtn" class="btn ghost" disabled>暫停</button>
          <button id="resetBtn" class="btn danger">重置</button>
          <button id="doneBtn" class="btn ok" disabled>完成此段</button>
        </div>
        <div class="stat">
          <div class="badge"><div class="section-title">今日完成</div><div id="statPom">0</div></div>
          <div class="badge"><div class="section-title">專注分鐘</div><div id="statMin">0m</div></div>
          <div class="badge"><div class="section-title">禮物</div><div id="statGift">0</div></div>
        </div>
        <div class="muted" id="tip">輸入任務名稱後開始吧！</div>
      </div>
      <div class="divider"></div>
      <h3>今日已完成</h3>
      <div id="doneList" class="list muted">尚未完成任何任務</div>
    </section>

    <!-- 右：角色 / 獎勵 / 設定 -->
    <aside class="card">
      <div class="row" style="align-items:center;justify-content:space-between">
        <div class="row" style="align-items:center">
          <div class="avatar" aria-hidden="true">AI</div>
          <div style="margin-left:10px">
            <div id="greet" style="font-weight:700">早安！</div>
            <div class="muted" id="roleLine">我會陪你一起度過專注的一天 ✨</div>
          </div>
        </div>
        <button id="swapTone" class="btn ghost" title="切換鼓勵語氣">切換語氣</button>
      </div>

      <div class="divider"></div>
      <h3>今日禮物</h3>
      <div id="giftList" class="list muted">
        還沒有獲得禮物，完成一個番茄就會送你隨機小禮物！
      </div>

      <div class="divider"></div>
      <h3>自訂禮物池</h3>
      <div class="gift">
        <textarea id="giftPool" rows="4" style="width:100%;" placeholder="每行一個禮物，例如：🏆 學習冠軍"></textarea>
        <div class="row" style="margin-top:8px;justify-content:flex-end">
          <button id="saveGifts" class="btn primary">保存禮物池</button>
        </div>
        <div class="muted" style="margin-top:6px">未設定時會使用預設禮物池。</div>
      </div>
    </aside>
  </main>

<script>
(() => {
  // ====== 狀態 ======
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  const el = {
    time: $("#time"),
    start: $("#startBtn"),
    pause: $("#pauseBtn"),
    reset: $("#resetBtn"),
    done: $("#doneBtn"),
    tip: $("#tip"),
    statPom: $("#statPom"),
    statMin: $("#statMin"),
    statGift: $("#statGift"),
    doneList: $("#doneList"),
    greet: $("#greet"),
    roleLine: $("#roleLine"),
    taskTitle: $("#taskTitle"),
    taskState: $("#taskState"),
    giftList: $("#giftList"),
    giftPool: $("#giftPool"),
    saveGifts: $("#saveGifts"),
    applyCustom: $("#applyCustom"),
    customMin: $("#customMin"),
  };

  const tones = [
    ["早安！", "我會默默守護你的專注時間。"],
    ["加油！", "你的每一分鐘都在累積勝利。"],
    ["衝呀！", "我在旁邊搖旗吶喊！"],
    ["穩住～", "慢慢來，比較快。"]
  ];
  let toneIdx = 0;

  function setTone(i){
    toneIdx = (i + tones.length) % tones.length;
    el.greet.textContent = tones[toneIdx][0];
    el.roleLine.textContent = tones[toneIdx][2] || tones[toneIdx][1];
  }
  setTone(0);
  $("#swapTone").addEventListener("click", ()=> setTone(toneIdx+1));

  // 今日 key（依日期歸檔）
  const todayKey = () => {
    const d = new Date();
    const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,"0"), da = String(d.getDate()).padStart(2,"0");
    return `pomodoro:${y}-${m}-${da}`;
  };

  // 初始統計
  const state = {
    running:false,
    targetMs: 25*60*1000,
    endAt: null, // Date.now() + remain
    remainMs: 25*60*1000,
    tickHandle: null,
    giftsClaimed:0,
    completed:[], // {title, state, minutes, at}
  };

  // 載入 localStorage
  function loadToday(){
    const raw = localStorage.getItem(todayKey());
    if(!raw) return;
    try{
      const data = JSON.parse(raw);
      state.giftsClaimed = data.giftsClaimed||0;
      state.completed = data.completed||[];
      renderStats(); renderDoneList(); renderGifts();
    }catch{}
  }
  function saveToday(){
    const data = {
      giftsClaimed: state.giftsClaimed,
      completed: state.completed
    };
    localStorage.setItem(todayKey(), JSON.stringify(data));
  }

  // ====== 顯示 ======
  function renderTime(ms){
    ms = Math.max(0, ms|0);
    const m = Math.floor(ms/60000);
    const s = Math.floor((ms%60000)/1000);
    el.time.textContent = `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  }
  function renderStats(){
    const mins = state.completed.reduce((a,b)=>a+b.minutes,0);
    el.statPom.textContent = state.completed.length;
    el.statMin.textContent = `${mins}m`;
    el.statGift.textContent = state.giftsClaimed;
  }
  function renderDoneList(){
    if(state.completed.length===0){
      el.doneList.classList.add("muted");
      el.doneList.innerHTML = "尚未完成任何任務";
      return;
    }
    el.doneList.classList.remove("muted");
    el.doneList.innerHTML = "";
    state.completed.slice().reverse().forEach(item=>{
      const div = document.createElement("div");
      div.className = "pill";
      div.textContent = `✔ ${item.title||"未命名"} · ${item.state} · ${item.minutes}m · ${new Date(item.at).toLocaleTimeString()}`;
      el.doneList.appendChild(div);
    });
  }
  function speakTip(txt){ el.tip.textContent = txt; }

  // ====== 禮物池 ======
  const defaultGifts = [
    "🏆 學習冠軍", "🍫 能量巧克力", "📚 書籤", "🌟 小小成就星", "☕ 一杯好咖啡", "🎧 音樂片刻", "🧩 休閒拼圖",
  ];
  function getGiftPool(){
    const raw = localStorage.getItem("giftPool");
    if(!raw) return defaultGifts;
    const lines = raw.split("\n").map(s=>s.trim()).filter(Boolean);
    return lines.length? lines : defaultGifts;
  }
  function claimGift(){
    const pool = getGiftPool();
    const g = pool[Math.floor(Math.random()*pool.length)];
    state.giftsClaimed++;
    const item = document.createElement("div");
    item.className = "gift";
    item.textContent = `🎁 恭喜！你獲得了「${g}」`;
    el.giftList.prepend(item);
    renderStats(); saveToday();
    // 輕微震動（支援的裝置）
    if(navigator.vibrate) navigator.vibrate(50);
  }
  function renderGifts(){
    el.giftList.innerHTML = "";
    for(let i=0;i<state.giftsClaimed;i++){
      const div = document.createElement("div"); div.className="gift";
      div.textContent = "🎁 已獲得禮物";
      el.giftList.appendChild(div);
    }
    if(state.giftsClaimed===0){
      el.giftList.innerHTML = "還沒有獲得禮物，完成一個番茄就會送你隨機小禮物！";
      el.giftList.classList.add("muted");
    }else{
      el.giftList.classList.remove("muted");
    }
  }
  el.saveGifts.addEventListener("click", ()=>{
    localStorage.setItem("giftPool", el.giftPool.value);
    speakTip("已保存自訂禮物池");
  });

  // ====== 計時核心（抗節流，採絕對時間） ======
  function startTimer(){
    if(state.running) return;
    state.running = true;
    const now = Date.now();
    state.endAt = now + state.remainMs;

    el.start.disabled = true;
    el.pause.disabled = false;
    el.done.disabled = true;

    speakTip("已開始，專注當下！");
    tick();
  }
  function pauseTimer(){
    if(!state.running) return;
    state.running = false;
    state.remainMs = Math.max(0, state.endAt - Date.now());
    el.start.disabled = false;
    el.pause.disabled = true;
    el.done.disabled = state.remainMs>0;
    speakTip("已暫停，需要時再繼續。");
    if(state.tickHandle) cancelAnimationFrame(state.tickHandle);
  }
  function resetTimer(){
    if(state.tickHandle) cancelAnimationFrame(state.tickHandle);
    state.running = false;
    state.remainMs = state.targetMs;
    state.endAt = null;
    renderTime(state.remainMs);
    el.start.disabled = false;
    el.pause.disabled = true;
    el.done.disabled = true;
    speakTip("已重置，準備好就開始。");
  }
  function finishSegment(){
    const spentMin = Math.round((state.targetMs)/60000);
    state.completed.push({
      title: el.taskTitle.value.trim() || "未命名任務",
      state: el.taskState.value,
      minutes: spentMin,
      at: Date.now()
    });
    renderStats(); renderDoneList(); saveToday();
    claimGift();
    resetTimer();
  }
  function tick(){
    const now = Date.now();
    const remain = state.endAt - now;
    state.remainMs = Math.max(0, remain);
    renderTime(state.remainMs);

    if(remain <= 0){
      // 完成一段
      state.running = false;
      el.start.disabled = false;
      el.pause.disabled = true;
      el.done.disabled = false;
      speakTip("時間到！按「完成此段」記錄並領取禮物。");
      // 簡單提示音
      try{
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.type="sine"; o.frequency.value=880; o.connect(g); g.connect(ctx.destination);
        g.gain.setValueAtTime(0.0001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.01);
        o.start();
        o.stop(ctx.currentTime+0.2);
      }catch{}
      return;
    }
    state.tickHandle = requestAnimationFrame(tick);
  }

  // ====== 事件 ======
  el.start.addEventListener("click", startTimer);
  el.pause.addEventListener("click", pauseTimer);
  el.reset.addEventListener("click", resetTimer);
  el.done.addEventListener("click", finishSegment);

  $$(".chip").forEach(ch=>{
    ch.addEventListener("click", ()=>{
      $$(".chip").forEach(c=>c.classList.remove("active"));
      ch.classList.add("active");
      const min = parseInt(ch.dataset.min||el.customMin.value||25,10);
      state.targetMs = min*60*1000;
      state.remainMs = state.targetMs;
      renderTime(state.remainMs);
      speakTip(`已設定為 ${min} 分鐘`);
    });
  });
  el.applyCustom.addEventListener("click", ()=>{
    $$(".chip").forEach(c=>c.classList.remove("active"));
    el.applyCustom.classList.add("active");
    const min = Math.max(1, parseInt(el.customMin.value||"30",10));
    state.targetMs = min*60*1000;
    state.remainMs = state.targetMs;
    renderTime(state.remainMs);
    speakTip(`已套用自訂 ${min} 分鐘`);
  });

  // 初次渲染
  renderTime(state.remainMs);
  loadToday();

  // 根據時間問候
  (function setGreeting(){
    const h = new Date().getHours();
    if(h < 11) el.greet.textContent = "早安！";
    else if(h < 18) el.greet.textContent = "午安！";
    else el.greet.textContent = "晚安！";
  })();
})();
</script>
</body>
</html>
